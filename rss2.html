<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>程序员叨叨叨</title>
    <link>http://wjnovember.github.io/</link>
    <atom:link href="/rss2.html" rel="self" type="application/rss+xml"/>
    
    <description></description>
    <pubDate>Tue, 09 Nov 2021 16:23:22 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>游戏开发编码规范</title>
      <link>http://wjnovember.github.io/LuaCodeRule/</link>
      <guid>http://wjnovember.github.io/LuaCodeRule/</guid>
      <pubDate>Tue, 09 Nov 2021 15:31:52 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;最近梳理了下公司游戏开发的编码规范，考虑到平时开发主要以Lua语言为主，所以本文也以Lua代码作为案例，除了Lua语言自身的特性，其他规范思路其他语言亦可适用。&lt;br&gt;本文主要从命名规范、格式规范以及性能相关三个方面进行规范的说明，后续开发过程中若有新的规范制定，持续更新本
        
      
      </description>
      
      <content:encoded><![CDATA[<p>最近梳理了下公司游戏开发的编码规范，考虑到平时开发主要以Lua语言为主，所以本文也以Lua代码作为案例，除了Lua语言自身的特性，其他规范思路其他语言亦可适用。<br>本文主要从命名规范、格式规范以及性能相关三个方面进行规范的说明，后续开发过程中若有新的规范制定，持续更新本文内容。</p><h1 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h1><p>大规则：命名需做到“闻其名、知其意”，在不影响其表意的基础上精简命名长度。</p><h2 id="local变量命名"><a href="#local变量命名" class="headerlink" title="local变量命名"></a>local变量命名</h2><p>以“小驼峰命名法”作为命名规范，如：myKingdom、userInfo等。</p><p>若对视图层变量进行命名，可以“视图类型+表意”方式命名，可参考：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 确认按钮</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 描述文本</span></span><br><span class="line"><span class="keyword">local</span> lblDesc = V.createLabel()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 王国名称输入框</span></span><br><span class="line"><span class="keyword">local</span> editKingdomName = V.createInputBox()</span><br></pre></td></tr></table></figure><p>亦可以“表意+视图用处”方式命名，可参考：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 名字下方的背景图</span></span><br><span class="line"><span class="keyword">local</span> nameBg = lc.createSprite(<span class="string">"g_bg_01"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 资源区域</span></span><br><span class="line"><span class="keyword">local</span> resArea = lc.createNode(<span class="number">500</span>, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 奖励条目</span></span><br><span class="line"><span class="keyword">local</span> bonusItem = self:createItem(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天列表</span></span><br><span class="line"><span class="keyword">local</span> chatList = lcList.<span class="built_in">create</span>(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天面板</span></span><br><span class="line"><span class="keyword">local</span> chatPanel = ChatPanel.<span class="built_in">create</span>(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主要内容区域</span></span><br><span class="line"><span class="keyword">local</span> contentContainer = lc.createNode(...)</span><br></pre></td></tr></table></figure><p>为了和方法内局部变量做区分，全文件范围的local变量在上述规则基础上，以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"ChatForm"</span>, Form)</span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以下划线开始的文件范围局部变量的命名规范</span></span><br><span class="line"><span class="keyword">local</span> _animInterval = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _tabId = &#123;</span><br><span class="line">    world_chat = <span class="number">1</span>,</span><br><span class="line">    kingdom_chat = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:init</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="comment">-- 方法内局部变量命名，不以下划线开始</span></span><br><span class="line">    <span class="keyword">local</span> form = M.super.init(self, ...)</span><br><span class="line">    form:setTabId(_tabId.world_chat)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>table中的key，以小写字母+下划线命名，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">M.TabId = &#123;</span><br><span class="line">    world_chat    = <span class="number">1</span>,</span><br><span class="line">    kingdom_chat  = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有时为了简化书写、简化阅读，从成员变量中取视图变量，赋值给local变量的时候，命名可以简写为“视图用途”或“视图类型”，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- topArea简写为area</span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    area:setContentSize(...)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- btnAdd简写为btn</span></span><br><span class="line">    <span class="keyword">local</span> btn = area._btnAdd</span><br><span class="line">    btn:setLabel(...)</span><br><span class="line">    btn:setPosition(...)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 但是</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 当存在多个获取不同button的情况，建议使用全写（btnAdd、btnCancel）</span></span><br><span class="line">    <span class="comment">-- 因为相同命名时，代码位置调整可能导致逻辑错乱</span></span><br><span class="line">    <span class="keyword">local</span> btnAdd = area._btnAdd</span><br><span class="line">    btnAdd:setLabel(...)</span><br><span class="line">    btnAdd:setPosition(...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> btnCancel = area._btnCancel</span><br><span class="line">    btnCancel:setLabel(...)</span><br><span class="line">    btnCancel:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="成员变量命名"><a href="#成员变量命名" class="headerlink" title="成员变量命名"></a>成员变量命名</h2><p>lua中成员变量一般指存储在self里的变量，其命名规则为：在local变量命名规范基础上，以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> topArea = lc.createNode(...)</span><br><span class="line">lc.addChildToPos(self._form, topArea, lc.p(...))</span><br><span class="line"><span class="comment">-- 存储成员变量</span></span><br><span class="line">self._topArea = topArea</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton()</span><br><span class="line">lc.addChildToPos(topArea, btnConfirm, lc.p(...))</span><br><span class="line"><span class="comment">-- 存储成员变量</span></span><br><span class="line">self._btnConfirm = btnConfirm</span><br></pre></td></tr></table></figure><p>存在类里（比如：M类）的变量，其命名同样以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initDefines</span><span class="params">()</span></span></span><br><span class="line">    M._defs = &#123;...&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="方法命名"><a href="#方法命名" class="headerlink" title="方法命名"></a>方法命名</h2><p>方法的命名大小写规范，一般以小驼峰命名，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但是考虑到C#转Lua导致一些Unity内置方法名必须是大驼峰命名，为了保持一致，可以考虑项目中的所有方法以大驼峰方式命名，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"InfoPanel"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 内置方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Awake</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Start</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:OnEnable</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&lt;&lt;&lt;&lt;&lt; 自定义方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:UpdateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>方法命名格式，一般是“动词+名词”，可参考如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 创建某个组件或初始化某块区域，以create、init开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:createNode</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个按钮</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:createButton</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始化顶部区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 当这个方法里只要一个表示区域的变量，可以考虑简写，规则同“成员变量命名”的规则</span></span><br><span class="line">    <span class="comment">-- 比如这里局部变量写area，而非topArea</span></span><br><span class="line">    <span class="keyword">local</span> area = self:createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(...))</span><br><span class="line">    self._topArea = area</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnConfirm = self:createButton()</span><br><span class="line">    lc.addChildToPos(area, btnConfirm, lc.p(...))</span><br><span class="line">    area._btnConfirm = btnConfirm</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnCancel = self:createButton()</span><br><span class="line">    lc.addChildToPos(area, btnCancel, lc.p(...))</span><br><span class="line">    area._btnCancel = btnCancel</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以update开头作为视图刷新方法的开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新顶部的区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 更改、获取数值的方法分别以set、get开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置道具数量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:setItemNum</span><span class="params">(...)</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取道具数量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:getItemNum</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以is、can、should等作为返回布尔值的判断方法的开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断技能模块是否解锁</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:isUnlockSkill</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断玩家能否成为海盗</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:canBePirate</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断是否应该检查刷新该区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:shouldCheckUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以check作为开头，用于将判断方法和更新方法包起来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断并刷新顶部区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self:shouldCheckUpdateTopArea() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h1 id="格式规范"><a href="#格式规范" class="headerlink" title="格式规范"></a>格式规范</h1><p>如果把一个代码文件想象成一个房间，房间里的东西应该是近似强迫症一样地整齐摆放好，而不是像杂货堆，这是本小节规范格式需要达到的效果——“整齐、清爽、不杂糅”。对于不艰涩的逻辑，全篇代码甚至可以一行注释都不加就能读懂，类似这样：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"OptionForm"</span>, Form)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:init</span><span class="params">()</span></span></span><br><span class="line">    self:initTopArea()</span><br><span class="line">    self:initBottomArea()</span><br><span class="line"></span><br><span class="line">    self:syncData(V.SyncFlag.init)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">    self._topArea = area</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblName = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblName, lc.p(x2, y2))</span><br><span class="line">    area._lblName = lblName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblDesc = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblDesc, lc.p(x3, y3))</span><br><span class="line">    area._lblDesc = lblDesc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">    self._midArea = area</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">    area._lblOption = lblOption</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">    lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">    area._btnConfirm = btnConfirm</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">    lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">    area._btnCancel = btnCancel</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:syncData</span><span class="params">(flag)</span></span></span><br><span class="line">    M.super.syncData(self, flag)</span><br><span class="line">  </span><br><span class="line">    self:updateData()</span><br><span class="line">    self:updateTopArea()</span><br><span class="line">    self:updateBottomArea()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateData</span><span class="params">()</span></span></span><br><span class="line">    self._data = P:getOptionData()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> lblName = area._lblName</span><br><span class="line">    <span class="keyword">local</span> user = data._user</span><br><span class="line">    lblName:setString(user._name)</span><br><span class="line">    lblName:setTextColor(user._isNpc <span class="keyword">and</span> V.Color.gray <span class="keyword">or</span> V.Color.white)</span><br><span class="line">  </span><br><span class="line">    area._lblDesc:setString(data._desc)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateBottomArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> lblOption = self._bottomArea._lblOption</span><br><span class="line">    lblOption:setString(self._data._option)</span><br><span class="line">    lblOption:setPosition(x1, y1)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onEnter</span><span class="params">()</span></span></span><br><span class="line">    M.super.onEnter(self)</span><br><span class="line">  </span><br><span class="line">    self:addListener(Event.Player.name_change, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onPlayerNameChange(evt._param) <span class="keyword">end</span>)</span><br><span class="line">    self:addListener(Event.Option.dirty, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onOptionDirty(evt._param) <span class="keyword">end</span>)</span><br><span class="line">    self:addListener(Event.Option.<span class="built_in">remove</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:hide() <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onPlayerNameChange</span><span class="params">(user)</span></span></span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> data._user._id ~= user._id <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onOptionDirty</span><span class="params">(option)</span></span></span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> data._optionId ~= option._id <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:syncData(V.SyncFlag.update)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onBtnConfirm</span><span class="params">()</span></span></span><br><span class="line">    self._data._user:setConfirmOption()</span><br><span class="line">  self:hide()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onBtnCancel</span><span class="params">()</span></span></span><br><span class="line">    self._data._user:setDenyOption()</span><br><span class="line">    self:hide()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="空格规范"><a href="#空格规范" class="headerlink" title="空格规范"></a>空格规范</h2><p>逗号后面留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm, btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm,btnCancel</span><br></pre></td></tr></table></figure><p>运算符、等号两边留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> a = b &gt; c <span class="keyword">and</span> b <span class="keyword">or</span> (c - b) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> a=b&gt;c <span class="keyword">and</span> b <span class="keyword">or</span> (c-b)*<span class="number">2</span></span><br></pre></td></tr></table></figure><p>小括号内侧不留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> a = (b - c) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> a = ( b - c ) * <span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="条件、循环语句"><a href="#条件、循环语句" class="headerlink" title="条件、循环语句"></a>条件、循环语句</h3><p><code>if</code>语句块内侧，开始和结束不要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">if</span> data._id &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">if</span> data._id &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>if</code>语句块前留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> isVisible = (data._id &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line">lblName:setVisible(isVisible)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> isVisible = (data._id &gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line">lblName:setVisible(isVisible)</span><br><span class="line"><span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果<code>if</code>前面存在单独一行代码，且这行代码与判断逻辑本身存在密切关联，<code>if</code>前面可以不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line">self._lblDesc:setString(data._desc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>elseif</code>语句块前面留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>else</code>语句块是否留空行取决于前面的<code>if</code>或<code>elseif</code>。<br>如果前面是<code>elseif</code>，则<code>else</code>前面必留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    self._lblOtherName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    self._lblOtherName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面是<code>if</code>，且<code>if</code>语句块是多行，则<code>else</code>前面必留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line">    lblName:setTextColor(V.Color.gray)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    lblName:setTextColor(V.Color.white)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line">    lblName:setTextColor(V.Color.gray)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    lblName:setTextColor(V.Color.white)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面<code>if</code>语句块是单行，且<code>else</code>语句块也是单行，则<code>else</code>前面可以不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面<code>if</code>语句块是单行，但<code>else</code>语句块是多行，则<code>else</code>前面需要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    self._lblNpcDesc:setString(data._npcDesc)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    self._lblNpcDesc:setString(data._npcDesc)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>上面<code>else</code>留空行的规则可以简单理解为：只允许<code>if</code>和<code>else</code>里都只有一行代码时，可以不留空行，其他情况均需要留空行。</p><p><code>while</code>、<code>do ... while</code>、<code>for</code>循环语义块前面留空行规则与<code>if</code>相同。</p><h3 id="方法定义"><a href="#方法定义" class="headerlink" title="方法定义"></a>方法定义</h3><p>每个定义的方法之间需要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>方法定义内部，开始和结束不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> lblTitle = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblTitle, lc.p(x2, y2))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> lblTitle = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblTitle, lc.p(x2, y2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="视图的创建与刷新"><a href="#视图的创建与刷新" class="headerlink" title="视图的创建与刷新"></a>视图的创建与刷新</h3><p>不同组件的创建、刷新逻辑之间以空行分隔，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">self._midArea = area</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">area._btnCancel = btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例1</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">self._midArea = area</span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">area._btnCancel = btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例2</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line"></span><br><span class="line">self._midArea = area</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line">area._btnCancel = btnCancel</span><br></pre></td></tr></table></figure><p>上述代码，反例2虽然看起来也很整齐，但是一旦涉及相关代码删除，或是添加新的组件创建代码，就需要上下移动光标到指定位置修改3个地方代码，且我们没法保证所有的节点创建只有<code>create</code>、<code>lc.addChildToPos</code>和<code>self._xxx = xxx</code>三个部分，所有节点没法做到统一，为了方便维护，还是建议不同的组件以空行分开。</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>上述规则没有提及的部分，暂时没有硬性规定，但是在书写的过程中，还是需要我们凭借<strong>语感</strong>来判定是否需要用空行分开，何为语感：<br>就是当我写了一坨很厚的代码，review起来感觉有点费力时，用空行将其分开后，再看这坨代码，感觉舒服多了，这就是语感。</p><h2 id="合并行规范"><a href="#合并行规范" class="headerlink" title="合并行规范"></a>合并行规范</h2><h3 id="local变量声明"><a href="#local变量声明" class="headerlink" title="local变量声明"></a>local变量声明</h3><p>有时我们需要在一开始声明并赋值多个local变量，但是这些变量存在着一定关联，可以将多个变量合并为一行：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 多行声明local变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateActivity</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 分多行声明</span></span><br><span class="line">    <span class="keyword">local</span> btnActivity = self._btnActivity</span><br><span class="line">    <span class="keyword">local</span> btnWelfare = self._btnWelfare</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> isVisible = self:isVisible()</span><br><span class="line">    btnActivity:setVisible(isVisible)</span><br><span class="line">    btnWelfare:setVisible(isVisible)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 分多行声明</span></span><br><span class="line">    <span class="keyword">local</span> data = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> rawData = P._playerActivity:getData()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = rawData[i]</span><br><span class="line">        <span class="keyword">if</span> self:isValid() <span class="keyword">then</span></span><br><span class="line">            data[#data + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单行声明local变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateActivity</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 单行声明</span></span><br><span class="line">    <span class="keyword">local</span> btnActivity, btnWelfare = self._btnActivity, self._btnWelfare</span><br><span class="line">    <span class="keyword">local</span> isVisible = self:isVisible()</span><br><span class="line"></span><br><span class="line">    btnActivity:setVisible(isVisible)</span><br><span class="line">    btnWelfare:setVisible(isVisible)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 单行声明</span></span><br><span class="line">    <span class="keyword">local</span> data, rawData = &#123;&#125;, P._playerActivity:getData()</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = rawData[i]</span><br><span class="line">        <span class="keyword">if</span> self:isValid() <span class="keyword">then</span></span><br><span class="line">            data[#data + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h3><p>有时条件语句里面没有包含过多的逻辑代码，比如只有：<code>break</code>、<code>return</code>等，我们允许这些关键词和<code>if</code>条件判断放到同一行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    <span class="keyword">if</span> area == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> rawData = P:getRawData()</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但是当<code>if</code>条件后跟着<code>elseif</code>、<code>else</code>时，不建议将<code>break</code>等关键字写在同一行，这样会让代码结构看起来很难看，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data[#data + <span class="number">1</span>] = rawData[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例1</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 这样代码看起来排布太密，有点窒息的感觉</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span> data[#data + <span class="number">1</span>] = rawData[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例2</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 不建议一行代码里包含超过2个逻辑，且断点调试不太方便</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">else</span> data[#data + <span class="number">1</span>] = rawData[i] <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="缩进规范"><a href="#缩进规范" class="headerlink" title="缩进规范"></a>缩进规范</h2><p>大规则：所有的<code>Tab</code>由制表符改为4个空格。<br>VS Code里可设置，如下图：</p><p><img src="/LuaCodeRule/img_01.png" alt></p><p>之所以如此改，是考虑一份代码文件里，缩进有时用制表符，有时会用空格。而不同平台下，解析制表符得到的缩进和4个空格的缩进宽度是不一致的，所以干脆将<code>Tab</code>按键由制表符统一为4个空格。</p><p>基于此规则，下面提到的“缩进”表示“缩进4个空格”。</p><h3 id="长条件语句"><a href="#长条件语句" class="headerlink" title="长条件语句"></a>长条件语句</h3><p>我们经常会遇到<code>if</code>语句太长，超出一屏的情况，这时会考虑将if语句写成多行，而换行后的条件判断，建议以2个<strong>缩进</strong>书写，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单行if语句</span></span><br><span class="line"><span class="keyword">if</span> data._type ~= D.Type.world_chat <span class="keyword">and</span> data._type ~= D.Type.area_chat <span class="keyword">and</span> data._user._id ~= P._id <span class="keyword">and</span> data._content ~= <span class="string">""</span> <span class="keyword">then</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 改写成多行if语句</span></span><br><span class="line"><span class="keyword">if</span> data._type ~= D.Type.world_chat <span class="keyword">and</span> data._type ~= D.Type.area_chat</span><br><span class="line">        <span class="keyword">and</span> data._user._id ~= P._id <span class="keyword">and</span> data._content ~= <span class="string">""</span> <span class="keyword">then</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>两个缩进的好处是：明显与<code>if</code>语句里的逻辑代码区分开，很容易知晓这个缩进是<code>if</code>条件判断。</p><h3 id="方法作为参数传入"><a href="#方法作为参数传入" class="headerlink" title="方法作为参数传入"></a>方法作为参数传入</h3><p>比如按钮的创建封装，会经常把回调方法传进去，而调用这个封装方法时，会传入回调方法，可以有这么几种写法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按钮的创建封装方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">V.createButton</span><span class="params">(bgName, callback)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用这个封装方法，对于回调方法的传入，有诸多写法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考1：方法主体不做额外缩进</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> ...</span><br><span class="line"><span class="keyword">end</span>, btnW, btnH)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考2：方法主体缩进2个单位（8个空格）</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> ...</span><br><span class="line">        <span class="keyword">end</span>, btnW, btnH)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考3：function关键词换行缩进2个单位（8个空格），方法主体与function缩进齐平</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>,</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> ...</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        btnW,</span><br><span class="line">        btnH)</span><br></pre></td></tr></table></figure><p>其他代码逻辑走传统缩进规则即可。</p><h2 id="提前return代替嵌套"><a href="#提前return代替嵌套" class="headerlink" title="提前return代替嵌套"></a>提前return代替嵌套</h2><p>有时因为逻辑需要，会涉及到很多的if条件嵌套，针对这种情况，建议走<code>not</code>条件，提前return，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 嵌套写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> cond1() <span class="keyword">then</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> cond2() <span class="keyword">then</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> cond3() <span class="keyword">then</span></span><br><span class="line">                self:updateTopArea()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提前return写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond1() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond2() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond3() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这样的写法是不是更加优雅？</p><h1 id="性能相关"><a href="#性能相关" class="headerlink" title="性能相关"></a>性能相关</h1><p>性能优化是一款游戏上线后必做的事，但是性能瓶颈有很大程度是代码书写不规范导致的，因此有必要在这里提一提影响性能的代码书写。</p><h2 id="事件分发与接收"><a href="#事件分发与接收" class="headerlink" title="事件分发与接收"></a>事件分发与接收</h2><p>避免在循环中分发事件，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> params = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #data <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> info = data[i]</span><br><span class="line">    <span class="keyword">if</span> self:isValid(info) <span class="keyword">then</span></span><br><span class="line">        params[info._id] = info</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">lc.sendEvent(eventName, params)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> info = data[i]</span><br><span class="line">    <span class="keyword">if</span> cond() <span class="keyword">then</span></span><br><span class="line">        lc.sendEvent(eventName, info)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果可以预见有些事件会在同一帧分发多次，建议在收事件的地方用dirty延迟刷新代替立即刷新，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self._viewDirty = <span class="literal">true</span> <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> self._viewDirty <span class="keyword">then</span></span><br><span class="line">        self:updateView()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><p>事件接收的监听回调需要做好严格筛选、层层把关，防止出现不必要的刷新：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onEvent(evt._param) <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onEvent</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond1(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond2(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond3(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond4(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateView()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><p>逻辑筛选一般没有视图刷新来得复杂。</p><p>能做局部刷新，尽量不要全局刷新：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateView</span><span class="params">()</span></span></span><br><span class="line">    self:updateArea1()</span><br><span class="line">    self:updateArea2()</span><br><span class="line">    self:updateArea3()</span><br><span class="line">    self:updateArea4()</span><br><span class="line">    self:updateArea5()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    self:updateArea3()</span><br><span class="line">    self:updateArea5()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><h2 id="频繁调用的方法需要格外注意"><a href="#频繁调用的方法需要格外注意" class="headerlink" title="频繁调用的方法需要格外注意"></a>频繁调用的方法需要格外注意</h2><p>在定时器这类每帧都调用的回调方法中，避免做遍历逻辑，尤其是无效的遍历，如果实在无法规避遍历的坑，建议将数组遍历改为Map索引：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> target = map[targetId]</span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> target</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #array <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> array[i]._id == targetId <span class="keyword">then</span></span><br><span class="line">            target = array[i]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>避免在频繁调用的方法里做复杂的计算，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 之前做的一款2D游戏，客人消费后往地上扔银币</span></span><br><span class="line"><span class="comment">-- 客人可能会一次性扔3~10个银币</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在每帧都会调用的Update方法，在里面做模拟银币抛物线扔到地上的位置计算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Update</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> progress = ...</span><br><span class="line">    <span class="keyword">local</span> pos = Vector3.zero</span><br><span class="line">    pos.x = startPos + spdX * progress</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> progress &lt; <span class="number">0.3</span> <span class="keyword">then</span></span><br><span class="line">        pos.y = startY + progress * <span class="number">0.3</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.3</span> <span class="keyword">and</span> progress &lt; <span class="number">0.5</span> <span class="keyword">then</span></span><br><span class="line">        pos.y = startY + (progress - <span class="number">0.3</span>) * <span class="number">0.2</span> * factor1</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.5</span> <span class="keyword">and</span> progress &lt; <span class="number">0.7</span> <span class="keyword">then</span></span><br><span class="line">       pos.y = startY + (<span class="number">0.7</span> - progress) * <span class="number">0.2</span> * factor2</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.7</span> <span class="keyword">then</span></span><br><span class="line">       pos.y = startY + (<span class="number">1</span> - progress) * factor3</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    object.transform.localPosition = pos</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后，改成用Spine代替实时位置计算</span></span><br></pre></td></tr></table></figure><p>引入缓存机制，避免做重复且结果不变的计算：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> isSupport = Buff.getVal(buffId) &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> isSupport <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Buff.getVal</span><span class="params">(buffId)</span></span></span><br><span class="line">    <span class="keyword">if</span> cache[buffId] <span class="keyword">then</span> <span class="keyword">return</span> cache[buffId] <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    ...</span><br><span class="line">    cache[buffId] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例：没有缓存机制</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Buff.getVal</span><span class="params">(buffId)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="关于local变量和全局变量"><a href="#关于local变量和全局变量" class="headerlink" title="关于local变量和全局变量"></a>关于local变量和全局变量</h2><p>在Lua里，访问局部变量比访问全局变量的速度快，而Lua里全局变量使用较多的则是self变量以及全局类名。在平时的调用中，在一段代码块里，若出现使用self获取相同的变量超过2次（包含2次），建议将self变量先赋值给local变量，再调用，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> btnAct = self._btnAct</span><br><span class="line">    btnAct:setLabel(...)</span><br><span class="line">    btnAct:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    self._btnAct:setLabel(...)</span><br><span class="line">    self._btnAct:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果存在全局的类，调用多次，也建议先赋值给local变量，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WorldGrid是一个类，记录在全局变量里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> WorldGrid = WorldGrid</span><br><span class="line"><span class="keyword">local</span> grids = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    grids[#grids + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> grids = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    grids[#grids + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>尤其不要在循环中使用多重索引，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> WorldGrid = WorldGrid</span><br><span class="line"><span class="keyword">local</span> group = self._grids._group</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> gridData = WorldGrid.<span class="built_in">create</span>(rawData[i])</span><br><span class="line">    gridData._index = i</span><br><span class="line">    group[#group + <span class="number">1</span>] = gridData</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">  self._grids._group[#self._grids._group + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(self._rawData[i])</span><br><span class="line">  self._grids._group[#self._grids._group]._index = i</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>本文内容至此，若有不正确之处，欢迎评论区留言指正！</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/LuaCodeRule/#disqus_thread</comments>
    </item>
    
    <item>
      <title>《Unity Shader入门精要》笔记（一）</title>
      <link>http://wjnovember.github.io/UnityShadersBook01/</link>
      <guid>http://wjnovember.github.io/UnityShadersBook01/</guid>
      <pubDate>Sun, 07 Nov 2021 08:29:58 GMT</pubDate>
      <description>
      
        
        
          &lt;h1 id=&quot;渲染流水线&quot;&gt;&lt;a href=&quot;#渲染流水线&quot; class=&quot;headerlink&quot; title=&quot;渲染流水线&quot;&gt;&lt;/a&gt;渲染流水线&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;渲染流水线&lt;/strong&gt;的工作任务是：将三维场景里的物体投到屏幕上，生成一张二维图像。&lt;br&gt;可
        
      
      </description>
      
      <content:encoded><![CDATA[<h1 id="渲染流水线"><a href="#渲染流水线" class="headerlink" title="渲染流水线"></a>渲染流水线</h1><p><strong>渲染流水线</strong>的工作任务是：将三维场景里的物体投到屏幕上，生成一张二维图像。<br>可分为三个阶段：<strong>应用阶段</strong>、<strong>几何阶段</strong>、<strong>光栅化阶段</strong>。</p><p><img src="/UnityShadersBook01/img_01.png" alt></p><ul><li><p><strong>应用阶段</strong><br>CPU负责的阶段，应用主导，开发者有绝对的控制权，主要有三个任务：</p><ul><li>准备好场景数据</li><li>不可见物体剔除，提高渲染性能</li><li>设置好每个模型的渲染状态，如：材质、纹理、Shader等</li></ul><p>该阶段最重要的输出是<strong>渲染图元</strong>，如：点、线、三角面等，会被传递到下一个有GPU负责的阶段——几何阶段。</p></li><li><p><strong>几何阶段</strong><br>GPU负责的阶段，与每个渲染图元打交道，将三维空间的顶点数据转换到屏幕空间中，再将转换后的数据交给下一个阶段——光栅化阶段处理。关键词：<strong>逐顶点</strong>。</p></li><li><p><strong>光栅化阶段</strong><br>GPU负责的阶段，从上一阶段接过图元在屏幕空间的数据，差值计算后，决定图元里哪些像素会被绘制到屏幕中、被绘制成什么颜色。关键词：<strong>逐像素</strong>。</p></li></ul><h1 id="CPU和GPU之间的通信"><a href="#CPU和GPU之间的通信" class="headerlink" title="CPU和GPU之间的通信"></a>CPU和GPU之间的通信</h1><p>应用阶段的三个阶段：</p><ul><li><strong>把数据加载到显存</strong><br>数据加载到显存后，RAM的数据就可以移除了。但从硬盘加载到RAM过程十分耗时，CPU依然要访问数据，所以有些RAM中的数据不会马上移除。</li></ul><p><img src="/UnityShadersBook01/img_02.png" alt></p><ul><li><strong>设置渲染状态</strong><br>这些状态定义了场景中的网格是怎么被渲染的。</li></ul><p><img src="/UnityShadersBook01/img_03.png" alt></p><ul><li><strong>调用Draw Call</strong><br>Draw Call就是CPU发起命令，告诉GPU去执行一个渲染过程。一次DC（Draw Call）会指向本次调用需要渲染的图源列表。</li></ul><h1 id="GPU流水线"><a href="#GPU流水线" class="headerlink" title="GPU流水线"></a>GPU流水线</h1><p>GPU从CPU那里拿到顶点数据后，经过<strong>几何阶段</strong>和<strong>光栅化阶段</strong>将场景里的物体绘制到屏幕中。</p><p><img src="/UnityShadersBook01/img_04.png" alt></p><ul><li><strong>几何阶段</strong><ul><li>顶点着色器<br>完全可编程，实现顶点的空间变换、顶点着色等功能。</li><li>曲面细分着色器<br>可选的着色器，用于细分图元。</li><li>几何着色器<br>可选的着色器，执行逐图元的着色操作，或者生产更多的图元。</li><li>裁剪<br>将不存在摄像机视野内的顶点裁掉，并剔除某些三角图元的面片；也可以通过指令控制裁剪三角图元的正面或背面。</li><li>屏幕映射<br>不可配置、不可编程，负责把每个图元的坐标转换到屏幕坐标系中。</li></ul></li><li><strong>光栅化阶段</strong><ul><li>三角形设置<br>固定函数的阶段。</li><li>三角形遍历<br>固定函数的阶段。</li><li>片元着色器<br>完全可编程，实现逐片元的着色操作。</li><li>逐片元操作<br>不可编程，但可配置性很高，负责执行很多重要操作，如：修改颜色、深度缓冲、进行混合等。</li></ul></li></ul><p>我们需要重点关注的是<strong>顶点着色器（Vertex Shader）</strong>和<strong>片元着色器（Fragment Shader）</strong>。</p><h2 id="顶点着色器"><a href="#顶点着色器" class="headerlink" title="顶点着色器"></a>顶点着色器</h2><p>顶点着色器需要完成工作主要有：<strong>坐标转换</strong>和<strong>逐顶点光照</strong>。</p><p><img src="/UnityShadersBook01/img_05.png" alt></p><p>坐标转换，将模型的顶点坐标从模型空间转换到其次裁剪空间。</p><p><img src="/UnityShadersBook01/img_06.png" alt></p><p>需要注意：<br>OpenGL中NDC的z分量范围是[-1, 1]<br>DirectX中NDC的z分量范围是[0, 1]</p><p>NDC，全称Normalized Device Coordinates，归一化的设备坐标。（后续会详细了解）</p><h2 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h2><p>一个图元和摄像机视野的关系有3种：</p><ul><li>完全在视野范围内<br>不裁剪，直接进入下一流水线阶段。</li><li>部分在视野范围内<br>进行裁剪后，进入下一流水线阶段。</li><li>完全在视野范围外<br>被剔除，不会进入下一流水线阶段。</li></ul><p><img src="/UnityShadersBook01/img_07.png" alt></p><h2 id="屏幕映射"><a href="#屏幕映射" class="headerlink" title="屏幕映射"></a>屏幕映射</h2><p>屏幕映射前，顶点的坐标仍然在三维坐标系下，屏幕映射的任务是将每个图元的x、y坐标转换到屏幕坐标系下。<br>屏幕坐标系和z坐标一起构成了<strong>窗口坐标系</strong>。</p><p>屏幕坐标系在OpenGL和DirectX之间的差异：</p><p><img src="/UnityShadersBook01/img_08.png" alt></p><h2 id="三角形设置"><a href="#三角形设置" class="headerlink" title="三角形设置"></a>三角形设置</h2><p>光栅化的第一个流水线阶段。<br>光栅化两个最重要的目标：</p><ul><li>计算每个图元（一般是三角形面片）覆盖了哪些像素</li><li>为这些像素计算颜色</li></ul><p>三角形设置是一个计算三角形网格表示数据的过程，提供三角形边界的表示方式，为下阶段三角形遍历做准备。</p><h2 id="三角形遍历"><a href="#三角形遍历" class="headerlink" title="三角形遍历"></a>三角形遍历</h2><p>遍历判断每个像素是否被一个三角网格覆盖，若覆盖，则生成一个<strong>片元（fragment）</strong>，这个过程也叫扫描变换。片元的信息数据通过三个顶点差值得到。</p><h2 id="片元着色器"><a href="#片元着色器" class="headerlink" title="片元着色器"></a>片元着色器</h2><p>DirectX中也被称为<strong>像素着色器（Pixel Shader）</strong>。<br>片元着色器的输入是顶点着色器的输出差值得到的结果，片元着色器的输出是一个或多个颜色值。</p><p><img src="/UnityShadersBook01/img_09.png" alt></p><h2 id="逐片元操作"><a href="#逐片元操作" class="headerlink" title="逐片元操作"></a>逐片元操作</h2><p>OpenGL里称为<strong>逐片元操作</strong>，DirectX中称为<strong>输出合并阶段</strong>。这个阶段有几个主要任务：</p><ul><li>决定每个片元可见性，涉及：深度测试、模板测试等。</li><li>通过测试后的片元与颜色缓冲区的颜色进行合并/混合。</li></ul><p><img src="/UnityShadersBook01/img_10.png" alt></p><p>深度测试、模板测试的简化流程图：</p><p><img src="/UnityShadersBook01/img_11.png" alt></p><ul><li><p><strong>模板测试</strong><br>高度可配置。<br>模板缓冲，和颜色缓冲、深度缓冲几乎是一类东西。即当前像素读取的参考值和模板缓冲中读取的参考值进行比较，满足条件则通过模板测试，条件规则由开发者指定。<br>不管模板测试有没有通过，我们都可以根据模板测试和深度测试的结果来修改模板缓冲区，操作修改可由开发者指定。</p></li><li><p><strong>深度测试</strong><br>高度可配置。<br>与模板测试类似，将当前片元的深度值和深度缓冲区的深度值进行比较，比较函数可由开发者设置，通常这个比较函数是小于等于的关系，也就是显示距离相机更近的物体。<br>如果深度测试没有通过，它没有权利更改深度缓冲区中的值；如果通过了，开发者可以指定是否用这个片元的深度值盖掉缓冲区中的深度值——通过开启/关闭深度写入来控制。</p></li></ul><p><img src="/UnityShadersBook01/img_12.png" alt></p><ul><li><strong>混合</strong><br>高度可配置。<br>开发者可选择开启/关闭混合模式，来控制是直接覆盖，还是将源颜色（当前片元的颜色）和目标颜色（颜色缓冲区的颜色）进行混合后写入颜色缓冲区。</li></ul><p>有些GPU为了提高性能，将深度测试放到片元着色器之前处理，这种技术称为<strong>Early-Z技术</strong>。</p><p>经过上述流程，颜色缓冲区中的颜色值被显示到屏幕上，但是为了防止正在进行光栅化的图元被显示在屏幕上，GPU采取了 <strong>双重缓冲（Double Buffering）</strong> 的策略，所以对场景的渲染是发生在幕后的，即： <strong>后置缓冲（Back Buffer）</strong> 中。</p><h1 id="什么是Shader"><a href="#什么是Shader" class="headerlink" title="什么是Shader"></a>什么是Shader</h1><p>Shader本质就是运行在GPU流水线上的可高度编程的代码，主要有：<strong>顶点着色器（Vertex Shader）</strong>、<strong>片元着色器（Fragment Shader）</strong>，今后的开发学习中也主要是和这两个着色器打交道。</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/UnityShadersBook01/#disqus_thread</comments>
    </item>
    
    <item>
      <title>一文入门游戏中的引导设计</title>
      <link>http://wjnovember.github.io/guideSummary/</link>
      <guid>http://wjnovember.github.io/guideSummary/</guid>
      <pubDate>Mon, 01 Nov 2021 13:34:59 GMT</pubDate>
      <description>
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;一年多以前写了两篇从零开始设计游戏引导框架，第二篇写完后，发现写不下去了。游戏引擎形形色色，语言多种多样，如果继续写下去发现并不具有通用性，所以中断了。现在，引导的代码经过多个项目的打磨，有了一定的改进，想着简单分享一下引导的实现思路吧！&lt;br&gt;本
        
      
      </description>
      
      <content:encoded><![CDATA[<blockquote><p>一年多以前写了两篇从零开始设计游戏引导框架，第二篇写完后，发现写不下去了。游戏引擎形形色色，语言多种多样，如果继续写下去发现并不具有通用性，所以中断了。现在，引导的代码经过多个项目的打磨，有了一定的改进，想着简单分享一下引导的实现思路吧！<br>本文以Lua代码作为样例，重在思路分享，其他语言亦可实现。</p></blockquote><h1 id="1-引导认知"><a href="#1-引导认知" class="headerlink" title="1. 引导认知"></a>1. 引导认知</h1><h2 id="1-1-引导分类"><a href="#1-1-引导分类" class="headerlink" title="1.1 引导分类"></a>1.1 引导分类</h2><p>引导的分类可分为<strong>新手引导</strong>、<strong>触发式引导</strong>、<strong>任务前往引导</strong>。</p><h3 id="1）新手引导"><a href="#1）新手引导" class="headerlink" title="1）新手引导"></a>1）新手引导</h3><p>新注册的账号进入游戏后，出现立绘对话、交代游戏背景、告知玩家基础操作的引导，称为<strong>新手引导</strong>。一般新手引导持续至玩家可以自由操作时结束。</p><h3 id="2）触发式引导"><a href="#2）触发式引导" class="headerlink" title="2）触发式引导"></a>2）触发式引导</h3><p>玩家自由操作过程中，因达到某种条件而触发的引导，称为<strong>触发式引导</strong>。大多数情况下，触发式引导会随着新系统的开启。</p><h3 id="3）任务前往引导"><a href="#3）任务前往引导" class="headerlink" title="3）任务前往引导"></a>3）任务前往引导</h3><p>点击任务前往按钮后，出现手指引导玩家按照任务实现流程去操作的过程，称为<strong>任务前往引导</strong>。</p><h2 id="1-2-组别和步骤"><a href="#1-2-组别和步骤" class="headerlink" title="1.2 组别和步骤"></a>1.2 组别和步骤</h2><h3 id="1）组别"><a href="#1）组别" class="headerlink" title="1）组别"></a>1）组别</h3><p>为方便后续内容达成统一认知，在此将一个个不同功能作用的引导以组别进行区分。比如：一进入游戏即出现的新手引导、英雄升星引导、文字版的抽卡引导等，每一个引导特定功能的引导都是一个组别。</p><h3 id="2）步骤"><a href="#2）步骤" class="headerlink" title="2）步骤"></a>2）步骤</h3><p>在一个引导组别里，每一步引导的操作都成为<strong>步骤</strong>，比如：引导点击一个按钮、出现一个立绘对话、出现一个高亮框等，都是引导的步骤。</p><h2 id="1-3-触发条件与触发点"><a href="#1-3-触发条件与触发点" class="headerlink" title="1.3 触发条件与触发点"></a>1.3 触发条件与触发点</h2><p><strong>触发条件</strong>和<strong>触发点</strong>，是引导<strong>组别</strong>的概念。<br>举个例子，文字版里有一个抽卡引导，条件是玩家通关1-4。那么对于抽卡这个组别的引导，通关1-4就是它的触发条件，而触发点就是每一个关卡通关那一刻。通俗来讲就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">触发点：</span><br><span class="line">什么时候判断</span><br><span class="line"></span><br><span class="line">触发条件：</span><br><span class="line">判断是否满足条件</span><br></pre></td></tr></table></figure><h2 id="1-4-操作"><a href="#1-4-操作" class="headerlink" title="1.4 操作"></a>1.4 操作</h2><p><strong>操作</strong>是引导<strong>步骤</strong>的概念。<br>举个例子，文字版抽卡引导的步骤流程是：</p><ul><li>出现立绘对话，告知玩家“招仙台”系统已开启</li><li>点击主界面“道场”页签</li><li>点击“招仙台”按钮</li><li>提示免费单抽</li><li>点击“单抽”按钮</li></ul><p>上面的每一个步骤都是<strong>操作</strong>。</p><p>操作根据表现形式可分为如下几类：</p><ul><li>点击</li><li>拖动</li><li>立绘对话</li><li>提示文本</li><li>效果（高亮框等）</li></ul><h2 id="1-5-保存点"><a href="#1-5-保存点" class="headerlink" title="1.5 保存点"></a>1.5 保存点</h2><p><strong>保存点</strong>的作用：为保证引导在玩家中途退出重进时依然能从中断点恢复。保存点需要上传记录到服务端。</p><p>结合以上几点，我们建立起对引导的认知：<br>在某个 <strong><em>触发点</em></strong> ，判断某个 <strong><em>组别</em></strong> 的引导满足 <strong><em>触发条件</em></strong> ，于是一个 <strong><em>步骤</em></strong> 一个步骤地引导玩家去完成最基础的系统流程的 <strong><em>操作</em></strong> ，并且支持退出游戏重进时能从中途的 <strong><em>保存点</em></strong> 恢复并继续引导。</p><h1 id="2-引导的配表"><a href="#2-引导的配表" class="headerlink" title="2. 引导的配表"></a>2. 引导的配表</h1><p>引导的配表可分为：<strong>guide_group</strong>表、<strong>guide_step</strong>表、<strong>guide_text</strong>表。</p><h2 id="2-1-guide-group配表"><a href="#2-1-guide-group配表" class="headerlink" title="2.1 guide_group配表"></a>2.1 guide_group配表</h2><p>guide_group表，主要控制某个组别的引导要不要触发，具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">起始步骤</th><th align="left">触发条件</th><th align="center">优先级</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left">_stepId</td><td align="center">_triggerCond</td><td align="left">_priority</td><td align="center"></td></tr><tr><td align="center">I</td><td align="left"></td><td align="center">I</td><td align="left">[S</td><td align="center">I</td></tr><tr><td align="center">1</td><td align="left">初始的新手引导</td><td align="center"></td><td align="left">101</td><td align="center">0</td></tr><tr><td align="center">2</td><td align="left">抽卡引导</td><td align="center">201</td><td align="left">{“scene”:”MainScene”,”form”:””,”missionId”:100004}</td><td align="center">1</td></tr></tbody></table><h2 id="2-2-guide-step配表"><a href="#2-2-guide-step配表" class="headerlink" title="2.2 guide_step配表"></a>2.2 guide_step配表</h2><p>guide_step表，主要控制在某个组别的引导触发时，每一步操作具体是什么。相同组别引导的步骤ID连续，且ID不为100的倍数。具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">操作</th><th align="center">数值</th><th align="left">其他参数</th><th align="center">保存步骤</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_action</td><td align="center">_val</td><td align="left">_param</td><td align="center">_saveId</td></tr><tr><td align="center">H</td><td align="left"></td><td align="center">I</td><td align="center">I</td><td align="left">S</td><td align="center">I</td></tr><tr><td align="center">201</td><td align="left">立绘对话</td><td align="center">30001</td><td align="center">1002</td><td align="left"></td><td align="center">202</td></tr><tr><td align="center">202</td><td align="left">点击“道场”页签</td><td align="center">10001</td><td align="center">1</td><td align="left"></td><td align="center">0</td></tr><tr><td align="center">203</td><td align="left">点击“招仙台”按钮</td><td align="center">10002</td><td align="center">1</td><td align="left"></td><td align="center">0</td></tr><tr><td align="center">204</td><td align="left">提示免费单抽</td><td align="center">40001</td><td align="center">1002</td><td align="left">{“form_show”:105,”form”:105,”node”:”_btnLotteryOne”,”dir”:”top”}</td><td align="center">0</td></tr><tr><td align="center">205</td><td align="left">点击“单抽”按钮后关闭提示</td><td align="center">10003</td><td align="center">0</td><td align="left">{“form”:105,”node”:”_btnLotteryOne”}</td><td align="center">100</td></tr></tbody></table><p><strong>_action说明</strong>：</p><blockquote><p><strong>10000+</strong>：点击<br><strong>10001</strong> 点击主界面的页签 ，val 表示第几个页签<br><strong>10002</strong> 点击某个系统入口，val 表示哪个系统<br><strong>10003</strong> 按照代码变量名找到按钮进行点击</p><p><strong>20000+</strong>：拖拽<br>…</p><p><strong>30000+</strong>：立绘对话<br><strong>30001</strong> 普通立绘对话</p><p><strong>40000+</strong>：文本提示<br><strong>40001</strong> 普通文本提示</p></blockquote><p><strong>_val说明</strong>：</p><blockquote><p>不同_action，对应_val表意不同</p><p><strong>10001</strong> 主界面第几个页签<br><strong>10002</strong> 表示系统ID枚举</p><p><strong>30000+</strong> 表示立绘对话的文本ID，从guide_text表里读取<br><strong>40000+</strong> 表示文本提示的文本ID，从guide_text表里读取</p></blockquote><p><strong>_param说明</strong>：</p><blockquote><p>一些无法通过_val单个值表意的参数，用_param表意。使用Json字符串配置，扩展性较好，自由度大，可根据需求任意定义。</p><p><strong>form_show</strong> 某个界面打开的时候执行操作，数值为：界面ID枚举<br><strong>form</strong> 执行当前操作需要在哪个界面，数值为：界面ID枚举<br><strong>node</strong> 关联某个node，通常与form配合使用，旨在找到目标节点，与不同_action关联，表意不同，与点击            关联，表示点击哪个按钮；与提示文本关联，表示文本框依附于哪个UI控件<br><strong>dir</strong> 表示文本框依附在UI控件的哪个方位，数值可以是：”top”、”bottom”、”left”、”right”<br>…</p></blockquote><p><strong>_saveId说明</strong>：</p><blockquote><p>在当前操作结束时，将_saveId保存到服务器，下次断线重连时，从保存点继续引导</p><p><strong>0</strong> 不设置保存点，不做任何操作<br><strong>100</strong> 将当前引导保存点去掉，标记当前组别引导已完成<br><strong>其他</strong> 保存该步骤ID到服务器</p></blockquote><h2 id="2-3-guide-text表"><a href="#2-3-guide-text表" class="headerlink" title="2.3 guide_text表"></a>2.3 guide_text表</h2><p>guide_text表，主要配置立绘对话、文本提示等操作的一些文本内容。具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="left">文本内容</th><th align="left">参数</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="left">_textSid</td><td align="left">_param</td></tr><tr><td align="center">I</td><td align="left"></td><td align="left">D</td><td align="left">S</td></tr><tr><td align="center">1001</td><td align="left">立绘对话</td><td align="left">招仙台已开启，请道友移步入内，招募仙士。</td><td align="left">{“role_index”:1,”role_id”:1}</td></tr><tr><td align="center">1002</td><td align="left">文本提示</td><td align="left">每隔一段时间都会获得一次免费召唤机会</td><td align="left"></td></tr></tbody></table><p><strong>_param说明</strong>：</p><blockquote><p><strong>role_index</strong> 立绘的位置，1：左，2：中，3：右<br><strong>role_id</strong> 立绘角色ID</p></blockquote><h2 id="2-4-程序与策划的配合"><a href="#2-4-程序与策划的配合" class="headerlink" title="2.4 程序与策划的配合"></a>2.4 程序与策划的配合</h2><h3 id="1）添加新的引导时"><a href="#1）添加新的引导时" class="headerlink" title="1）添加新的引导时"></a>1）添加新的引导时</h3><p>策划出一份引导流程文档，程序根据负责添加引导的逻辑配表：guide_group、guide_step，策划配置负责配置引导的文案：guide_text。</p><h3 id="2）修改引导时"><a href="#2）修改引导时" class="headerlink" title="2）修改引导时"></a>2）修改引导时</h3><p>如果仅涉及引导文案修改时，策划只需要维护guide_text表即可，如果仅涉及文案增删，策划也可在了解引导配表逻辑的基础上，维护guide_step表；<br>如果涉及逻辑改动，需要程序配合策划进行改表，程序负责guide_group、guide_step，策划负责guide_text。</p><p>可有效规避策划和程序改一份表，影响引导逻辑。</p><h1 id="3-引导代码的实现"><a href="#3-引导代码的实现" class="headerlink" title="3. 引导代码的实现"></a>3. 引导代码的实现</h1><p>根据：</p><blockquote><p>在某个 <strong><em>触发点</em></strong> ，判断某个 <strong><em>组别</em></strong> 的引导满足 <strong><em>触发条件</em></strong> ，于是一个 <strong><em>步骤</em></strong> 一个步骤地引导玩家去完成最基础的系统流程的 <strong><em>操作</em></strong> ，并且支持退出游戏重进时能从中途的 <strong><em>保存点</em></strong> 恢复并继续引导。</p></blockquote><p>代码需要实现的逻辑包括：</p><ul><li>引导的触发</li><li>引导的操作</li><li>引导的保存点（结合在操作中）</li><li>引导步骤的连接（如何从当前步骤跳到下一步）</li></ul><p>我们把引导的框架逻辑写在<code>GuideMgr.lua</code>里。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.tryStart</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.start</span><span class="params">(groupConfig)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.finish</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideStep</span><span class="params">(stepId)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-1-引导的触发"><a href="#3-1-引导的触发" class="headerlink" title="3.1 引导的触发"></a>3.1 引导的触发</h2><p>引导的触发，可分为：触发总入口、触发条件判定和正式触发。</p><h3 id="1）触发总入口"><a href="#1）触发总入口" class="headerlink" title="1）触发总入口"></a>1）触发总入口</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 引导触发判定总入口</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.tryStart</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 引导禁用</span></span><br><span class="line">    <span class="keyword">if</span> M.isForbidGuide() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 正在引导，不触发判定</span></span><br><span class="line">    <span class="keyword">if</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 获取没有触发过的引导组别，判定是否满足触发条件</span></span><br><span class="line">    <span class="keyword">local</span> groupConfigs = M.getGroupConfigs()</span><br><span class="line">  <span class="keyword">for</span> i = <span class="number">1</span>, #groupConfigs <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">config</span> = groupConfigs[i]</span><br><span class="line">        <span class="comment">-- 如果满足触发条件</span></span><br><span class="line">    <span class="keyword">if</span> CondMgr.isConditionArrayMet(<span class="built_in">config</span>._triggerCond) <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 触发引导</span></span><br><span class="line">            M.start(<span class="built_in">config</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取没有触发过的引导组别</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.getGroupConfigs</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> configs = M._groupConfigs</span><br><span class="line">    <span class="keyword">if</span> configs == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        configs = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(D._guideGroupConfig) <span class="keyword">do</span></span><br><span class="line">      <span class="comment">-- 取没有触发过的引导组别</span></span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> M.isFinished(k) <span class="keyword">then</span></span><br><span class="line">                configs[#configs + <span class="number">1</span>] = v</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(configs, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a._priority &lt; b._priority <span class="keyword">end</span>)</span><br><span class="line">    M._groupConfigs = configs</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> configs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）条件判定"><a href="#2）条件判定" class="headerlink" title="2）条件判定"></a>2）条件判定</h3><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">起始步骤</th><th align="left">触发条件</th><th align="center">优先级</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_stepId</td><td align="left">_triggerCond</td><td align="center">_priority</td></tr><tr><td align="center">I</td><td align="left"></td><td align="center">I</td><td align="left">[S</td><td align="center">I</td></tr><tr><td align="center">2</td><td align="left">抽卡引导</td><td align="center">201</td><td align="left">{“scene”:”MainScene”,”form”:””,”missionId”:100004}</td><td align="center">1</td></tr></tbody></table><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"CondMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[--</span></span><br><span class="line"><span class="comment">配表类型：[S</span></span><br><span class="line"><span class="comment">配表写法：&#123;"form": 101, "hero_level": 20&#125; | &#123;"form":101, "vip_level":3&#125;</span></span><br><span class="line"><span class="comment">在101界面，英雄等级达到20级或vip等级达到3级，触发引导</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">cond参数结构：</span></span><br><span class="line"><span class="comment">table数组</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    &#123;form = 101, hero_level = 20&#125;,</span></span><br><span class="line"><span class="comment">    &#123;form = 101, vip_level = 3&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">只要数组中其中一个条件满足即可</span></span><br><span class="line"><span class="comment">--]]</span><span class="comment">--</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isConditionArrayMet</span><span class="params">(conds)</span></span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #conds <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> M.isConditionMet(conds[i]) <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isConditionMet</span><span class="params">(cond)</span></span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(cond) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> M.CondCheck[k](v) <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.CondCheck = &#123;</span><br><span class="line">    [<span class="string">"form"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">        <span class="keyword">return</span> form <span class="keyword">and</span> form._id == val</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [<span class="string">"hero_level"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">local</span> lv = P._playerHero:getOwnedHeroMaxLevel()</span><br><span class="line">        <span class="keyword">return</span> lv &gt;= val</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [<span class="string">"vip_level"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">return</span> P:vipLevel() &gt;= val</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="3）触发引导"><a href="#3）触发引导" class="headerlink" title="3）触发引导"></a>3）触发引导</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.start</span><span class="params">(groupConfig)</span></span></span><br><span class="line">    <span class="comment">-- 如果有引导正在进行，结束所有引导，开始触发传入组别的引导</span></span><br><span class="line">    M.finish()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 保存当前正在触发的引导组别ID</span></span><br><span class="line">    <span class="keyword">local</span> groupId = groupConfig._id</span><br><span class="line">    M.saveGuideGroup(groupId)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> stepId = groupConfig._stepId</span><br><span class="line">    M.saveGuideStep(stepId)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 引导视图层准备工作</span></span><br><span class="line">    M.prepareLayer()</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 开始当前引导组的第一步操作</span></span><br><span class="line">    M._groupId = groupId</span><br><span class="line">    M._stepId = stepId</span><br><span class="line">    M.step(stepId)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建引导图层，后续的所有操作添加的元素都放在这里</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.prepareLayer</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    <span class="keyword">if</span> layer == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        layer = class(<span class="literal">nil</span>, V).new(lc.CocosClass.ui_widget)</span><br><span class="line">        layer:setContentSize(lc.ScrSize)</span><br><span class="line">        lc.addChildToCenter(Scene._current, layer, V.ZOrder.guide)</span><br><span class="line">        M._layer = layer</span><br><span class="line"></span><br><span class="line">        layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideGroup</span><span class="params">(groupId)</span></span></span><br><span class="line">    <span class="comment">-- TODO：保存到服务端</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideStep</span><span class="params">(stepId)</span></span></span><br><span class="line">    <span class="comment">-- TODO：保存到服务端</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-2-引导的操作"><a href="#3-2-引导的操作" class="headerlink" title="3.2 引导的操作"></a>3.2 引导的操作</h2><p>引导的操作涉及：保存点逻辑、参数逻辑、具体操作（点击、对话等）。</p><h3 id="1）引导步骤"><a href="#1）引导步骤" class="headerlink" title="1）引导步骤"></a>1）引导步骤</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span></span><br><span class="line">    <span class="comment">-- 保证step在引导中执行（由M.start发起）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--[[--</span></span><br><span class="line"><span class="comment">    stepId不为空，表示开始当前步骤操作；</span></span><br><span class="line"><span class="comment">    stepId为空，表示在M._stepId基础上，进入下一步操作；</span></span><br><span class="line"><span class="comment">    --]]</span><span class="comment">--</span></span><br><span class="line">    <span class="keyword">if</span> stepId == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        stepId = M._stepId</span><br><span class="line"> </span><br><span class="line">        <span class="comment">-- 在当前步骤结束，准备进入下一步时，记录当前步骤的保存点</span></span><br><span class="line">        <span class="keyword">local</span> stepConfig = D._guideStepConfig[stepId]</span><br><span class="line">        <span class="keyword">local</span> saveId = stepConfig._saveId</span><br><span class="line">        <span class="keyword">if</span> saveId <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> saveId == <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">                M.setGroupFinished(M._groupId)</span><br><span class="line">                M.saveGuideStep()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elseif</span> saveId &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                M.saveGuideStep(saveId)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        stepId = stepId + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 传入的步骤ID不存在，结束引导</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[stepId]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span> == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        M.finish()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    M._stepId = stepId</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 清除所有引导元素</span></span><br><span class="line">    M.clearLayer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 根据步骤参数做相应处理</span></span><br><span class="line">    <span class="comment">-- （后面继续）</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isGuiding</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> M._stepId <span class="keyword">and</span> D._guideStepConfig[M._stepId]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清理所有layer上的引导元素，包括手指、高亮、立绘对话等</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.clearLayer</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    <span class="keyword">if</span> layer == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    layer:setSwallowTouches(<span class="literal">true</span>)</span><br><span class="line">    layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">    M.removeFinger()</span><br><span class="line">    M.removeDilog()</span><br><span class="line">    M.removeTipText()</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）参数处理"><a href="#2）参数处理" class="headerlink" title="2）参数处理"></a>2）参数处理</h3><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">操作</th><th align="center">数值</th><th align="left">其他参数</th><th align="center">保存步骤</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_action</td><td align="center">_val</td><td align="left">_param</td><td align="center">_saveId</td></tr><tr><td align="center">H</td><td align="left"></td><td align="center">I</td><td align="center">I</td><td align="left">S</td><td align="center">I</td></tr><tr><td align="center">204</td><td align="left"></td><td align="center">40001</td><td align="center">1002</td><td align="left">{“form_show”:105,”form”:105,”node”:”_btnLotteryOne”,”dir”:”top”}</td><td align="center">0</td></tr><tr><td align="center">205</td><td align="left"></td><td align="center">10003</td><td align="center">0</td><td align="left">{“form”:105,”node”:”_btnLotteryOne”}</td><td align="center">100</td></tr></tbody></table><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- （接上面的代码）</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[stepId]</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 根据步骤参数做相应处理</span></span><br><span class="line">    <span class="keyword">local</span> param = M.getStepParam(<span class="built_in">config</span>)</span><br><span class="line">    <span class="keyword">if</span> param <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 允许玩家自由点击</span></span><br><span class="line">        <span class="keyword">if</span> param.free_op <span class="keyword">then</span></span><br><span class="line">            M._layer:setSwallowTouches(<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        M._waitParam = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> param.delay <span class="keyword">then</span></span><br><span class="line">            M._waitParam = V.scheduleCall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> M.doAction() <span class="keyword">end</span>, param.delay)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> param.event <span class="keyword">then</span></span><br><span class="line">            _, M._waitParam = lc.event.once(param.event, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> M.doAction() <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> param.free_op <span class="keyword">then</span></span><br><span class="line">                M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">                    <span class="comment">-- 提示当前无法点击</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">elseif</span> param.form_show <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">            <span class="keyword">if</span> form == <span class="literal">nil</span> <span class="keyword">or</span> form._id ~= param.form_show <span class="keyword">or</span> <span class="keyword">not</span> form._isShown <span class="keyword">then</span></span><br><span class="line">                _, M._waitParam = lc.event.on(<span class="string">"form.show"</span>, <span class="function"><span class="keyword">function</span><span class="params">(form)</span></span></span><br><span class="line">                    <span class="keyword">if</span> form._id == param.form_show <span class="keyword">then</span> M.doAction() <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">elseif</span> param.form_close <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">            <span class="keyword">if</span> form <span class="keyword">and</span> form._id == param.form_close <span class="keyword">then</span></span><br><span class="line">                _, M._waitParam = lc.event.on(<span class="string">"form.close"</span>, <span class="function"><span class="keyword">function</span><span class="params">(formId)</span></span></span><br><span class="line">                    <span class="keyword">if</span> param.form_close == formId <span class="keyword">then</span> M.doAction() <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> M._waitParam == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            M.doAction()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.getStepParam</span><span class="params">(stepConfig)</span></span></span><br><span class="line">    stepConfig = stepConfig <span class="keyword">or</span> D._guideStepConfig[M._stepId]</span><br><span class="line">    <span class="keyword">return</span> json.decode(stepConfig._param <span class="keyword">or</span> <span class="string">""</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="3）执行操作"><a href="#3）执行操作" class="headerlink" title="3）执行操作"></a>3）执行操作</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.doAction</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[M._stepId]</span><br><span class="line">    M._waitParam = <span class="literal">nil</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    layer:setSwallowTouches(<span class="literal">true</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> action = <span class="built_in">config</span>._action</span><br><span class="line">    <span class="keyword">if</span> action == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 执行下一步操作</span></span><br><span class="line">        M.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> func = M.ActionFuncs[action]</span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> func(<span class="built_in">config</span>) <span class="keyword">then</span></span><br><span class="line">                M.finish()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">-- 交给外部处理</span></span><br><span class="line">            V.scheduleCall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> lc.event.emit(<span class="string">"guide.step"</span>, <span class="built_in">config</span>) <span class="keyword">end</span>, lc.FrameInterval)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.Action = &#123;</span><br><span class="line">    click_main_tab = <span class="number">10001</span>,</span><br><span class="line">    click_sys_entrance = <span class="number">10002</span>,</span><br><span class="line">    click_by_name = <span class="number">10003</span>,</span><br><span class="line">    ...</span><br><span class="line">    dialog = <span class="number">30001</span>,</span><br><span class="line">    ...</span><br><span class="line">    tip_text = <span class="number">40001</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">M.ActionFuncs = &#123;</span><br><span class="line">    [M.Action.click_main_tab] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> index = <span class="built_in">config</span>._val</span><br><span class="line">        <span class="keyword">local</span> tab = <span class="built_in">table</span>.walk(Scene._curent, <span class="string">"_tabs"</span>, index)</span><br><span class="line">        <span class="keyword">if</span> tab <span class="keyword">and</span> tab:isVisible() <span class="keyword">then</span></span><br><span class="line">            M.addTouchFinger(tab)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [M.Action.click_sys_entrance] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span> ... <span class="keyword">end</span>,</span><br><span class="line">    [M.Action.click_by_name] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span> ... <span class="keyword">end</span>,</span><br><span class="line">  </span><br><span class="line">    [M.Action.role_dialog] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> textConfig = D._guideTextConfig[<span class="built_in">config</span>._val]</span><br><span class="line">        M.addDialog(textConfig)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  </span><br><span class="line">    [M.Action.tip_text] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> textConfig = D._guideTextConfig[<span class="built_in">config</span>._val]</span><br><span class="line">        M.addTipText(textConfid._textSid, <span class="built_in">config</span>._param)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><p><strong>回顾</strong>：</p><blockquote><p><strong>10000+</strong>：点击<br><strong>10001</strong> 点击主界面的页签 ，val 表示第几个页签<br><strong>10002</strong> 点击某个系统入口，val 表示哪个系统<br><strong>10003</strong> 按照代码变量名找到按钮进行点击</p><p><strong>20000+</strong>：拖拽<br>…</p><p><strong>30000+</strong>：立绘对话<br><strong>30001</strong> 普通立绘对话</p><p><strong>40000+</strong>：文本提示<br><strong>40001</strong> 普通文本提示</p></blockquote><h2 id="3-3-引导的结束"><a href="#3-3-引导的结束" class="headerlink" title="3.3 引导的结束"></a>3.3 引导的结束</h2><p>引导的结束包括：引导数据处理、视图层移除、尝试继续触发下一组引导。所有逻辑囊括在GuideMgr.finish()方法里。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.finish</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 数据层</span></span><br><span class="line">    M.saveGuideGroup()</span><br><span class="line">    M.saveGuideStep()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> M._groupId <span class="keyword">then</span></span><br><span class="line">        M.setGroupFinished(M._groupId)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    M._groupId = <span class="number">0</span></span><br><span class="line">    M._stepId = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 视图层</span></span><br><span class="line">    M.clearLayer()</span><br><span class="line">    M.removeLayer()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> param = M._waitParam</span><br><span class="line">    <span class="keyword">if</span> param <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 移除事件监听</span></span><br><span class="line">        <span class="keyword">if</span> param._event <span class="keyword">then</span></span><br><span class="line">            lc.event.<span class="built_in">remove</span>(param)</span><br><span class="line">      </span><br><span class="line">        <span class="comment">-- 移除延迟操作的定时器</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">            param:unschedule()</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">        M._waitParam = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 延迟一帧判断是否有新的引导可以触发</span></span><br><span class="line">    V.scheduleCall(M.tryStart, lc.FrameInterval)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-4-步骤间的连接"><a href="#3-4-步骤间的连接" class="headerlink" title="3.4 步骤间的连接"></a>3.4 步骤间的连接</h2><p>步骤间的连接，也就是当前步骤如何跳到下一步骤，需要根据操作情景做特殊处理，这里以点击、立绘对话为例，做一下讲解。</p><h3 id="1）点击"><a href="#1）点击" class="headerlink" title="1）点击"></a>1）点击</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addTouchFinger</span><span class="params">(node, ...)</span></span></span><br><span class="line">    ...</span><br><span class="line">    node._lastListener = node._listener</span><br><span class="line">    node._listener = M.fingerTouchListener</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.fingerTouchListener</span><span class="params">(...)</span></span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> node._lastListener <span class="keyword">then</span></span><br><span class="line">        node._lastListener(...)</span><br><span class="line">        node._listener = node._lastListener</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 按钮点击后，执行下一步</span></span><br><span class="line">    M.step()</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）立绘对话、文本"><a href="#2）立绘对话、文本" class="headerlink" title="2）立绘对话、文本"></a>2）立绘对话、文本</h3><p>点击屏幕任意位置，执行下一步引导操作。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addDialog</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">-- 设置layer点击事件</span></span><br><span class="line">       M.step()</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addTipText</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">-- 设置layer点击事件</span></span><br><span class="line">      M.step()</span><br><span class="line">      ...</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/guideSummary/#disqus_thread</comments>
    </item>
    
    <item>
      <title>从零开始设计游戏引导框架（二）</title>
      <link>http://wjnovember.github.io/GuideMgr02/</link>
      <guid>http://wjnovember.github.io/GuideMgr02/</guid>
      <pubDate>Sun, 19 Apr 2020 05:11:50 GMT</pubDate>
      <description>
      
        
        
          &lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;p&gt;上文主要讲解了引导设计的一些理论概念，包括：引导分段、引导步骤、引导的触发、引导的操作以及引导的保存点。其中引导的触发分为触
        
      
      </description>
      
      <content:encoded><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>上文主要讲解了引导设计的一些理论概念，包括：引导分段、引导步骤、引导的触发、引导的操作以及引导的保存点。其中引导的触发分为触发点和触发条件，此外还提到了引导的多条件判断；引导操作提到了操作的分类、操作定义和操作参数及扩展。本文将基于引导的理论概念，进行实操演练，主要包含配表和代码框架的初步编写。</p><h1 id="配表"><a href="#配表" class="headerlink" title="配表"></a>配表</h1><p>考虑到引导的触发和操作逻辑模块的不同，引导相关的表将分成两张，一张是引导的<strong>触发表</strong>，另一张是引导的<strong>步骤表</strong>。考虑到xlsx在合分支时的不便，这里使用csv格式进行配表。我们对上述两张表分别命名为：</p><ul><li>GuideTrigger.csv 引导触发表</li><li>GuideStep.csv 引导步骤表</li></ul><p>因为不同的团队会有自己的配表习惯，所以这里的配表格式仅以笔者的习惯为例，读者们主要了解配表分哪几列，每列配表的数据结构如何即可。</p><h2 id="步骤表"><a href="#步骤表" class="headerlink" title="步骤表"></a>步骤表</h2><img src="/GuideMgr02/img_guide_step_01.png"><p>上图是基于前一篇文章里提到的卡牌卡牌进阶引导进行了基本的配表操作，接下来对每一列的配置作详细说明。</p><h3 id="ID"><a href="#ID" class="headerlink" title="ID"></a>ID</h3><p>ID表示引导步骤的唯一标识，为数字类型，通常同一段引导里的步骤ID以连续的数字相连。上图中展示的是卡牌进阶引导的所有步骤，一共分为8步。</p><p>步骤表是要配置当前游戏所有的引导步骤的，那么不同分段的引导的步骤如何区分呢？</p><p>这里需要对ID的范围进行划分，笔者习惯以100作为一段引导的ID区间，如何理解呢？比如这里除了进阶引导外，还有一个卡牌重置引导，那么卡牌重置引导步骤的id范围可以规定在101~200之间，我们可以将这个引导的起始id设置为从101开始，配到表里面大概是这样的：</p><img src="/GuideMgr02/img_guide_step_02.png"><p>绿框里的内容表示卡牌进阶引导，红框里的内容表示卡牌重置引导。若后续还有其他引导，可以从201开始，以此类推。</p><h3 id="类别"><a href="#类别" class="headerlink" title="类别"></a>类别</h3><p>类别表示操作的分类，按照前文《理论篇》提到的分类方法，在类别这一列填写类别定义的数字。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 操作类别定义</span><br><span class="line">1. 立绘对话</span><br><span class="line">2. 点击</span><br><span class="line">3. 拖动</span><br></pre></td></tr></table></figure><p>操作类别可根据需求自己定义。</p><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>操作表示当前步骤具体做什么事，每一个具体的操作都需要做详细的定义，参考前文《理论篇》的定义，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0. 无操作</span><br><span class="line"></span><br><span class="line">// 点击操作定义</span><br><span class="line">201. 点击自己卡池里满足进阶条件的一张卡牌</span><br><span class="line">202. 点击卡牌详情界面的进阶按钮</span><br><span class="line">203. 点击进阶面板的进阶按钮</span><br><span class="line"></span><br><span class="line">// 拖动操作定义</span><br><span class="line">301. 在进阶面板拖动第1张材料卡到进阶消耗框</span><br></pre></td></tr></table></figure><p>定义后，将定义中操作内容对应的数字填写到表中“操作”一列中。操作的定义数字最好是类别定义的数字乘以100加X，这样方便知晓对应的操作属于哪一类别，方便抽象和扩展.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">操作 = 类别 * 100 + X</span><br></pre></td></tr></table></figure><h3 id="操作参数"><a href="#操作参数" class="headerlink" title="操作参数"></a>操作参数</h3><p>操作参数是对操作的补充，对做相同事情但操作对象有略微差别的一种说明。以卡牌进阶引导中，拖动卡池里的材料卡为例。假如卡牌进阶需要消耗两张卡池中的同名卡，这时候需要有两步引导操作，分别是：</p><ul><li>拖动卡池中第一张材料卡到待消耗区域</li><li>拖动卡池中第二张材料卡到待消耗区域</li></ul><p>这两步引导做的是相同的事情，但是拖动的卡牌略有不同，这时可以将“拖动卡池中的材料卡到待消耗区域”定义成一种操作，加上操作参数：第几张卡。</p><p>考虑到操作的补充参数可能不止一种，这里使用Json格式的字符串填写，方便扩展。</p><h3 id="对话内容"><a href="#对话内容" class="headerlink" title="对话内容"></a>对话内容</h3><p>对话内容只要用于立绘对话形式的引导步骤，直接填写对话文本即可，没有立绘对话的引导步骤可不填或填0表示内容为空。</p><h3 id="说话人物"><a href="#说话人物" class="headerlink" title="说话人物"></a>说话人物</h3><p>说话人物用于立绘对话形式的引导步骤，表示不同的说话人物。与操作定义类似，说话人物也需要定义，若说话人物使用的是本身游戏中的角色，可直接填写角色的id，填0表示无人物。</p><h3 id="保存点"><a href="#保存点" class="headerlink" title="保存点"></a>保存点</h3><p>保存点的必要性在前文《理论篇》已经提及，保存点的逻辑操作是，在当前步的操作已经做完，即将进入下一步前，往服务端发送一个引导ID，表示下一次重新登录时，引导从那一步ID开始。填0表示不往服务端发送保存点。</p><p>那为什么表里面会配置100？100这个引导ID并没有在表里出现呀？而且为什么引导走到了第7步还要往服务端发送引导ID为1的点呢？</p><p>其实这里的保存点不是引导ID，而是一个<strong>差值</strong>，填1表示将当前步的下一步引导ID发送给服务端保存，填2表示当前步骤的后面第2不的引导ID发送到服务端保存，而100则表示结束当前引导分段，并标记当前分段引导已完成，后续不再触发。</p><p>之所以填<strong>差值</strong>而不直接填<strong>引导ID</strong>的值，是因为引导的需求是在不断地变化的，很可能一段很长的引导，在前面步骤插入了一步，那么后续的引导ID都将往后+1，这样保存点也要跟着变动，保存点多的情况下很容易出现漏改的情况，因此使用<strong>差值</strong>可以减少变动。</p><p>一般情况下，引导保存点在当前步骤以后，所以默认引导保存点的值只有大于0的时候才有意义。</p><h2 id="触发表"><a href="#触发表" class="headerlink" title="触发表"></a>触发表</h2><img src="/GuideMgr02/img_guide_trigger_01.png"><p>上图是集成了卡牌进阶引导和卡牌重置引导的引导触发表，接下来对触发表的各列配置进行说明。</p><h3 id="ID-1"><a href="#ID-1" class="headerlink" title="ID"></a>ID</h3><p>引导触发表的ID，无实际意义，仅表示序列。</p><h3 id="分段ID"><a href="#分段ID" class="headerlink" title="分段ID"></a>分段ID</h3><p>分段ID是引导分段的唯一标识，结合步骤表的引导ID以100作为区间规则，我们默认：1~100的引导分段ID是0，101~200的分段ID是1，后续引导分段以此类推。</p><h3 id="触发点、触发点参数"><a href="#触发点、触发点参数" class="headerlink" title="触发点、触发点参数"></a>触发点、触发点参数</h3><p>触发点的概念在前文《理论篇》中已做详细讲解，这里补充一下触发点参数及定义。与操作参数类似，触发点参数是对触发点逻辑的补充，有了参数的补充，触发点可以做一些逻辑上的抽象，定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 触发点及参数的定义</span><br><span class="line">1. 英雄等级达到N级时，判断引导触发条件</span><br><span class="line">参数：</span><br><span class="line">level：英雄等级</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">&#123;&apos;level&apos;:20&#125;</span><br><span class="line">当英雄升级到20级时，判断引导是否满足触发条件</span><br><span class="line"></span><br><span class="line">2. 当打开某个场景时，判断引导触发条件</span><br><span class="line">参数：</span><br><span class="line">scene：场景名字</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">&#123;&apos;scene&apos;:&apos;HeroesScene&apos;&#125;</span><br><span class="line">当进入卡池场景时，判断引导是否满足触发条件</span><br><span class="line"></span><br><span class="line">3. 卡牌重置功能解锁时，判断引导是否满足触发条件</span><br></pre></td></tr></table></figure><h3 id="触发条件、触发条件参数"><a href="#触发条件、触发条件参数" class="headerlink" title="触发条件、触发条件参数"></a>触发条件、触发条件参数</h3><p>触发条件的概念在前文《理论篇》中也做过讲解，这里也仅做补充说明。触发条件的填写与触发点类似，唯一不同的是：触发条件的配置是数组，需要支持多条件的填写，数字定义以<code>|</code>隔开，参数的填写也同理，多个Json字符串之间用<code>|</code>隔开，当不需要参数时，在参数列填0即可。多个触发条件之间是<strong>并</strong>的关系。定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 触发条件及参数的定义</span><br><span class="line">0. 无需条件，即可触发引导</span><br><span class="line"></span><br><span class="line">1. 当前在某个场景中</span><br><span class="line">参数：</span><br><span class="line">scene：场景名字</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">&#123;&apos;scene&apos;:&apos;HeroesScene&apos;&#125;</span><br><span class="line">引导满足当前场景在卡池界面时触发</span><br><span class="line"></span><br><span class="line">2. 卡池中有卡牌等级达到N级，且同名卡数量达到一定张数</span><br><span class="line">参数：</span><br><span class="line">level：卡牌等级</span><br><span class="line">num：同名卡数量</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">&#123;&apos;level&apos;:20,&apos;num&apos;:2&#125;</span><br><span class="line">当卡池中有卡牌等级达到20级，且同名卡数量至少有2张时，触发引导</span><br></pre></td></tr></table></figure><p>了解了触发表的各列含义，我们将其串联起来理解，便是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">卡牌进阶引导的触发（_groupId为0）：</span><br><span class="line">触发一：</span><br><span class="line">当有卡牌等级升到了20级时，判断当前场景在卡池界面，且有等级超过20级的卡牌有2张同名卡，触发引导。</span><br><span class="line">触发二：</span><br><span class="line">当进入卡池场景时，判断卡池中有卡牌等级达到20级且有至少2张同名卡，触发引导。</span><br><span class="line"></span><br><span class="line">卡牌重置引导的触发（_groupId为1）：</span><br><span class="line">触发一：</span><br><span class="line">当卡牌重置功能解锁时，即触发引导。</span><br></pre></td></tr></table></figure><h1 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h1><blockquote><p>友情提示：请读者们将思维切换到编码思维。</p></blockquote><p>创建一个引导类，命名为GuideMgr.lua（Guide Manager）。</p><p>引导是分段触发的，所以需要有触发的判断和当前段引导的终止：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.checkTrigger</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.finish</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>引导分步骤，所以需要有当前步的开始和下一步：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.start</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.next</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>引导需要知晓当前在哪一步，以及记录哪些引导是已经走过的：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GuideMgr._guideId</span><br><span class="line">GuideMgr._finished = &#123;&#125;</span><br></pre></td></tr></table></figure><p>这两个值一般在客户端收到登录包时，从服务器拿数据并解析得到。GuideMgr._finished的数据结构大概是这样的：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GuideMgr._finished = &#123;</span><br><span class="line">    [<span class="number">1</span>] = <span class="literal">true</span>,</span><br><span class="line">    [<span class="number">3</span>] = <span class="literal">true</span>,</span><br><span class="line">    [<span class="number">11</span>] = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的1、3、11表示引导的分段ID，每当有新的引导完成时，该引导分段ID都将记录在这个结构里。</p><p>记录了引导ID以后，需要留一个接口，用来获取引导步骤表里面的对应步骤信息：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getInfo</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>定义了上述几个方法后，就可以开始搭建引导的框架了：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GuideMgr = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">GuideMgr._guideId = <span class="literal">nil</span></span><br><span class="line">GuideMgr._finished = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.checkTrigger</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.finish</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.start</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.next</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="触发判断"><a href="#触发判断" class="headerlink" title="触发判断"></a>触发判断</h2><p>先从触发的判断开始吧！触发的判断逻辑思维主要是传入对应的触发点，以及想要触发的引导分段id，然后在<code>GuideMgr.checkStart</code>方法里判断是否满足条件，若满足条件则调用<code>GuideMgr.start</code>方法开始分段引导的第一步。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.checkTrigger</span><span class="params">(point, group)</span></span></span><br><span class="line">    <span class="comment">-- No point, no trigger.</span></span><br><span class="line">    <span class="keyword">if</span> point == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Do not trigger a new guide when guiding.</span></span><br><span class="line">    <span class="keyword">if</span> GuideMgr.isGuiding() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Init the candidate infos.</span></span><br><span class="line">    <span class="keyword">local</span> candidateInfos</span><br><span class="line">    <span class="keyword">if</span> group == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        candidateInfos = GuideMgr.getAllInfos()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elseif</span> <span class="built_in">type</span>(group) == <span class="string">"number"</span> <span class="keyword">or</span> <span class="built_in">type</span>(group) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        candidateInfos = GuideMgr.getInfosByGroup(group)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> candidateInfos == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Filter infos by finished.</span></span><br><span class="line">    candidateInfos = GuideMgr.getUnfinishedInfos(candidateInfos)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Filter infos by trigger point.</span></span><br><span class="line">    candidateInfos = GuideMgr.getPointValidInfos(point, candidateInfos)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Filter infos by trigger condition.</span></span><br><span class="line">    candidateInfos = GuideMgr.getConditionValidInfos(candidateInfos)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Check candidate infos empty.</span></span><br><span class="line">    <span class="keyword">if</span> #candidateInfos == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Sort by priority and group id.</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(candidateInfos, <span class="function"><span class="keyword">function</span><span class="params">(ele1, ele2)</span></span></span><br><span class="line">        <span class="keyword">if</span> ele1._priority == ele2._priority <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> ele1._groupId &lt; ele2._groupId</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> ele1._priority &gt; ele2._priority</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Start first guide step.</span></span><br><span class="line">    <span class="keyword">local</span> info = candidateInfos[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">local</span> triggerGroupId = info._groupId</span><br><span class="line">    <span class="keyword">local</span> guideId = triggerGroupId * <span class="number">100</span> + <span class="number">1</span></span><br><span class="line">    GuideMgr.start(guideId)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>GuideMgr.isGuiding</code>方法判断目前是否在引导中，通过GuideMgr._guideId是否大于0来区分，因为每走一步引导，GuideMgr._guideId都会被赋值，而这个值就是引导步骤表GuideStep.csv的<code>_id</code>一列的值。当引导结束时，GuideMgr._guideId会被赋值为0。代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.isGuiding</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> GuideMgr._guideId <span class="keyword">and</span> GuideMgr._guideId &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>其中<code>GuideMgr.getAllInfos</code>方法是从GuideTrigger.csv中获取每一行触发信息，以数组的形式返回。不同的项目组有不同的读表逻辑，这里就不贴出详细代码了。</p><p><code>GuideMgr.getInfosByGroup</code>方法是从GuideTrigger.csv中通过<code>_groupId</code>一列的值，筛选出指定引导分段的触发信息，以数组的形式返回。</p><p><code>GuideMgr.getUnfinishedInfos</code>方法是为了过滤掉已经触发过的引导，一般引导只会走一次，所以已经走过的引导不再触发。思路是从触发表中拿到<code>_groupId</code>的值，与GuideMgr._finished进行比对，若存在该值，则表示引导已经触发过。代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getUnfinishedInfos</span><span class="params">(infos)</span></span></span><br><span class="line">    <span class="keyword">if</span> infos == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> ret = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #infos <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = infos[i]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> GuideMgr.isFinished(info._groupId) <span class="keyword">then</span></span><br><span class="line">            ret[#ret + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.isFinished</span><span class="params">(groupId)</span></span></span><br><span class="line">    <span class="keyword">return</span> GuideMgr._finished[groupId] == <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>GuideMgr.getPointValidInfos</code>方法是在触发信息中筛选出相同<strong>触发点</strong>的信息，以数组形式返回。详细的触发点信息判断在<code>GuideMgr.isTriggerPointValid</code>方法中处理。传入的触发点变量可以是<code>number</code>类别，仅表示触发点；也可以是<code>table</code>类别，内包含触发点和触发点参数，结构如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    _point = GuideMgr.Point.enter_scene,</span><br><span class="line">    _param = &#123;</span><br><span class="line">        _sceneId = Data.SceneId.main_scene</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GuideMgr.getPointValidInfos</code>和<code>GuideMgr.isTriggerPointValid</code>详细代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getPointValidInfos</span><span class="params">(point, infos)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #infos <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = infos[i]</span><br><span class="line">        <span class="keyword">if</span> GuideMgr.isTriggerPointValid(info, point) <span class="keyword">then</span></span><br><span class="line">            ret[#ret + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.isTriggerPointValid</span><span class="params">(info, point)</span></span></span><br><span class="line">    <span class="keyword">local</span> param</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Parse param.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(point) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        param = point._param</span><br><span class="line">        point = point._point</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Different trigger point.</span></span><br><span class="line">    <span class="keyword">if</span> info._point ~= point <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Special handling.</span></span><br><span class="line">    <span class="keyword">if</span> point == GuideMgr.Point.enter_scene <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Compare with the info in GuideTrigger.csv.</span></span><br><span class="line">        <span class="keyword">local</span> sceneName = info._pointParam.scene</span><br><span class="line">        <span class="keyword">return</span> Data.SceneId[sceneName] == param._sceneId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- More point param check.</span></span><br><span class="line">        <span class="comment">-- ...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>筛选出满足触发点的触发信息后，继续通过<code>GuideMgr.getConditionValidInfos</code>方法筛选出<strong>触发条件</strong>满足的信息。详细判断逻辑在<code>GuideMgr.isConditionValid</code>方法中，通过传入<code>触发条件定义</code>和<code>触发条件参数</code>，具体逻辑具体判断。代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getConditionValidInfos</span><span class="params">(infos)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #infos <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> isValid = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">local</span> info = infos[i]</span><br><span class="line">        <span class="comment">-- Array already parsed.</span></span><br><span class="line">        <span class="keyword">local</span> conds = info._conds</span><br><span class="line">        <span class="comment">-- Parse param array.</span></span><br><span class="line">        <span class="keyword">local</span> params = <span class="built_in">string</span>.split(info._params, <span class="string">"|"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> j = <span class="number">1</span>, #conds <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> GuideMgr.isConditionValid(conds[j], params[j]) <span class="keyword">then</span></span><br><span class="line">                isValid = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> isValid <span class="keyword">then</span></span><br><span class="line">            ret[#ret + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.isConditionValid</span><span class="params">(condition, param)</span></span></span><br><span class="line">    <span class="keyword">if</span> condition == GuideMgr.Cond.current_scene <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Get current scene.</span></span><br><span class="line">        <span class="keyword">local</span> scene = ...</span><br><span class="line">        <span class="keyword">return</span> Data.SceneId[param.scene] == scene._sceneId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elseif</span> condition == GuideMgr.Cond.hero_by_num_level <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Check condition validation.</span></span><br><span class="line">        <span class="comment">-- ...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>过滤出满足触发点和触发条件的触发信息后，对信息按照优先级进行排序，排序后取第一条触发信息里的引导分段ID（_groupId），将分段ID转为当前分段引导的第一步引导ID，传入<code>GuideMgr.start</code>方法中开始当前分段的引导。</p><h2 id="开始引导"><a href="#开始引导" class="headerlink" title="开始引导"></a>开始引导</h2><p>触发判断筛选出符合要求的引导分段后开始引导，<code>GuideMgr.start</code>方法通过传入引导步骤ID，做当前步骤的引导操作，如：立绘说话、引导点击、其他引导效果等。<code>GuideMgr.starat</code>代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.start</span><span class="params">(guideId)</span></span></span><br><span class="line">    guideId = guideId <span class="keyword">or</span> M._guideId</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> guideId == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Check guide info validation.</span></span><br><span class="line">    <span class="keyword">local</span> info = GuideMgr.getInfo(guideId)</span><br><span class="line">    <span class="keyword">if</span> info == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Guide info not exists.</span></span><br><span class="line">        GuideMgr.finish()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Set guide id.</span></span><br><span class="line">    GuideMgr._guideId = guideId</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Set view</span></span><br><span class="line">    GuideMgr.setView(info)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>GuideMgr.start</code>传入的参数——引导步骤ID（下称“引导ID”），当没有传参时，默认使用之前记录的引导ID。通过引导ID判断对应的引导步骤信息是否存在，若存在，将引导ID记录下来，并将对应的引导步骤信息传入视图层，做进一步的操作。</p><p><code>GuideMgr.getInfo</code>方法通过传入引导ID，从步骤表GuideStep.csv中读取对应<code>_id</code>的信息，若没有传参，则默认使用当前已记录的引导ID。代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.getInfo</span><span class="params">(guideId)</span></span></span><br><span class="line">    guideId = guideId <span class="keyword">or</span> M._guideId</span><br><span class="line">    <span class="keyword">if</span> guideId == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Get info in GuideStep.csv by _id.</span></span><br><span class="line">    <span class="comment">-- ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="下一步引导"><a href="#下一步引导" class="headerlink" title="下一步引导"></a>下一步引导</h2><p><code>GuideMgr.next</code>是引导从当前步走向下一步的逻辑方法。</p><p>首先判断当前步骤的引导信息是否存在，不存在则结束当前引导，这个逻辑是一个容错，一般情况下不会存在：调用<code>GuideMgr.next</code>时，当前步骤信息不存在的情况。</p><p>然后判断当前步骤是否存在保存点，存在则将保存点对应的引导ID保存到服务端。</p><p>最后引导ID加1，传入<code>GuideMgr.start</code>方法中，开始下一步引导。</p><p>代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.next</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- Check current step info validation.</span></span><br><span class="line">    <span class="keyword">local</span> info = GuideMgr.getInfo()</span><br><span class="line">    <span class="keyword">if</span> info == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        GuideMgr.finish()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Check saving guide id.</span></span><br><span class="line">    GuideMgr.checkSave(info)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Next guide step id.</span></span><br><span class="line">    <span class="keyword">local</span> guideId = M._guideId + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> GuideMgr.start(guideId)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>保存点的逻辑是读取GuideStep.csv的<code>_saveId</code>一列，若对应的值大于0，则将该值加上当前步骤的ID（<code>_saveId</code>填的数值是相对值）所得的值，传入服务器进行保存。代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.checkSave</span><span class="params">(info)</span></span></span><br><span class="line">    <span class="keyword">if</span> info == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> saveId = info._saveId</span><br><span class="line">    <span class="keyword">if</span> saveId &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        saveId = info._id + saveId</span><br><span class="line">        <span class="comment">-- Save the id to the server.</span></span><br><span class="line">        GuideMgr.saveGuideId(saveId)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>GuideMgr.saveGuideId</code>方法做的逻辑是将传入的id发送到服务端进行保存。</p><h2 id="结束引导"><a href="#结束引导" class="headerlink" title="结束引导"></a>结束引导</h2><p>结束引导主要做重置数据、移除视图的操作，先看下代码：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GuideMgr.finish</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- Guide is not started.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> GuideMgr.isGuiding() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--[[ Reset data ]]</span><span class="comment">--</span></span><br><span class="line">    <span class="comment">-- Save guide group.</span></span><br><span class="line">    <span class="keyword">local</span> guideId = GuideMgr._guideId</span><br><span class="line">    <span class="keyword">local</span> groupId = <span class="built_in">math</span>.<span class="built_in">floor</span>(guideId / <span class="number">100</span>)</span><br><span class="line">    GuideMgr.saveGuideGroup(groupId)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Reset guide id.</span></span><br><span class="line">    GuideMgr.saveGuideId(<span class="number">0</span>)</span><br><span class="line">    GuideMgr._guideId = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--[[ Remove view ]]</span><span class="comment">--</span></span><br><span class="line">    GuideMgr.removeView()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>GuideMgr.saveGuideGroup</code>往服务端保存一个引导分段ID，表示当前分段的引导已经完成，后面不再触发；实际的逻辑操作类似于把分段ID加到服务端的GuideMgr._finished结构里。</p><p><code>GuideMgr.removeView</code>做视图的移除操作，考虑到篇幅的限制，视图相关的逻辑将在下一篇文章中讲解。</p><h1 id="下篇预告"><a href="#下篇预告" class="headerlink" title="下篇预告"></a>下篇预告</h1><p>下一篇文章将继续本文的<strong>实操篇</strong>进行视图逻辑的讲解，主要包含：引导手指、高亮框、文本框的添加，点击、触摸限制逻辑的判断等，读者们看完下篇文章，基本可以自己写一个引导了。考虑到工作的原因，文章更新会比较慢，还请大家海涵！</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/GuideMgr02/#disqus_thread</comments>
    </item>
    
    <item>
      <title>从零开始设计游戏引导框架（一）</title>
      <link>http://wjnovember.github.io/GuideMgr01/</link>
      <guid>http://wjnovember.github.io/GuideMgr01/</guid>
      <pubDate>Sat, 11 Apr 2020 12:00:00 GMT</pubDate>
      <description>
      
        
        
          &lt;h1 id=&quot;背景叨叨叨&quot;&gt;&lt;a href=&quot;#背景叨叨叨&quot; class=&quot;headerlink&quot; title=&quot;背景叨叨叨&quot;&gt;&lt;/a&gt;背景叨叨叨&lt;/h1&gt;&lt;p&gt;大学毕业后入坑Cocos游戏开发已经快三年了，参与了两三个游戏的开发，经历过三四次颠覆式的版本迭代，其中涉足最深的莫
        
      
      </description>
      
      <content:encoded><![CDATA[<h1 id="背景叨叨叨"><a href="#背景叨叨叨" class="headerlink" title="背景叨叨叨"></a>背景叨叨叨</h1><p>大学毕业后入坑Cocos游戏开发已经快三年了，参与了两三个游戏的开发，经历过三四次颠覆式的版本迭代，其中涉足最深的莫过于游戏引导框架的设计开发，一路走来踩过许多坑，感觉有必要写一个引导框架设计的系列博客，就叫《<strong>从零开始设计游戏引导框架</strong>》吧！文章基于Cocos-2dx平台，使用Lua脚本开发，涉及配表和代码编写，有不足之处，望读者们批评指正！</p><p>本文是系列文章的第一篇，先从理论层面开始梳理吧！</p><h1 id="引导的作用"><a href="#引导的作用" class="headerlink" title="引导的作用"></a>引导的作用</h1><p>假如一款全新的游戏上市，新的玩法、新的角色、新的场景摆在玩家面前，玩家一进入游戏而没有被告知玩法，一切的操作都需要玩家自己去摸索，那么这款游戏给人的感觉是“生硬”的，往往这一类游戏很难让玩家接受并耐着性子玩下去。</p><p>这时候如果给这个游戏加一个开场引导，交代游戏的背景，引导玩家按照核心玩法点击各个按钮，并告知每一步操作的作用，这样游戏会更能被玩家接受。</p><p>有时候，为了引起玩家的兴趣，开场引导中往往会加入更有代入感的剧情，加上华丽的美术特效，让玩家在玩游戏的过程中分泌更多的快乐素（多巴胺）。</p><p>至此，引导的作用就知晓了：</p><ul><li>增加代入感</li><li>交代核心玩法</li></ul><h1 id="引导是分段的"><a href="#引导是分段的" class="headerlink" title="引导是分段的"></a>引导是分段的</h1><p>然而游戏不仅只有开场引导，随着游戏进度的深入，玩家会接触越来越多的玩法操作，每个玩法都有其专属的引导。这时一个概念需要被树立：<strong>引导是分段的，一段引导对应一个玩法介绍。</strong></p><p>拿率土之滨举例子！</p><p>进入游戏后，玩家的主城被流寇抢夺，引导人物出来说几句话，然后引导玩家进行点击操作，这是<strong>游戏开场引导</strong>。</p><img src="/GuideMgr01/img_01.jpg" title="引导人物对话"><img src="/GuideMgr01/img_02.jpg" title="引导点击操作"><p>在一系列引导操作后，玩家可以自由操作了。这时玩家点击“演武”按钮进入了演武界面，一个新的引导——<strong>演武引导</strong>出现了，它会告诉玩家演武功能的基本操作。</p><img src="/GuideMgr01/img_03.jpg" title="演武引导"><p>从演武界面出来后，玩家进入招募界面，<strong>招募引导</strong>会告知玩家点指定卡包抽卡。</p><img src="/GuideMgr01/img_04.jpg" title="招募引导"><p>引导会根据需要，在玩家首次进入某个界面或满足条件时触发，以帮助玩家理解对应玩法。</p><p>每一个功能点都可以以一段引导辅助说明。</p><h1 id="每段引导分步骤"><a href="#每段引导分步骤" class="headerlink" title="每段引导分步骤"></a>每段引导分步骤</h1><p>上面说的<strong>引导分段</strong>只是从功能层面定义，而引导里具体做什么是需要程序员去定义拆分的，简言之，<strong>引导需要分步骤</strong>。</p><p>以率土的开场引导为例，玩家进入游戏:</p><ul><li>第1步，流寇部队进攻玩家主城；</li><li>第2步，流寇将领出现在屏幕上，说一句话；</li><li>第3步，引导主人公出现，说一句话；</li><li>第4步，引导玩家点击地图格……</li></ul><p>一段引导就是这样一步接一步进行的。当策划提出一个引导需求时，最多只会给出大致流程，至于如何将一段引导拆分成步骤，需要程序员自行梳理。</p><p>分步，是一种思维方式，如何合理拆分，让代码更容易维护，是一个日积月累的过程。</p><img src="/GuideMgr01/img_05.jpg"><h1 id="引导的触发"><a href="#引导的触发" class="headerlink" title="引导的触发"></a>引导的触发</h1><p>引导的触发，是针对一段引导而言，一段引导是交代<strong>做什么事情</strong>，而触发则是交代<strong>什么时候</strong>做事。</p><p>为了让读者们更容易理解，我们代入一个场景。</p><h2 id="场景代入"><a href="#场景代入" class="headerlink" title="场景代入"></a>场景代入</h2><p>假设在一个卡牌养成类游戏中，卡牌有等级，可以进阶（每进阶一级，黄色星星会有一颗变成红色），大概像这样：</p><img src="/GuideMgr01/img_card_01.png" title="蓝框框：等级，红框框：星级（阶）"><p>（蓝色框框：等级，红色框框：星级 或 “阶”）</p><p>接下来策划提出要做一个卡牌的进阶引导，已知进阶的条件是：</p><ul><li>英雄等级达到20级；</li><li>有其他同名卡牌作为进阶素材；</li></ul><blockquote><p><strong>同名卡牌</strong>：名字相同的卡牌。<br>比如我有两张吕蒙，可以把其中一张吕蒙作为另一张吕蒙进阶材料。</p></blockquote><h2 id="触发点-amp-触发条件"><a href="#触发点-amp-触发条件" class="headerlink" title="触发点 &amp; 触发条件"></a>触发点 &amp; 触发条件</h2><p>场景有了，接下来聊聊引导的触发。</p><p>如果说，引导是<strong>什么时候，该做什么事</strong>。<br>那么，引导的触发就是<strong>什么时候</strong>。</p><p>但是这个<strong>时候</strong>包含着两层含义：</p><ul><li>触发点</li><li>触发条件</li></ul><p>将它代入到之前场景里，就是：在卡牌等级经验达到20级的那个<strong>触发点</strong>，卡牌满足有同名卡的<strong>触发条件</strong>，触发卡牌进阶引导。</p><p>用英文的方式理解，就是：</p><ul><li>触发点 = <strong>when</strong></li><li>触发条件 = <strong>it is</strong></li></ul><p>两者连在一起，就是：<strong>When it is …, 触发引导</strong>。</p><h2 id="触发的多情况判断"><a href="#触发的多情况判断" class="headerlink" title="触发的多情况判断"></a>触发的多情况判断</h2><p>前面提到，当卡牌等级达到20级时，如果存在同名卡就触发引导。</p><p>那么如果吕蒙卡牌到达20级时，没有同名卡该怎么触发引导呢？</p><p>这个时候需要<strong>把引导的触发点和触发条件互换一下</strong>，也就是当玩家得到一张吕蒙时，如果吕蒙有同名卡且多张吕蒙卡牌中有至少一张卡牌等级达到20级，则引导触发。</p><p>简单写为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">触发点：获得一张卡牌</span><br><span class="line">触发条件：</span><br><span class="line">1. 该卡牌存在同名卡</span><br><span class="line">2. 同名卡中至少存在一张等级达到20级的卡牌</span><br></pre></td></tr></table></figure><p>综上，一个引导的触发，需要多情况判断，在设计引导时，只有尽可能细化引导触发的各个因素，才能在后期的开发中尽可能减少BUG的出现。</p><h1 id="引导的操作"><a href="#引导的操作" class="headerlink" title="引导的操作"></a>引导的操作</h1><p>如果说引导的触发是针对引导分段，那么引导的操作则是针对引导分步，即：<strong>每一步做什么事</strong>。</p><h2 id="操作分类"><a href="#操作分类" class="headerlink" title="操作分类"></a>操作分类</h2><p>引导的操作很杂，根据策划的需求，会有不同的形式，比如：</p><ul><li>点击某个按钮</li><li>拖动某张卡牌</li><li>高亮某个区域</li><li>显示一个立绘对话</li><li>……</li></ul><p>根据操作形式的共性，将其抽象分类如下：</p><ul><li>点击</li><li>拖动</li><li>高亮框</li><li>对话</li></ul><p>定义了分类后，那么问题来了：为什么要将操作分类呢？</p><p>因为操作有其共性，有共性就意味着会有相同的代码逻辑，做好分类后方便对操作统一管理。</p><p>以<strong>点击</strong>举例子：</p><p>在强制引导点击时，我们知道，玩家只能点击指定的控件，而不能点击控件以外的地方。这时需要做的统一逻辑，就是：在手指点击屏幕的那一刻，判断手指点击的位置，判断是不是按钮区域。是，则不阻挡事件传递；否则，阻挡触摸事件。</p><p>然而操作的分类不仅仅局限于上述几类，分类可根据策划的需求做进一步扩展。在偏剧情向的引导中，可能还需增加“剧情”类别，若剧情是有固定形式的展现，还可根据实际情况做进一步分类，如：</p><ul><li>剧情：多格漫画</li><li>剧情：镜头拉伸</li><li>剧情：视频</li><li>……</li></ul><p>所以操作的分类是灵活多变的，具体分类根据需求来定。</p><h2 id="操作定义"><a href="#操作定义" class="headerlink" title="操作定义"></a>操作定义</h2><p>操作最终还需落实到具体细节，也就是<strong>具体做什么事</strong>。之前定义了“点击”类别，那么具体点击什么，就需要做具体的定义了。</p><p>以之前的“卡牌进阶引导”为例，当触发引导时，引导步骤如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. NPC说话：“主公，您有一个英雄已经满足进阶条件了，我们现在来看看吧！”</span><br><span class="line">2. 引导点击满足进阶条件的卡牌，进入卡牌详情页</span><br><span class="line">3. 引导点击卡牌详情页的进阶按钮，进入卡牌进阶界面</span><br><span class="line">4. NPC说话：“现在请主公将材料卡拖动到消耗框里。”</span><br><span class="line">5. 引导从卡牌列表框中拖动一张同名卡到消耗框中</span><br><span class="line">6. 引导点击进阶按钮确认进阶</span><br><span class="line">7. NPC说话：“恭喜主公成功进阶武将！”</span><br></pre></td></tr></table></figure><img src="/GuideMgr01/img_upgrade_01.png"><p>根据上述操作步骤，对操作定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 操作类别定义</span><br><span class="line">1. 立绘对话</span><br><span class="line">2. 点击</span><br><span class="line">3. 拖动</span><br><span class="line"></span><br><span class="line">// 具体操作定义</span><br><span class="line">0. 无操作</span><br><span class="line"></span><br><span class="line">// 点击操作定义</span><br><span class="line">201. 点击自己卡池里满足进阶条件的一张卡牌</span><br><span class="line">202. 点击卡牌详情界面的进阶按钮</span><br><span class="line">203. 点击进阶面板的进阶按钮</span><br><span class="line"></span><br><span class="line">// 拖动操作定义</span><br><span class="line">301. 在进阶面板拖动第1张材料卡到进阶消耗框</span><br><span class="line"></span><br><span class="line">// 对话在流程表中填写具体对话内容和人物即可，无需定义</span><br><span class="line">// 说话人物定义</span><br><span class="line">0. 无人物</span><br><span class="line">1. NPC</span><br></pre></td></tr></table></figure><p>根据定义，配引导流程表如下（配表后面细讲，这里看个大概即可）：</p><table><thead><tr><th align="left">id</th><th align="left">类别</th><th align="left">操作</th><th align="left">对话内容</th><th align="left">说话人</th></tr></thead><tbody><tr><td align="left">_id</td><td align="left">_type</td><td align="left">_action</td><td align="left">_text</td><td align="left">_role</td></tr><tr><td align="left">H</td><td align="left">H</td><td align="left">H</td><td align="left">D</td><td align="left">H</td></tr><tr><td align="left">1</td><td align="left">1</td><td align="left">0</td><td align="left">主公，您有一个英雄已经满足进阶条件了，我们现在来看看吧！</td><td align="left">1</td></tr><tr><td align="left">2</td><td align="left">2</td><td align="left">201</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">3</td><td align="left">2</td><td align="left">202</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">4</td><td align="left">1</td><td align="left">0</td><td align="left">现在请主公将材料卡拖动到消耗框里。</td><td align="left">1</td></tr><tr><td align="left">5</td><td align="left">3</td><td align="left">301</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">6</td><td align="left">2</td><td align="left">203</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">7</td><td align="left">1</td><td align="left">0</td><td align="left">恭喜主公成功进阶武将！</td><td align="left">1</td></tr></tbody></table><h2 id="操作参数"><a href="#操作参数" class="headerlink" title="操作参数"></a>操作参数</h2><p>假如引导的需求是拖动两张材料卡进行进阶，那么做两次定义就显得冗余了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">！！！ 不推荐这样定义</span><br><span class="line">301. 在进阶面板拖动第1张材料卡到进阶消耗框</span><br><span class="line">302. 在进阶面板拖动第2张材料卡到进阶消耗框</span><br></pre></td></tr></table></figure><p>因此需要对操作定义进行扩展，给对应操作增加参数配置，原来301的定义就变成了这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 拖动操作定义</span><br><span class="line">301. 在进阶面板拖动第n张材料卡到进阶消耗框 n表示第几张</span><br></pre></td></tr></table></figure><p>相应的，引导流程表也需要多加一列：</p><table><thead><tr><th align="left">id</th><th align="left">类别</th><th align="left">操作</th><th align="left">操作参数</th><th align="left">对话内容</th><th align="left">说话人</th></tr></thead><tbody><tr><td align="left">_id</td><td align="left">_type</td><td align="left">_action</td><td align="left">_actParam</td><td align="left">_text</td><td align="left">_role</td></tr><tr><td align="left">H</td><td align="left">H</td><td align="left">H</td><td align="left">H</td><td align="left">D</td><td align="left">H</td></tr><tr><td align="left">5</td><td align="left">3</td><td align="left">301</td><td align="left">1</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">6</td><td align="left">3</td><td align="left">301</td><td align="left">2</td><td align="left"></td><td align="left">0</td></tr></tbody></table><p>上述配表，表示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第5步，在进阶面板拖动第1张材料卡到进阶消耗框</span><br><span class="line">第6步，在进阶面板拖动第2张材料卡到进阶消耗框</span><br></pre></td></tr></table></figure><h2 id="操作参数扩展"><a href="#操作参数扩展" class="headerlink" title="操作参数扩展"></a>操作参数扩展</h2><p>在一些逻辑复杂的引导中，一个操作参数往往不能满足需求，这是将<code>_actParam</code>参数由配置数字改为配置<strong>Json格式的字符串</strong>，可支持多参数的配置。</p><p>举例如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 点击操作定义</span><br><span class="line">201. 点击自己卡池里满足进阶条件的一张卡牌</span><br><span class="line">参数：</span><br><span class="line">id：卡牌的id</span><br><span class="line">lv：卡牌的等级</span><br><span class="line">sameNum：同名卡数量</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">&#123;&apos;id&apos;:1,&apos;lv&apos;:20,&apos;sameNum&apos;:2&#125;</span><br><span class="line">点击卡池中id为1，等级至少为20，且同名卡数量超过2张的卡牌</span><br><span class="line"></span><br><span class="line">// 拖动操作定义</span><br><span class="line">301. 在进阶面板拖动第n张材料卡到进阶消耗框</span><br><span class="line">参数：</span><br><span class="line">index：表示第几张材料卡</span><br></pre></td></tr></table></figure><p>引导流程表就变成了这样：</p><table><thead><tr><th align="left">id</th><th align="left">类别</th><th align="left">操作</th><th align="left">操作参数</th><th align="left">对话内容</th><th align="left">说话人</th></tr></thead><tbody><tr><td align="left">_id</td><td align="left">_type</td><td align="left">_action</td><td align="left">_actParam</td><td align="left">_text</td><td align="left">_role</td></tr><tr><td align="left">H</td><td align="left">H</td><td align="left">H</td><td align="left">S</td><td align="left">D</td><td align="left">H</td></tr><tr><td align="left">1</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">主公，您有一个英雄已经满足进阶条件了，我们现在来看看吧！</td><td align="left">1</td></tr><tr><td align="left">2</td><td align="left">2</td><td align="left">201</td><td align="left">{‘id’:10001,’lv’:20,’moreThan’:2}</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">3</td><td align="left">2</td><td align="left">202</td><td align="left">0</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">4</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">现在请主公将材料卡拖动到消耗框里。</td><td align="left">1</td></tr><tr><td align="left">5</td><td align="left">3</td><td align="left">301</td><td align="left">{‘index’:1}</td><td align="left">0</td><td align="left">0</td></tr><tr><td align="left">6</td><td align="left">3</td><td align="left">301</td><td align="left">{‘index’:2}</td><td align="left">0</td><td align="left">0</td></tr><tr><td align="left">7</td><td align="left">2</td><td align="left">203</td><td align="left">0</td><td align="left"></td><td align="left">0</td></tr><tr><td align="left">8</td><td align="left">1</td><td align="left">0</td><td align="left">0</td><td align="left">恭喜主公成功进阶武将！</td><td align="left">1</td></tr></tbody></table><p>至此，引导的操作，暂告一段落，若这一块读者们没有看懂，且先放放，后续会做详细讲解。</p><h1 id="引导的保存点"><a href="#引导的保存点" class="headerlink" title="引导的保存点"></a>引导的保存点</h1><p>在产品里，有这么一句话，叫“你永远不知道你的用户是怎么使用你的产品的”。</p><p>游戏也类似，永远不要指望玩家一口气把你写的那一段引导流畅的跑完。在引导过程中，玩家很可能经历：游戏BUG闪退、上课玩游戏被老师抓到等情况，一旦类似的情况发生，引导肯定会中途断掉，而如果玩家再重新上线，看到之前走过的漫长的引导又要重新走一遍时，有很大的概率，玩家是没有耐心继续玩下去的。</p><p>更何况，有些操作是不可重复的，比如玩家走引导，用系统送的货币抽卡，如果重新走一遍，很有可能第二次抽卡货币就不够了，这样的异常会导致引导卡死，这无疑会劝退一大波玩家。</p><p>因此，<strong>保存点</strong>这一概念加入到引导中，以<strong>抽卡引导</strong>为例：</p><p>在点击抽卡按钮的那一步操作里，将引导的保存点设置为下一步引导的id，这样下次重新登录后，引导就会从点抽卡按钮之后的那一步开始继续引导了。</p><p>这里先简单讲解下概念，后续实操篇会详细讲解。</p><h1 id="理论篇收尾"><a href="#理论篇收尾" class="headerlink" title="理论篇收尾"></a>理论篇收尾</h1><p>本文<strong>理论篇</strong>旨在为下一篇配表、编码做一个理论铺垫，防止直接讲解给读者们带来困惑。下一篇为本系列文章的<strong>实操篇</strong>，主要讲解基本的配表和初步的编码逻辑。考虑到工作因素，笔者写文章频率会较低，更新较慢，还请读者们海涵！</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/GuideMgr01/#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
