<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>程序员叨叨叨</title>
    <link>http://wjnovember.github.io/</link>
    <atom:link href="/rss2.html" rel="self" type="application/rss+xml"/>
    
    <description></description>
    <pubDate>Sat, 20 Nov 2021 09:36:24 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>《Unity Shader入门精要》笔记（三）</title>
      <link>http://wjnovember.github.io/UnityShadersBook03/</link>
      <guid>http://wjnovember.github.io/UnityShadersBook03/</guid>
      <pubDate>Sat, 20 Nov 2021 08:02:57 GMT</pubDate>
      <description>
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;本文记录《第4章 学习Shader所需的数学基础》的矩阵基础知识内容。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;笛卡尔坐标系&quot;&gt;&lt;a href=&quot;#笛卡尔坐标系&quot; class=&quot;headerlink&quot; title=&quot;笛卡尔坐标系&quot;&gt;&lt;/
        
      
      </description>
      
      <content:encoded><![CDATA[<blockquote><p>本文记录《第4章 学习Shader所需的数学基础》的矩阵基础知识内容。</p></blockquote><h1 id="笛卡尔坐标系"><a href="#笛卡尔坐标系" class="headerlink" title="笛卡尔坐标系"></a>笛卡尔坐标系</h1><h2 id="二维笛卡尔坐标系"><a href="#二维笛卡尔坐标系" class="headerlink" title="二维笛卡尔坐标系"></a>二维笛卡尔坐标系</h2><p><img src="/UnityShadersBook03/img_01.png" alt></p><p>二维笛卡尔坐标系：</p><ul><li>原点</li><li>x轴、y轴（基矢量）</li></ul><p>x轴、y轴朝向并非固定，如：OpenGL和DirectX使用了不同的二维笛卡尔坐标系。</p><p><img src="/UnityShadersBook03/img_02.png" alt></p><h2 id="三维笛卡尔坐标系"><a href="#三维笛卡尔坐标系" class="headerlink" title="三维笛卡尔坐标系"></a>三维笛卡尔坐标系</h2><p><img src="/UnityShadersBook03/img_03.png" alt></p><p>三维笛卡尔坐标系：</p><ul><li>原点</li><li>x轴、y轴、z轴（基矢量）</li></ul><p>标准基矢量：互相垂直，且长度为1的基矢量。<br>正交基：互相垂直，但长度不为1的基矢量。</p><h2 id="左手坐标系和右手坐标系"><a href="#左手坐标系和右手坐标系" class="headerlink" title="左手坐标系和右手坐标系"></a>左手坐标系和右手坐标系</h2><p>以手的大拇指作为<code>+x</code>轴，食指作为<code>+y</code>轴，中指作为<code>+z</code>轴，将3根手指互相垂直，可以用左手示意的坐标系，为左手坐标系：</p><p><img src="/UnityShadersBook03/img_04.png" alt></p><p>可以用右手示意的坐标系，为右手坐标系：</p><p><img src="/UnityShadersBook03/img_05.png" alt></p><p>左手坐标系和右手坐标系无法通过旋转实现坐标轴指向重合。</p><p>左手坐标系和右手坐标系分别对应<strong>左手法则</strong>和<strong>右手法则</strong>，用来在坐标系中定义旋转的正方向，下图4个手指指向的方向即为正方向：</p><p><img src="/UnityShadersBook03/img_06.png" alt></p><h2 id="Unity使用的坐标系"><a href="#Unity使用的坐标系" class="headerlink" title="Unity使用的坐标系"></a>Unity使用的坐标系</h2><p>Unity的模型空间和世界空间使用的是左手坐标系，注意观看下图红、绿、蓝轴在右上角分别对应x轴、y轴、z轴：</p><p><img src="/UnityShadersBook03/img_07.png" alt></p><p>Unity的观察空间使用的是右手坐标系。观察空间，就是以摄像机作为原点的坐标系，在这个坐标系中，摄像机的前向是z轴的负方向，与模型/世界空间的定义相反。即：z轴坐标的减少意味着场景深度的增加。</p><p><img src="/UnityShadersBook03/img_08.png" alt></p><h1 id="点和矢量"><a href="#点和矢量" class="headerlink" title="点和矢量"></a>点和矢量</h1><p>点是n维空间（游戏中主要是用二维、三维空间）中的一个位置，没有大小、宽度的概念。<br>二维空间点的表示：<code>p = (x, y)</code><br>三维空间点的表示：<code>p = (x, y, z)</code></p><p>矢量是n为空间中包含模和方向的有向线段，没有位置的概念。<br>矢量的模：矢量的长度，非负数。<br>矢量的方向：矢量在空间中的指向。<br>矢量的表示与点类似，<code>v = (x, y)，v = (x, y, z)，v = (x, y, z, w)</code>。</p><p>为区分点和矢量，在变量书写上，标量用小写字母表示，如：a, b, x, y, z等；矢量用小写的粗体字母表示，如：<strong>a</strong>, <strong>b</strong>, <strong>u</strong>, <strong>v</strong>等。</p><p>矢量通常有一个箭头表示：</p><p><img src="/UnityShadersBook03/img_09.png" alt></p><h2 id="矢量和标量的乘法-除法"><a href="#矢量和标量的乘法-除法" class="headerlink" title="矢量和标量的乘法/除法"></a>矢量和标量的乘法/除法</h2><p>标量是只有模，没有方向的量，比如：距离、速度等。<br>矢量无法与标量进行加减运算，但是可以进行乘法或除法运算。</p><p>矢量与标量的乘法：<br><code>kv = (kvx, kvy, kvz)</code></p><p>矢量可以被非0的标量除，但是矢量无法作为除数：</p><p><img src="/UnityShadersBook03/img_10.png" alt></p><p>从几何意义上看，一个矢量<strong>v</strong>和一个标量k相乘，意味着对矢量<strong>v</strong>进行一个大小为|k|的缩放。若k&lt;0，则矢量方向取反，如下图：</p><p><img src="/UnityShadersBook03/img_11.png" alt></p><h2 id="矢量的加法和减法"><a href="#矢量的加法和减法" class="headerlink" title="矢量的加法和减法"></a>矢量的加法和减法</h2><p>两个矢量加减，即：两个矢量的对应分量进行加减，公式如下：<br><strong>a</strong> + <strong>b</strong> = (a<sub>x</sub>+b<sub>x</sub>, a<sub>y</sub>+b<sub>y</sub>, a<sub>z</sub>+b<sub>z</sub>)<br><strong>a</strong> - <strong>b</strong> = (a<sub>x</sub>-b<sub>x</sub>, a<sub>y</sub>-b<sub>y</sub>, a<sub>z</sub>-b<sub>z</sub>)</p><p>从几何意义上看，矢量加法，即：把矢量<strong>a</strong>的头连接到矢量<strong>b</strong>的尾，然后画一条从<strong>a</strong>的尾到<strong>b</strong>的头的矢量，来得到<strong>a</strong>和<strong>b</strong>相加后的矢量，如下图所示：</p><p><img src="/UnityShadersBook03/img_12.png" alt></p><p>也可以理解为：一个点从<strong>a</strong>的尾进行位置偏移<strong>a</strong>，在进行位置偏移<strong>b</strong>，就等同于进行了<strong>a</strong>+<strong>b</strong>的位置偏移，这被称为矢量加法的<strong>三角形定则</strong>。</p><p>矢量的减法类似：</p><p><img src="/UnityShadersBook03/img_13.png" alt></p><p>在图形学中，矢量通常用于描述位置偏移（简称位移）。我们可以利用矢量的加法和减法来计算一点相对于另一点的位移。</p><h2 id="矢量的模"><a href="#矢量的模" class="headerlink" title="矢量的模"></a>矢量的模</h2><p>矢量的模是一个标量，可以理解为矢量在空间中的长度。表示符号通常是在矢量的两边加上竖线，比如：|<strong>v</strong>|。</p><p>三维矢量的模的计算公式：</p><p><img src="/UnityShadersBook03/img_14.png" alt></p><p>其他维度的矢量的模计算类似，都是对每个分量平方相加后开根号。几何意义，可用下图解释：</p><p><img src="/UnityShadersBook03/img_15.png" alt></p><h2 id="单位矢量"><a href="#单位矢量" class="headerlink" title="单位矢量"></a>单位矢量</h2><p>单位矢量指模为1的矢量，也被称为被归一化的矢量（normalized vector）。通常用在只关心方向，不关心模的矢量，比如：模型的发现方向、光源方向等。</p><p>把非零矢量转换成单位矢量的过程叫<strong>归一化</strong>。<br>单位矢量的表示为：</p><p><img src="/UnityShadersBook03/img_16.png" alt></p><p>单位矢量的公式：</p><p><img src="/UnityShadersBook03/img_17.png" alt></p><p>零矢量：每个分量的值都为0的矢量，如：<strong>v</strong> = (0, 0, 0)。零矢量不能被归一化，因为除法运算时，分母不能为0。</p><p>从几何意义上看，对于二维空间，单位矢量就是从圆心出发、到圆边界的矢量：</p><p><img src="/UnityShadersBook03/img_18.png" alt></p><p>对于三维空间，单位矢量就是从圆心出发、到球面的矢量。</p><p>在Unity Shader中，会经常遇到法线方向、光源方向，这些矢量不一定是归一化后的矢量，计算的时候需要将这些矢量归一化成单位矢量。</p><h2 id="矢量的点积"><a href="#矢量的点积" class="headerlink" title="矢量的点积"></a>矢量的点积</h2><p>矢量的乘法有两种类型：点积（dot product）、叉积（cross product）。</p><p>矢量的点积，也叫内积。点积的运算表示：<strong>a</strong>·<strong>b</strong>，中间的点不能省略。</p><p><strong>点积公式一</strong>：<br><strong>a</strong>·<strong>b</strong> = (ax, ay, az) · (bx, by, by) = axby + ayby + azbz</p><p>点积满足交换律：<br><strong>a</strong>·<strong>b</strong> = <strong>b</strong>·<strong>a</strong></p><p>点积的几何意义：<strong>投影</strong>。</p><p><img src="/UnityShadersBook03/img_18.png" alt></p><p>投影的值可能是负数，投影结果的正负号与<strong>a</strong>、<strong>b</strong>两个矢量的方向有关：方向相反，结果小于0；方向相同，结果大于0；方向垂直，结果等于0。</p><p>性质一：<br>点积可结合标量乘法<br>(k<strong>a</strong>)·<strong>b</strong> = <strong>a</strong>·(k<strong>b</strong>)=k(<strong>a</strong>·<strong>b</strong>)<br>k的几何意义是：对矢量进行缩放。</p><p>性质二：<br>点积可结合矢量加减法<br><strong>a</strong>·(<strong>b</strong>+<strong>c</strong>) = <strong>a</strong>·<strong>b</strong> + <strong>a</strong>·<strong>c</strong><br>将<strong>c</strong>换成-<strong>c</strong>就是减法的版本。</p><p>性质三：<br>一个矢量与自身点积的结果是该矢量模的平方<br><strong>v</strong>·<strong>v</strong> = v<sub>x</sub>v<sub>x</sub> + v<sub>y</sub>v<sub>y</sub> + v<sub>z</sub>v<sub>z</sub> = |<strong>v</strong>|<sup>2</sup><br>可以用矢量点积的形式来求矢量的模，Shader中常用模的平方来直接做比较或运算，目的是减少开放带来的性能消耗。</p><p><strong>点积公式二</strong>：<br><strong>a</strong>·<strong>b</strong> = |<strong>a</strong>||<strong>b</strong>|cosθ</p><p>公式二的证明：<br>假设对两个单位矢量进行点积</p><p><img src="/UnityShadersBook03/img_20.png" alt></p><p>如下图所示：</p><p><img src="/UnityShadersBook03/img_21.png" alt></p><p>由上图可知，cosθ对应的直角边是：<strong>a</strong>·<strong>b</strong>的点积（<strong>b</strong>矢量在<strong>a</strong>矢量的投影），且<code>cosθ = 直角边 / 斜边</code>，则<strong>a</strong>·<strong>b</strong>的点积 = <code>cosθ * 斜边</code>，因为单位矢量<strong>b</strong>的模是1（斜边长度为1），所以：<strong>a</strong>·<strong>b</strong>的点积 = cosθ，也就是两个单位矢量的点积为夹角的cos值。</p><p>再由之前性质一，可得推导公式二：</p><p><img src="/UnityShadersBook03/img_23.png" alt></p><p>由公式二可知，点积可用于求两个矢量的夹角：</p><p><img src="/UnityShadersBook03/img_22.png" alt></p><h2 id="矢量的叉积"><a href="#矢量的叉积" class="headerlink" title="矢量的叉积"></a>矢量的叉积</h2><p>叉积，也叫外积。与点积不同，叉积的结果仍然是矢量，而非标量。</p><p>叉积的表示：<strong>a</strong> x <strong>b</strong>，叉号不能省略。叉积的计算公式如下：<br><strong>a</strong> x <strong>b</strong> = (a<sub>x</sub>, a<sub>y</sub>, a<sub>z</sub>) x (b<sub>x</sub>, b<sub>y</sub>, b<sub>z</sub>) = (a<sub>y</sub>b<sub>z</sub>-a<sub>z</sub>b<sub>y</sub>, a<sub>z</sub>b<sub>x</sub>-a<sub>x</sub>b<sub>z</sub>, a<sub>x</sub>b<sub>y</sub>-a<sub>y</sub>b<sub>x</sub>)</p><p>具体的记法，可以这样：</p><ol><li>先看每个分量的被减数<br>a<sub>y</sub>b<sub>z</sub>、a<sub>z</sub>b<sub>x</sub>、a<sub>x</sub>b<sub>y</sub>，它们下标的规律是不包含当前分量下标，比如：x分量的被减数只有y、z下标，y分量的被减数只有x、z下标，z分量的被减数只有x、y下标。</li><li>然后看被减数中a的下标<br>a<sub>y</sub>、a<sub>z</sub>、a<sub>x</sub>，a的下标永远是当前分量的下一个，比如：x分量的下标是y，y分量的下标是z，z分量的下标是x。</li><li>再看被减数中b的下标<br>b<sub>z</sub>、b<sub>x</sub>、b<sub>y</sub>，b的下标永远和a不一样，再结合第1点记忆，b的下标不是当前分量，所以x分量b的下标只能是除了x以外的y、z的其中一个，而y被a用了，所以b的下标只能是z，其他分量的b以此类推。</li><li>再看每个分量的减数<br>a<sub>z</sub>b<sub>y</sub>、a<sub>x</sub>b<sub>z</sub>、a<sub>y</sub>b<sub>x</sub>，他们的下标就是被减数中a和b下标的互换，所以aybz的减数是azby，其他以此类推。</li></ol><p>叉积不满足交换律，即：<strong>a</strong> x <strong>b</strong> ≠ <strong>b</strong> x <strong>a</strong>；但是叉积满足反交换律，即：<strong>a</strong> x <strong>b</strong> = - (<strong>b</strong> x <strong>a</strong>)。<br>叉积不满足结合律，即：(<strong>a</strong> x <strong>b</strong>) x <strong>c</strong> ≠ <strong>a</strong> x (<strong>b</strong> x <strong>c</strong>)。</p><p>叉积的几何意义：<br>对两个矢量进行叉积的结果，会得到同时垂直于这两个矢量的新矢量。</p><p><strong>叉积的模</strong><br>公式：<br>|<strong>a</strong> x <strong>b</strong>| = |<strong>a</strong>||<strong>b</strong>|sinθ</p><p>这容易联想到平行四边形求面积：</p><p><img src="/UnityShadersBook03/img_24.png" alt></p><p>面积A = |<strong>b</strong>| h = |<strong>b</strong>| (|<strong>a</strong>| sinθ) = |<strong>a</strong>||<strong>b</strong>|sinθ</p><p><strong>叉积的方向</strong><br>从几何意义可知，两个矢量的叉积，会得到垂直于两个矢量的新矢量，但是与其垂直的有两个向量。这时前面学到的<strong>左/右手坐标系</strong>就派上用场了，它用来确定叉积得到新矢量的方向朝哪边。</p><p>将大拇指与a同向，食指与b同向，中指指向的方向就是叉积结果的方向，所以使用左、右手就会得到不同的朝向，如下图：</p><p><img src="/UnityShadersBook03/img_25.png" alt></p><p>同理，左右手法则也通用可以用来判断，如下图：</p><p><img src="/UnityShadersBook03/img_26.png" alt></p><h1 id="矩阵"><a href="#矩阵" class="headerlink" title="矩阵"></a>矩阵</h1><h2 id="矩阵的定义"><a href="#矩阵的定义" class="headerlink" title="矩阵的定义"></a>矩阵的定义</h2><p>矩阵（Matrix），就是有m x n个标量组成的长方形数组，通常用方括号在左右两侧围住这些数字，大概像这样：</p><p><img src="/UnityShadersBook03/img_27.png" alt></p><p>有些资料也会用圆括号或花括号，其实都一样的。</p><p>矩阵有行、列之分，上图的数组就是三行四列。以3x3矩阵为例，它可以写成：</p><p><img src="/UnityShadersBook03/img_28.png" alt></p><p>mij表示这个元素在矩阵M的第i行、第j列。</p><h2 id="和矢量联系起来"><a href="#和矢量联系起来" class="headerlink" title="和矢量联系起来"></a>和矢量联系起来</h2><p>矢量，我们通常写成：<strong>a</strong> = (x, y, z)，可以看出矢量与矩阵一样，也是个数组。将矢量按照矩阵的写法，可以看成是<code>n x 1</code>的列矩阵或<code>1 x n</code>的行矩阵，n对应矢量的维度。</p><p>以矢量<strong>v</strong> = (3, 8, 6)举例，写成行矩阵：<br><code>[3, 8, 6]</code></p><p>写成列矩阵：</p><p><img src="/UnityShadersBook03/img_29.png" alt></p><p>为什么要和矢量联系起来？因为Shader中经常会将法线（矢量）进行坐标变换，而坐标变换是矩阵的几何意义，所以需要运用矩阵的运算来将法线从模型空间转变成世界空间。（后续会学到）</p><h2 id="矩阵运算"><a href="#矩阵运算" class="headerlink" title="矩阵运算"></a>矩阵运算</h2><h3 id="矩阵和标量的乘法"><a href="#矩阵和标量的乘法" class="headerlink" title="矩阵和标量的乘法"></a>矩阵和标量的乘法</h3><p>与矢量类似，矩阵和标量相乘后，结果仍然是一个矩阵。公式如下：</p><p><img src="/UnityShadersBook03/img_30.png" alt></p><h3 id="矩阵和矩阵的乘法"><a href="#矩阵和矩阵的乘法" class="headerlink" title="矩阵和矩阵的乘法"></a>矩阵和矩阵的乘法</h3><p>矩阵和矩阵相乘后，结果也是矩阵。新的矩阵的维度与两个原矩阵的维度有关。一个<code>rxn</code>的矩阵A和一个<code>nxc</code>的矩阵B相乘后，得到的结果AB是一个<code>rxc</code>大小的矩阵。需要注意，<strong>第一个矩阵的列数必须和第二个矩阵的行数相等，才能相乘</strong>。</p><p>比如：矩阵A的维度是<code>4x3</code>，矩阵B的维度是<code>3x6</code>，则AB的维度是<code>4x6</code>。</p><p>矩阵乘法的表达式：<br>假设有<code>rxn</code>的矩阵A和<code>nxc</code>的矩阵B，相乘后得到一个<code>rxc</code>的矩阵C = AB，那么C中的每个元素Cij等于A的第i行所对应的矢量和B的第j列所对应的矢量进行点乘的结果，即：</p><p><img src="/UnityShadersBook03/img_31.png" alt></p><p>简单解释为：<br>对于每个元素c<sub>ij</sub>，找到A中的第<code>i</code>行和B中的第<code>j</code>列，把他们对应的元素相乘后再加起来，这个和就是c<sub>ij</sub>。</p><p><img src="/UnityShadersBook03/img_32.png" alt></p><p>性质一：<br>矩阵乘法不满足交换律：<code>AB ≠ BA</code></p><p>性质二：<br>矩阵乘法满足结合律：<code>(AB)C = A(BC)</code>、<code>ABCDE = ((A(BC))D)E = (AB)(CD)E</code></p><h3 id="特殊的矩阵"><a href="#特殊的矩阵" class="headerlink" title="特殊的矩阵"></a>特殊的矩阵</h3><h4 id="方块矩阵"><a href="#方块矩阵" class="headerlink" title="方块矩阵"></a>方块矩阵</h4><p>方块矩阵，简称方阵。指行数和列数相等的矩阵，比如：<code>3x3</code>、<code>4x4</code>的矩阵。</p><p>方块矩阵独有的：<strong>对角元素</strong>——行号和列号相等的元素。只有对角元素非0的矩阵叫<strong>对角矩阵</strong>。</p><h4 id="单位矩阵"><a href="#单位矩阵" class="headerlink" title="单位矩阵"></a>单位矩阵</h4><p>对角元素都为1的对角矩阵，叫做单位矩阵，用I<sub>n</sub>表示，比如：</p><p><img src="/UnityShadersBook03/img_33.png" alt></p><p>单位矩阵特性：任何矩阵和它相乘的结果还是原来的矩阵。相当于标量中1的地位。<br><code>MI = IM = M</code></p><h4 id="转置矩阵"><a href="#转置矩阵" class="headerlink" title="转置矩阵"></a>转置矩阵</h4><p>转置矩阵实际是对原矩阵的一种运算，即转置运算。一个<code>rxc</code>的矩阵M，其转置表示成M<sup>T</sup>，是一个<code>cxr</code>的矩阵，本质是原来的矩阵行、列对换。</p><p><img src="/UnityShadersBook03/img_34.png" alt></p><p>性质一：<br>矩阵转置的转置等于原矩阵。<br>(M<sup>T</sup>)<sup>T</sup> = M</p><p>性质二：<br>矩阵串联的转置，等于反向串联各个矩阵的转置。<br>(AB)<sup>T</sup> = B<sup>T</sup>A<sup>T</sup></p><h4 id="逆矩阵"><a href="#逆矩阵" class="headerlink" title="逆矩阵"></a>逆矩阵</h4><p>只有方阵才有逆矩阵，逆矩阵表示为M<sup>-1</sup>。一个矩阵与它的逆矩阵相乘，结果是一个单位矩阵：<br>MM<sup>-1</sup> = M<sup>-1</sup>M = I<br>有点标量里面倒数的味道。</p><p>不是所有方阵都有对应逆矩阵，比如：所有元素都为0的矩阵。<br>如果一个矩阵有对应的逆矩阵，则它是<strong>可逆的</strong>或<strong>非奇异性的</strong>；<br>相反，则它是<strong>不可逆的</strong>或<strong>奇异性的</strong>。</p><p>判断矩阵是否可逆：<br>矩阵的<strong>行列式</strong>不为0，则它是可逆的。<br>参考视频链接：<a href="https://www.bilibili.com/video/BV1aW411Q7x1?p=2" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1aW411Q7x1?p=2</a></p><p>性质一：<br>逆矩阵的逆矩阵是原矩阵本身。<br>(M<sup>-1</sup>)<sup>-1</sup> = M</p><p>性质二：<br>单位矩阵的逆矩阵是它本身。<br>I<sup>-1</sup> = I</p><p>性质三：<br>转置矩阵的逆矩阵是逆矩阵的转置。<br>(M<sup>T</sup>)<sup>-1</sup> = (M<sup>-1</sup>)<sup>T</sup></p><p>性质四：<br>矩阵串联相乘后的逆矩阵等于反串联各个矩阵的逆矩阵。<br>(AB)<sup>-1</sup> = B<sup>-1</sup>A<sup>-1</sup><br>(ABCD)<sup>-1</sup> = D<sup>-1</sup>C<sup>-1</sup>B<sup>-1</sup>A<sup>-1</sup></p><p>矩阵的几何意义是<strong>变换</strong>，逆矩阵表示还原这个变换，或这个变换的反向变换。<br>使用变化矩阵M对矢量<strong>v</strong>进行一次变换，然后再使用逆矩阵M<sup>-1</sup>进行一次变换，会得到原来的矢量v。<br>M<sup>-1</sup>(M<strong>v</strong>) = (M<sup>-1</sup>M)<strong>v</strong> = I<strong>v</strong> = <strong>v</strong></p><h4 id="正交矩阵"><a href="#正交矩阵" class="headerlink" title="正交矩阵"></a>正交矩阵</h4><p>正交矩阵是特殊的方阵。一个方阵M和它的转置矩阵的乘积是单位矩阵，则这个矩阵是正交的。<br>MM<sup>T</sup> = M<sup>T</sup>M = I</p><p>有逆矩阵的性质MM<sup>-1</sup> = M<sup>-1</sup>M = I可以得出正交矩阵的逆矩阵是它的转置矩阵：<br>M<sup>T</sup> = M<sup>-1</sup></p><p>正交矩阵可以用转置矩阵的运算代替逆矩阵的运算，因为逆矩阵计算更复杂。</p><p>怎样判定一个矩阵是正交矩阵？来看一下它有哪些定义。</p><p>因为：</p><p><img src="/UnityShadersBook03/img_35.png" alt></p><p>所以：</p><p><img src="/UnityShadersBook03/img_36.png" alt></p><p>于是可以得到以下结论：</p><ul><li>矩阵的每一行，即c<sub>1</sub>、c<sub>2</sub>、c<sub>3</sub>是单位矢量；（因为他们与自己的点积是1）</li><li>矩阵的每一行，即c<sub>1</sub>、c<sub>2</sub>、c<sub>3</sub>之间相互垂直；（因为他们的点积是0）</li><li>上述两条，对矩阵的每一列同样适用；（因为正交矩阵的转置通用是正交矩阵）</li></ul><h3 id="行矩阵还是列矩阵"><a href="#行矩阵还是列矩阵" class="headerlink" title="行矩阵还是列矩阵"></a>行矩阵还是列矩阵</h3><p>一个矢量（比如：平行光的方向、表面发现方向），既可以写成行矩阵的形式，也可以写成列矩阵的形式，但是当它和矩阵相乘时，使用行矩阵还是列矩阵对其乘法的书写次序和结果值是有影响的。</p><p>假设有一个矢量<strong>v</strong> = (x, y, z)，写成行矩阵是：<strong>v</strong> = [x y z]，写成列矩阵是：<strong>v</strong> = [x y z]<sup>T</sup>（这里使用转置符号表示列矩阵的写法，纯粹为了排版）。另外有一个矩阵M：</p><p><img src="/UnityShadersBook03/img_37.png" alt></p><p>当M和行矩阵相乘时，写法为：<br><strong>v</strong>M = [xm<sub>11</sub>+ym<sub>21</sub>+zm<sub>31</sub>   xm<sub>12</sub>+ym<sub>22</sub>+zm<sub>32</sub>   xm<sub>13</sub>+ym<sub>23</sub>+zm<sub>33</sub>]</p><p>当M和列矩阵相乘时，写法为：</p><p><img src="/UnityShadersBook03/img_38.png" alt></p><p>可以看到两者相乘的书写次序和结果里面元素也是不一样的。</p><p>Unity中通常把矢量当做列矩阵，所以相乘时，矢量是放在矩阵的右侧的，且阅读顺序也是从右到左。例如：<br>CBA<strong>v</strong> = (C(B(A<strong>v</strong>)))<br>表示先对<strong>v</strong>进行A矩阵变换，再进行B矩阵变换，最后进行C矩阵变换。</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/UnityShadersBook03/#disqus_thread</comments>
    </item>
    
    <item>
      <title>《Unity Shader入门精要》笔记（二）</title>
      <link>http://wjnovember.github.io/UnityShadersBook02/</link>
      <guid>http://wjnovember.github.io/UnityShadersBook02/</guid>
      <pubDate>Sat, 13 Nov 2021 04:49:44 GMT</pubDate>
      <description>
      
        
        
          &lt;h1 id=&quot;材质和Unity-Shader&quot;&gt;&lt;a href=&quot;#材质和Unity-Shader&quot; class=&quot;headerlink&quot; title=&quot;材质和Unity Shader&quot;&gt;&lt;/a&gt;材质和Unity Shader&lt;/h1&gt;&lt;p&gt;Unity Shader定义了渲染所
        
      
      </description>
      
      <content:encoded><![CDATA[<h1 id="材质和Unity-Shader"><a href="#材质和Unity-Shader" class="headerlink" title="材质和Unity Shader"></a>材质和Unity Shader</h1><p>Unity Shader定义了渲染所需的各种代码、属性和指令；材质则允许我们调整这些属性，并将其最终赋给相应的模型。<br>通俗讲就是：Shader制定了渲染的规则，材质是让这个物体在这个规则下调整渲染效果。</p><p>材质的创建：<br>方法1：Unity菜单中选择Assets-&gt;Create-&gt;Material；<br>方法2：Project视图中右击-&gt;Create-&gt;Material；<br>Unity新建的材质，默认使用Standard Shader。</p><p>材质结合GameObject的<code>Mesh</code>或<code>Particle Systems</code>组件来工作：<br><img src="/UnityShadersBook02/img_01.png" alt></p><p>材质Inspector窗口：<br><img src="/UnityShadersBook02/img_02.png" alt></p><p>Unity Shader的创建：<br>方法1：Unity菜单中选择Assets-&gt;Create-&gt;Shader；<br>方法2：Project视图中右击-&gt;Create-&gt;Shader；</p><p>Unity提供了4种Unity Shader模板：</p><ul><li>Standard Surface Shader<br>产生一个包含标准光照模型的表面着色器。</li><li>Unlit Shader<br>产生一个不包含光照（但包含雾效）的基本的定点/片元着色器。</li><li>Image Effect Shader<br>屏幕后处理的基本模板。</li><li>Compute Shader<br>特殊的Shader文件，利用GPU的并行性进行一些与常规渲染流水线无关的计算。</li></ul><p>前期我们使用比较多的是<strong>Unlit Shader</strong>。</p><h1 id="Unity-Shader的基础：ShaderLab"><a href="#Unity-Shader的基础：ShaderLab" class="headerlink" title="Unity Shader的基础：ShaderLab"></a>Unity Shader的基础：ShaderLab</h1><p>Unity Shader是Unity为开发者提供的高层级的渲染抽象层，为我们自定义渲染效果提供遍历，防止和很多文件、设置打交道。</p><p><img src="/UnityShadersBook02/img_03.png" alt></p><p>ShaderLab是编写Unity Shader的一种说明性语言，所有Unity Shader都是用ShaderLab编写的。它使用一些嵌套在花括号内部的<strong>语义（syntax）</strong>来描述Unity Shader文件的结构。</p><h1 id="Unity-Shader结构"><a href="#Unity-Shader结构" class="headerlink" title="Unity Shader结构"></a>Unity Shader结构</h1><p>ShaderLab的语义有：Properties、SubShader、Fallback等，这些语义定义了Unity Shader的结构。</p><p>Unity Shader基础结构：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"ShaderName"</span> &#123;</span><br><span class="line">    Properties &#123;</span><br><span class="line">        <span class="comment">// 属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SubShader &#123;</span><br><span class="line">        <span class="comment">// 显卡A使用的子着色器</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SubShader &#123;</span><br><span class="line">        <span class="comment">// 显卡B使用的子着色器</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Fallback <span class="string">"VertexLit"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="给Shader命名"><a href="#给Shader命名" class="headerlink" title="给Shader命名"></a>给Shader命名</h2><p>通过<code>Shader</code>语义指定当前Unity Shader的名字，名字由字符串定义，字符串内可添加斜杠（”/“）对Shader进行分组管理：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"Custom/MyShader"</span> &#123; &#125;</span><br></pre></td></tr></table></figure><p>Shader命名后，<strong>材质</strong>面板上可以找到当前Shader的位置：Shader-&gt;Custom-&gt;MyShader：<br><img src="/UnityShadersBook02/img_04.png" alt></p><h2 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h2><p>Properties语义块包含一系列属性（Property），这些属性是材质和Unity Shader连通的桥梁。好比：C#脚本里定义一些public变量，在Inspector面板上对应的脚本组件里可以看见并设置这些变量。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Properties &#123;</span><br><span class="line">    Name (<span class="string">"display name"</span>, PropertyType) = DefaultValue</span><br><span class="line">    Name (<span class="string">"display name"</span>, PropertyType) = DefaultValue</span><br><span class="line">    <span class="comment">// 更多属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Name</code>是Shader访问该属性的变量名，通常以一个下划线开始，比如：_Color、_MainTex等。<br><code>display name</code>是Shader在材质面板上看到的属性名称，没有严格的命名规范，闻其名、知其意即可。<br><code>PropertyType</code>是当前属性的类型，Unity Shader的属性类型，可以是：颜色、数值、范围值、向量、纹理等。<br><code>DefaultValue</code>是当前属性的默认值，不同的PropertyType，其默认值的结构也不同。</p><p><img src="/UnityShadersBook02/img_05.png" alt></p><ul><li>Int、Float、Range的默认值是单独的数字；</li><li>Color、Vector的默认值是圆括号包围的一个四维向量；</li><li>2D、Cube、3D的默认值是字符串+换括号，字符串可以是空的，也可以是内置的纹理名称，如：”white”、”black”、”bump”等；花括号以前版本用来指定纹理属性的，如：TexGen CubeReflect、TexGen CubeNormal等固定管线坐标的生成，目前基本弃用，所以花括号里内容一般为空；</li></ul><p>属性代码例子：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"Custom/ShaderLabProperties"</span> &#123;</span><br><span class="line">    Properties &#123;</span><br><span class="line">        <span class="comment">// Numbers and Sliders</span></span><br><span class="line">        _Int (<span class="string">"Int"</span>, Int) = <span class="number">2</span></span><br><span class="line">        _Float (<span class="string">"Float"</span>, Float) = <span class="number">1.5</span></span><br><span class="line">        _Range (<span class="string">"Range"</span>, Range(<span class="number">0.0</span>, <span class="number">5.0</span>)) = <span class="number">3.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Colors and Vectors</span></span><br><span class="line">        _Color (<span class="string">"Color"</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        _Vector = (<span class="string">"Vector"</span>, Vector) = (<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Textures</span></span><br><span class="line">        _2D (<span class="string">"2D"</span>, <span class="number">2</span>D) = <span class="string">""</span> &#123;&#125;</span><br><span class="line">        _Cube (<span class="string">"Cube"</span>, Cube) = <span class="string">"white"</span> &#123;&#125;</span><br><span class="line">        _3D (<span class="string">"3D"</span>, <span class="number">3</span>D) = <span class="string">"black"</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应材质面板的显示：<br><img src="/UnityShadersBook02/img_06.png" alt></p><h2 id="SubShader"><a href="#SubShader" class="headerlink" title="SubShader"></a>SubShader</h2><p>每个Unity Shader里至少包含一个SubShader语义块，可以有多个SubShader。<br>Unity Shader可以定义不同的SubShader来适应不同平台的显卡，如：高性能显卡使用精度更大的变量、更多的渲染指令，低性能显卡使用精度较低的变量。</p><p>SubShader语义块：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SubShader &#123;</span><br><span class="line">    <span class="comment">// 可选的</span></span><br><span class="line">    [Tags]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可选的</span></span><br><span class="line">    [RenderSetup]</span><br><span class="line">    </span><br><span class="line">    Pass &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Other Passes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SubShader中可定义很多Pass和一些可选的状态（RenderSetup）和标签（Tags）。<br>每个Pass定义一次完整的渲染流程，Pass数量越多，渲染性能消耗越大。<br>状态和标签也可以在Pass中定义，但Pass中使用的标签是特定的，在SubShader中定义的状态会应用于里面的所有Pass。</p><p>常见渲染状态：</p><ul><li>Cull<br>Cull Back | Front | Off<br>设置剔除模式：剔除背面/正面/关闭剔除。</li><li>ZTest<br>ZTest Less Greater | LEqual | GEqual | Equal | NotEqual | Always<br>深度测试函数比较配置。</li><li>ZWrite<br>ZWrite On | Off<br>深度写入开启/关闭。</li><li>Blend<br>Blend SrcFactor DstFactor<br>开启混合模式并设置混合因子。</li></ul><p>配置在SubShader，则所有Pass都生效；<br>配置在Pass，则只有当前Pass生效。</p><p>SubShader的标签：</p><ul><li>Queue<br>控制渲染顺序，指定当前SubShader渲染的物体在哪个渲染队列。</li><li>RenderType<br>对着色器进行分类，比如：不透明的着色器、透明的着色器。可被用于着色器替换功能。</li><li>DisableBatching<br>控制是否禁用批处理，涉及模型空间计算时，需要禁用，因为批处理会让模型坐标丢失，比如：顶点动画。</li><li>ForceNoShadowCasting<br>控制当前SubShader渲染的物体是否会向其他物体投射阴影。</li><li>IgnoreProjector<br>控制当前SubShader渲染的物体是否不接受其他物体投射的阴影，通常用于半透明物体。</li><li>CanUseSpriteAtlas<br>若当前SubShader用于精灵时，将标签设置为“False”。</li><li>PreviewType<br>控制材质面板上显示的预览样式，默认球形，此外还可以设置为“Plane”、“SkyBox”。</li></ul><p>写法例子：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tags &#123;<span class="string">"Queue"</span> = <span class="string">"Transparent"</span> <span class="string">"RenderType"</span> = <span class="string">"Opaque"</span> <span class="string">"DisableBatching"</span> = <span class="string">"True"</span>&#125;</span><br></pre></td></tr></table></figure><p>Pass的标签：</p><ul><li>LightMode<br>定义当前Pass在Unity的渲染流水线中的角色，比如：“ForwardBase”、“ForwardAdd”。</li><li>RequireOptions<br>用于指定当满足条件时才渲染该Pass，它的值是一个由空格分隔的字符串，目前Unity支持的选项有：“SoftVegetation”。</li></ul><p>写法例子：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tags &#123;<span class="string">"LightMode"</span> = <span class="string">"ForwardBase"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="Pass语义块"><a href="#Pass语义块" class="headerlink" title="Pass语义块"></a>Pass语义块</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">    [Name]</span><br><span class="line">    [Tags]</span><br><span class="line">    [RenderSetup]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Other code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>【Name】通过Pass的名称，可以使用ShaderLab的UsePass命令来直接使用其他Unity Shader中的Pass，提高Shader代码复用性。如：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsePass <span class="string">"MyShader/MYPASSNAME"</span></span><br></pre></td></tr></table></figure><p>Unity内部会将所有Pass名称转为大写。</p><p>【Tags】SubShader的Tags同样适用于Pass，但Pass的Tags不能用于SubShader。</p><p>一些特殊的Pass：</p><ul><li>UsePass<br>使用该指令，复用其他的Pass。</li><li>GrabPass<br>该Pass负责抓取屏幕并将结果存储在一张纹理中，以用于后续的Pass处理。</li></ul><h2 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Fallback <span class="string">"Name"</span></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">Fallback Off</span><br></pre></td></tr></table></figure><p>若当前Shader的所有SubShader都不能在当前显卡上运行，则使用Fallback定义的Shader；若Fallback定义为Off，则没有后备的Shader支持，物体将显示为洋红色。</p><h1 id="Unity-Shader的形式"><a href="#Unity-Shader的形式" class="headerlink" title="Unity Shader的形式"></a>Unity Shader的形式</h1><p>Unity Shader的形式有：表面着色器、顶点着色器、片元着色器、固定函数着色器。</p><h2 id="表面着色器"><a href="#表面着色器" class="headerlink" title="表面着色器"></a>表面着色器</h2><p>本质是顶点/片元着色器，是Unity内置的更高一层的抽象，Unity内部处理了很多光照细节，代码量更少，但渲染代价比较大。</p><p>表面着色器代码使用<code>CG/HLSL</code>编写，写在<code>CGPROGRAM</code>和<code>ENDCG</code>之间。</p><p>表面着色器的代码定义在SubShader语句块中，案例代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"Custom/Simple Surface Shader"</span> &#123;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Tags &#123;<span class="string">"RenderType"</span> = <span class="string">"Opaque"</span>&#125;</span><br><span class="line"></span><br><span class="line">        CGPROGRAM</span><br><span class="line">            </span><br><span class="line">        #pragma surface surf Lambert</span><br><span class="line"></span><br><span class="line">        struct Input &#123;</span><br><span class="line">            float4 color : COLOR;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">surf</span><span class="params">(Input IN, input SurfaceOutput o)</span> </span>&#123;</span><br><span class="line">            o.Albedo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        ENDCG</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Fallback <span class="string">"Diffuse"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="顶点-片元着色器"><a href="#顶点-片元着色器" class="headerlink" title="顶点/片元着色器"></a>顶点/片元着色器</h2><p>定点着色器、片元着色器使用<code>CG/HLSL</code>编写，写在<code>CGPROGRAM</code>和<code>ENDCG</code>之间。<br>顶点/片元着色器的代码定义在Pass语句块中，案例代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"Custom/Simple VertexFragment Shader"</span> &#123;</span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line">            CGPROGRAM</span><br><span class="line">                </span><br><span class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> vertex vert</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> fragment frag</span></span><br><span class="line">            </span><br><span class="line">            float4 vert(float4 v : POSITION) : SV_POSITION &#123;</span><br><span class="line">                <span class="keyword">return</span> mul(UNITY_MATRIX_MVP, v);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            fixed4 frag() : SV_Target &#123;</span><br><span class="line">                <span class="keyword">return</span> fixed4(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="固定函数着色器"><a href="#固定函数着色器" class="headerlink" title="固定函数着色器"></a>固定函数着色器</h2><p>固定函数着色器不像前两类着色器一样，它不支持可编程，用于比较老的，不支持可编程渲染管线着色器的设备中，目前基本被淘汰。案例代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">"Tutorial/Basic"</span> &#123;</span><br><span class="line">    Properties &#123;</span><br><span class="line">        _Color (<span class="string">"Main Color"</span>, Color) = (<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line">            Material &#123;</span><br><span class="line">                Diffuse [_Color]</span><br><span class="line">            &#125;</span><br><span class="line">            Lighting On</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上面代码中可以看到，固定函数着色器仅支持使用ShaderLab的语法配置一些渲染命令，不支持使用<code>CG/HLSL</code>语言编写比较复杂的代码逻辑。</p><p>如果需要跟各种光源打交道，建议使用表面着色器，但是需要留意移动平台的性能；<br>其他情况下，建议使用顶点/片元着色器；<br>若需要更多自定义的渲染效果，也建议使用顶点/片元着色器。</p><h1 id="Unity-Shader-真正的Shader"><a href="#Unity-Shader-真正的Shader" class="headerlink" title="Unity Shader != 真正的Shader"></a>Unity Shader != 真正的Shader</h1><p>Unity Shader实际指的是ShaderLab文件，以<code>.shader</code>作为后缀的文件。而ShaderLab是Unity对传统Shader的封装。传统的Shader需要编写冗长的代码来设置着色器的输入输出，需要处理很多的文件；而Unity中的Shader只需要处理一个ShaderLab文件就好。</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/UnityShadersBook02/#disqus_thread</comments>
    </item>
    
    <item>
      <title>游戏开发编码规范</title>
      <link>http://wjnovember.github.io/LuaCodeRule/</link>
      <guid>http://wjnovember.github.io/LuaCodeRule/</guid>
      <pubDate>Tue, 09 Nov 2021 15:31:52 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;最近梳理了下公司游戏开发的编码规范，考虑到平时开发主要以Lua语言为主，所以本文也以Lua代码作为案例，除了Lua语言自身的特性，其他规范思路其他语言亦可适用。&lt;br&gt;本文主要从命名规范、格式规范以及性能相关三个方面进行规范的说明，后续开发过程中若有新的规范制定，持续更新本
        
      
      </description>
      
      <content:encoded><![CDATA[<p>最近梳理了下公司游戏开发的编码规范，考虑到平时开发主要以Lua语言为主，所以本文也以Lua代码作为案例，除了Lua语言自身的特性，其他规范思路其他语言亦可适用。<br>本文主要从命名规范、格式规范以及性能相关三个方面进行规范的说明，后续开发过程中若有新的规范制定，持续更新本文内容。</p><h1 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h1><p>大规则：命名需做到“闻其名、知其意”，在不影响其表意的基础上精简命名长度。</p><h2 id="local变量命名"><a href="#local变量命名" class="headerlink" title="local变量命名"></a>local变量命名</h2><p>以“小驼峰命名法”作为命名规范，如：myKingdom、userInfo等。</p><p>若对视图层变量进行命名，可以“视图类型+表意”方式命名，可参考：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 确认按钮</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 描述文本</span></span><br><span class="line"><span class="keyword">local</span> lblDesc = V.createLabel()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 王国名称输入框</span></span><br><span class="line"><span class="keyword">local</span> editKingdomName = V.createInputBox()</span><br></pre></td></tr></table></figure><p>亦可以“表意+视图用处”方式命名，可参考：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 名字下方的背景图</span></span><br><span class="line"><span class="keyword">local</span> nameBg = lc.createSprite(<span class="string">"g_bg_01"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 资源区域</span></span><br><span class="line"><span class="keyword">local</span> resArea = lc.createNode(<span class="number">500</span>, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 奖励条目</span></span><br><span class="line"><span class="keyword">local</span> bonusItem = self:createItem(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天列表</span></span><br><span class="line"><span class="keyword">local</span> chatList = lcList.<span class="built_in">create</span>(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聊天面板</span></span><br><span class="line"><span class="keyword">local</span> chatPanel = ChatPanel.<span class="built_in">create</span>(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主要内容区域</span></span><br><span class="line"><span class="keyword">local</span> contentContainer = lc.createNode(...)</span><br></pre></td></tr></table></figure><p>为了和方法内局部变量做区分，全文件范围的local变量在上述规则基础上，以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"ChatForm"</span>, Form)</span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以下划线开始的文件范围局部变量的命名规范</span></span><br><span class="line"><span class="keyword">local</span> _animInterval = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _tabId = &#123;</span><br><span class="line">    world_chat = <span class="number">1</span>,</span><br><span class="line">    kingdom_chat = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:init</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="comment">-- 方法内局部变量命名，不以下划线开始</span></span><br><span class="line">    <span class="keyword">local</span> form = M.super.init(self, ...)</span><br><span class="line">    form:setTabId(_tabId.world_chat)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>table中的key，以小写字母+下划线命名，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">M.TabId = &#123;</span><br><span class="line">    world_chat    = <span class="number">1</span>,</span><br><span class="line">    kingdom_chat  = <span class="number">2</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有时为了简化书写、简化阅读，从成员变量中取视图变量，赋值给local变量的时候，命名可以简写为“视图用途”或“视图类型”，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- topArea简写为area</span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    area:setContentSize(...)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- btnAdd简写为btn</span></span><br><span class="line">    <span class="keyword">local</span> btn = area._btnAdd</span><br><span class="line">    btn:setLabel(...)</span><br><span class="line">    btn:setPosition(...)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 但是</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 当存在多个获取不同button的情况，建议使用全写（btnAdd、btnCancel）</span></span><br><span class="line">    <span class="comment">-- 因为相同命名时，代码位置调整可能导致逻辑错乱</span></span><br><span class="line">    <span class="keyword">local</span> btnAdd = area._btnAdd</span><br><span class="line">    btnAdd:setLabel(...)</span><br><span class="line">    btnAdd:setPosition(...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> btnCancel = area._btnCancel</span><br><span class="line">    btnCancel:setLabel(...)</span><br><span class="line">    btnCancel:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="成员变量命名"><a href="#成员变量命名" class="headerlink" title="成员变量命名"></a>成员变量命名</h2><p>lua中成员变量一般指存储在self里的变量，其命名规则为：在local变量命名规范基础上，以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> topArea = lc.createNode(...)</span><br><span class="line">lc.addChildToPos(self._form, topArea, lc.p(...))</span><br><span class="line"><span class="comment">-- 存储成员变量</span></span><br><span class="line">self._topArea = topArea</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton()</span><br><span class="line">lc.addChildToPos(topArea, btnConfirm, lc.p(...))</span><br><span class="line"><span class="comment">-- 存储成员变量</span></span><br><span class="line">self._btnConfirm = btnConfirm</span><br></pre></td></tr></table></figure><p>存在类里（比如：M类）的变量，其命名同样以下划线开始，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initDefines</span><span class="params">()</span></span></span><br><span class="line">    M._defs = &#123;...&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="方法命名"><a href="#方法命名" class="headerlink" title="方法命名"></a>方法命名</h2><p>方法的命名大小写规范，一般以小驼峰命名，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但是考虑到C#转Lua导致一些Unity内置方法名必须是大驼峰命名，为了保持一致，可以考虑项目中的所有方法以大驼峰方式命名，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"InfoPanel"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 内置方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Awake</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Start</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:OnEnable</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&lt;&lt;&lt;&lt;&lt; 自定义方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:UpdateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>方法命名格式，一般是“动词+名词”，可参考如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 创建某个组件或初始化某块区域，以create、init开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:createNode</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个按钮</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:createButton</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始化顶部区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 当这个方法里只要一个表示区域的变量，可以考虑简写，规则同“成员变量命名”的规则</span></span><br><span class="line">    <span class="comment">-- 比如这里局部变量写area，而非topArea</span></span><br><span class="line">    <span class="keyword">local</span> area = self:createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(...))</span><br><span class="line">    self._topArea = area</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnConfirm = self:createButton()</span><br><span class="line">    lc.addChildToPos(area, btnConfirm, lc.p(...))</span><br><span class="line">    area._btnConfirm = btnConfirm</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnCancel = self:createButton()</span><br><span class="line">    lc.addChildToPos(area, btnCancel, lc.p(...))</span><br><span class="line">    area._btnCancel = btnCancel</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以update开头作为视图刷新方法的开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新顶部的区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 更改、获取数值的方法分别以set、get开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置道具数量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:setItemNum</span><span class="params">(...)</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取道具数量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:getItemNum</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以is、can、should等作为返回布尔值的判断方法的开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断技能模块是否解锁</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:isUnlockSkill</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断玩家能否成为海盗</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:canBePirate</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断是否应该检查刷新该区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:shouldCheckUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--&gt;&gt;&gt;&gt;&gt; 以check作为开头，用于将判断方法和更新方法包起来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断并刷新顶部区域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self:shouldCheckUpdateTopArea() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h1 id="格式规范"><a href="#格式规范" class="headerlink" title="格式规范"></a>格式规范</h1><p>如果把一个代码文件想象成一个房间，房间里的东西应该是近似强迫症一样地整齐摆放好，而不是像杂货堆，这是本小节规范格式需要达到的效果——“整齐、清爽、不杂糅”。对于不艰涩的逻辑，全篇代码甚至可以一行注释都不加就能读懂，类似这样：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"OptionForm"</span>, Form)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:init</span><span class="params">()</span></span></span><br><span class="line">    self:initTopArea()</span><br><span class="line">    self:initBottomArea()</span><br><span class="line"></span><br><span class="line">    self:syncData(V.SyncFlag.init)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">    self._topArea = area</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblName = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblName, lc.p(x2, y2))</span><br><span class="line">    area._lblName = lblName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblDesc = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblDesc, lc.p(x3, y3))</span><br><span class="line">    area._lblDesc = lblDesc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">    self._midArea = area</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">    area._lblOption = lblOption</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">    lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">    area._btnConfirm = btnConfirm</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">    lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">    area._btnCancel = btnCancel</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:syncData</span><span class="params">(flag)</span></span></span><br><span class="line">    M.super.syncData(self, flag)</span><br><span class="line">  </span><br><span class="line">    self:updateData()</span><br><span class="line">    self:updateTopArea()</span><br><span class="line">    self:updateBottomArea()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateData</span><span class="params">()</span></span></span><br><span class="line">    self._data = P:getOptionData()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> lblName = area._lblName</span><br><span class="line">    <span class="keyword">local</span> user = data._user</span><br><span class="line">    lblName:setString(user._name)</span><br><span class="line">    lblName:setTextColor(user._isNpc <span class="keyword">and</span> V.Color.gray <span class="keyword">or</span> V.Color.white)</span><br><span class="line">  </span><br><span class="line">    area._lblDesc:setString(data._desc)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateBottomArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> lblOption = self._bottomArea._lblOption</span><br><span class="line">    lblOption:setString(self._data._option)</span><br><span class="line">    lblOption:setPosition(x1, y1)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onEnter</span><span class="params">()</span></span></span><br><span class="line">    M.super.onEnter(self)</span><br><span class="line">  </span><br><span class="line">    self:addListener(Event.Player.name_change, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onPlayerNameChange(evt._param) <span class="keyword">end</span>)</span><br><span class="line">    self:addListener(Event.Option.dirty, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onOptionDirty(evt._param) <span class="keyword">end</span>)</span><br><span class="line">    self:addListener(Event.Option.<span class="built_in">remove</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:hide() <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onPlayerNameChange</span><span class="params">(user)</span></span></span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> data._user._id ~= user._id <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onOptionDirty</span><span class="params">(option)</span></span></span><br><span class="line">    <span class="keyword">local</span> data = self._data</span><br><span class="line">    <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> data._optionId ~= option._id <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:syncData(V.SyncFlag.update)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onBtnConfirm</span><span class="params">()</span></span></span><br><span class="line">    self._data._user:setConfirmOption()</span><br><span class="line">  self:hide()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onBtnCancel</span><span class="params">()</span></span></span><br><span class="line">    self._data._user:setDenyOption()</span><br><span class="line">    self:hide()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="空格规范"><a href="#空格规范" class="headerlink" title="空格规范"></a>空格规范</h2><p>逗号后面留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm, btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm,btnCancel</span><br></pre></td></tr></table></figure><p>运算符、等号两边留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> a = b &gt; c <span class="keyword">and</span> b <span class="keyword">or</span> (c - b) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> a=b&gt;c <span class="keyword">and</span> b <span class="keyword">or</span> (c-b)*<span class="number">2</span></span><br></pre></td></tr></table></figure><p>小括号内侧不留空格，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> a = (b - c) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> a = ( b - c ) * <span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="条件、循环语句"><a href="#条件、循环语句" class="headerlink" title="条件、循环语句"></a>条件、循环语句</h3><p><code>if</code>语句块内侧，开始和结束不要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">if</span> data._id &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">if</span> data._id &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>if</code>语句块前留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> isVisible = (data._id &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line">lblName:setVisible(isVisible)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> isVisible = (data._id &gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line">lblName:setVisible(isVisible)</span><br><span class="line"><span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果<code>if</code>前面存在单独一行代码，且这行代码与判断逻辑本身存在密切关联，<code>if</code>前面可以不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line">self._lblDesc:setString(data._desc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>elseif</code>语句块前面留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>else</code>语句块是否留空行取决于前面的<code>if</code>或<code>elseif</code>。<br>如果前面是<code>elseif</code>，则<code>else</code>前面必留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    self._lblOtherName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> user = data._user</span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    self._lblNpcName:setString(user._name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> user._id == myId <span class="keyword">then</span></span><br><span class="line">    self._lblMyName:setString(user._name)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    self._lblOtherName:setString(user._name)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面是<code>if</code>，且<code>if</code>语句块是多行，则<code>else</code>前面必留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line">    lblName:setTextColor(V.Color.gray)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    lblName:setTextColor(V.Color.white)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line">    lblName:setTextColor(V.Color.gray)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    lblName:setTextColor(V.Color.white)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面<code>if</code>语句块是单行，且<code>else</code>语句块也是单行，则<code>else</code>前面可以不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果前面<code>if</code>语句块是单行，但<code>else</code>语句块是多行，则<code>else</code>前面需要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    self._lblNpcDesc:setString(data._npcDesc)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">local</span> lblName = self._lblName</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user._isNpc <span class="keyword">then</span></span><br><span class="line">    lblName:setString(data._npcName)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lblName:setString(data._playerName)</span><br><span class="line">    self._lblNpcDesc:setString(data._npcDesc)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>上面<code>else</code>留空行的规则可以简单理解为：只允许<code>if</code>和<code>else</code>里都只有一行代码时，可以不留空行，其他情况均需要留空行。</p><p><code>while</code>、<code>do ... while</code>、<code>for</code>循环语义块前面留空行规则与<code>if</code>相同。</p><h3 id="方法定义"><a href="#方法定义" class="headerlink" title="方法定义"></a>方法定义</h3><p>每个定义的方法之间需要留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initBottomArea</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>方法定义内部，开始和结束不留空行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> lblTitle = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblTitle, lc.p(x2, y2))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:initTopArea</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">    lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> lblTitle = V.createLabel()</span><br><span class="line">    lc.addChildToPos(area, lblTitle, lc.p(x2, y2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="视图的创建与刷新"><a href="#视图的创建与刷新" class="headerlink" title="视图的创建与刷新"></a>视图的创建与刷新</h3><p>不同组件的创建、刷新逻辑之间以空行分隔，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">self._midArea = area</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">area._btnCancel = btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例1</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">self._midArea = area</span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line">area._btnCancel = btnCancel</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例2</span></span><br><span class="line"><span class="keyword">local</span> area = lc.createNode()</span><br><span class="line"><span class="keyword">local</span> lblOption = V.createLabel()</span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnConfirm() <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">local</span> btnCancel = V.createButton(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:onBtnCancel() <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">lc.addChildToPos(self._form, area, lc.p(x1, y1))</span><br><span class="line">lc.addChildToPos(area, lblOption, lc.p(x2, y2))</span><br><span class="line">lc.addChildToPos(area, btnConfirm, lc.p(x3, y3))</span><br><span class="line">lc.addChildToPos(area, btnCancel, lc.p(x4, y4))</span><br><span class="line"></span><br><span class="line">self._midArea = area</span><br><span class="line">area._lblOption = lblOption</span><br><span class="line">area._btnConfirm = btnConfirm</span><br><span class="line">area._btnCancel = btnCancel</span><br></pre></td></tr></table></figure><p>上述代码，反例2虽然看起来也很整齐，但是一旦涉及相关代码删除，或是添加新的组件创建代码，就需要上下移动光标到指定位置修改3个地方代码，且我们没法保证所有的节点创建只有<code>create</code>、<code>lc.addChildToPos</code>和<code>self._xxx = xxx</code>三个部分，所有节点没法做到统一，为了方便维护，还是建议不同的组件以空行分开。</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>上述规则没有提及的部分，暂时没有硬性规定，但是在书写的过程中，还是需要我们凭借<strong>语感</strong>来判定是否需要用空行分开，何为语感：<br>就是当我写了一坨很厚的代码，review起来感觉有点费力时，用空行将其分开后，再看这坨代码，感觉舒服多了，这就是语感。</p><h2 id="合并行规范"><a href="#合并行规范" class="headerlink" title="合并行规范"></a>合并行规范</h2><h3 id="local变量声明"><a href="#local变量声明" class="headerlink" title="local变量声明"></a>local变量声明</h3><p>有时我们需要在一开始声明并赋值多个local变量，但是这些变量存在着一定关联，可以将多个变量合并为一行：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 多行声明local变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateActivity</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 分多行声明</span></span><br><span class="line">    <span class="keyword">local</span> btnActivity = self._btnActivity</span><br><span class="line">    <span class="keyword">local</span> btnWelfare = self._btnWelfare</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> isVisible = self:isVisible()</span><br><span class="line">    btnActivity:setVisible(isVisible)</span><br><span class="line">    btnWelfare:setVisible(isVisible)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 分多行声明</span></span><br><span class="line">    <span class="keyword">local</span> data = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> rawData = P._playerActivity:getData()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = rawData[i]</span><br><span class="line">        <span class="keyword">if</span> self:isValid() <span class="keyword">then</span></span><br><span class="line">            data[#data + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单行声明local变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateActivity</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 单行声明</span></span><br><span class="line">    <span class="keyword">local</span> btnActivity, btnWelfare = self._btnActivity, self._btnWelfare</span><br><span class="line">    <span class="keyword">local</span> isVisible = self:isVisible()</span><br><span class="line"></span><br><span class="line">    btnActivity:setVisible(isVisible)</span><br><span class="line">    btnWelfare:setVisible(isVisible)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isVisible <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 单行声明</span></span><br><span class="line">    <span class="keyword">local</span> data, rawData = &#123;&#125;, P._playerActivity:getData()</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = rawData[i]</span><br><span class="line">        <span class="keyword">if</span> self:isValid() <span class="keyword">then</span></span><br><span class="line">            data[#data + <span class="number">1</span>] = info</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h3><p>有时条件语句里面没有包含过多的逻辑代码，比如只有：<code>break</code>、<code>return</code>等，我们允许这些关键词和<code>if</code>条件判断放到同一行，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> area = self._topArea</span><br><span class="line">    <span class="keyword">if</span> area == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> rawData = P:getRawData()</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但是当<code>if</code>条件后跟着<code>elseif</code>、<code>else</code>时，不建议将<code>break</code>等关键字写在同一行，这样会让代码结构看起来很难看，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data[#data + <span class="number">1</span>] = rawData[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例1</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 这样代码看起来排布太密，有点窒息的感觉</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span> data[#data + <span class="number">1</span>] = rawData[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例2</span></span><br><span class="line"><span class="keyword">local</span> data, rawData =&#123;&#125;, P:getRawData()</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #rawData <span class="keyword">do</span></span><br><span class="line">    <span class="comment">-- 不建议一行代码里包含超过2个逻辑，且断点调试不太方便</span></span><br><span class="line">    <span class="keyword">if</span> rawData[i]._isNpc <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">else</span> data[#data + <span class="number">1</span>] = rawData[i] <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="缩进规范"><a href="#缩进规范" class="headerlink" title="缩进规范"></a>缩进规范</h2><p>大规则：所有的<code>Tab</code>由制表符改为4个空格。<br>VS Code里可设置，如下图：</p><p><img src="/LuaCodeRule/img_01.png" alt></p><p>之所以如此改，是考虑一份代码文件里，缩进有时用制表符，有时会用空格。而不同平台下，解析制表符得到的缩进和4个空格的缩进宽度是不一致的，所以干脆将<code>Tab</code>按键由制表符统一为4个空格。</p><p>基于此规则，下面提到的“缩进”表示“缩进4个空格”。</p><h3 id="长条件语句"><a href="#长条件语句" class="headerlink" title="长条件语句"></a>长条件语句</h3><p>我们经常会遇到<code>if</code>语句太长，超出一屏的情况，这时会考虑将if语句写成多行，而换行后的条件判断，建议以2个<strong>缩进</strong>书写，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单行if语句</span></span><br><span class="line"><span class="keyword">if</span> data._type ~= D.Type.world_chat <span class="keyword">and</span> data._type ~= D.Type.area_chat <span class="keyword">and</span> data._user._id ~= P._id <span class="keyword">and</span> data._content ~= <span class="string">""</span> <span class="keyword">then</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 改写成多行if语句</span></span><br><span class="line"><span class="keyword">if</span> data._type ~= D.Type.world_chat <span class="keyword">and</span> data._type ~= D.Type.area_chat</span><br><span class="line">        <span class="keyword">and</span> data._user._id ~= P._id <span class="keyword">and</span> data._content ~= <span class="string">""</span> <span class="keyword">then</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>两个缩进的好处是：明显与<code>if</code>语句里的逻辑代码区分开，很容易知晓这个缩进是<code>if</code>条件判断。</p><h3 id="方法作为参数传入"><a href="#方法作为参数传入" class="headerlink" title="方法作为参数传入"></a>方法作为参数传入</h3><p>比如按钮的创建封装，会经常把回调方法传进去，而调用这个封装方法时，会传入回调方法，可以有这么几种写法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按钮的创建封装方法定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">V.createButton</span><span class="params">(bgName, callback)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用这个封装方法，对于回调方法的传入，有诸多写法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考1：方法主体不做额外缩进</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> ...</span><br><span class="line"><span class="keyword">end</span>, btnW, btnH)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考2：方法主体缩进2个单位（8个空格）</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> ...</span><br><span class="line">        <span class="keyword">end</span>, btnW, btnH)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 参考3：function关键词换行缩进2个单位（8个空格），方法主体与function缩进齐平</span></span><br><span class="line"><span class="keyword">local</span> btnConfirm = V.createButton(<span class="string">"g_bg_01"</span>,</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> ...</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        btnW,</span><br><span class="line">        btnH)</span><br></pre></td></tr></table></figure><p>其他代码逻辑走传统缩进规则即可。</p><h2 id="提前return代替嵌套"><a href="#提前return代替嵌套" class="headerlink" title="提前return代替嵌套"></a>提前return代替嵌套</h2><p>有时因为逻辑需要，会涉及到很多的if条件嵌套，针对这种情况，建议走<code>not</code>条件，提前return，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 嵌套写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> cond1() <span class="keyword">then</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> cond2() <span class="keyword">then</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> cond3() <span class="keyword">then</span></span><br><span class="line">                self:updateTopArea()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提前return写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:checkUpdateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond1() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond2() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond3() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateTopArea()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这样的写法是不是更加优雅？</p><h1 id="性能相关"><a href="#性能相关" class="headerlink" title="性能相关"></a>性能相关</h1><p>性能优化是一款游戏上线后必做的事，但是性能瓶颈有很大程度是代码书写不规范导致的，因此有必要在这里提一提影响性能的代码书写。</p><h2 id="事件分发与接收"><a href="#事件分发与接收" class="headerlink" title="事件分发与接收"></a>事件分发与接收</h2><p>避免在循环中分发事件，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> params = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #data <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> info = data[i]</span><br><span class="line">    <span class="keyword">if</span> self:isValid(info) <span class="keyword">then</span></span><br><span class="line">        params[info._id] = info</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">lc.sendEvent(eventName, params)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> data = self._data</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> info = data[i]</span><br><span class="line">    <span class="keyword">if</span> cond() <span class="keyword">then</span></span><br><span class="line">        lc.sendEvent(eventName, info)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果可以预见有些事件会在同一帧分发多次，建议在收事件的地方用dirty延迟刷新代替立即刷新，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self._viewDirty = <span class="literal">true</span> <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> self._viewDirty <span class="keyword">then</span></span><br><span class="line">        self:updateView()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><p>事件接收的监听回调需要做好严格筛选、层层把关，防止出现不必要的刷新：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span></span> self:onEvent(evt._param) <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onEvent</span><span class="params">(param)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond1(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond2(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond3(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cond4(param) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    self:updateView()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><p>逻辑筛选一般没有视图刷新来得复杂。</p><p>能做局部刷新，尽量不要全局刷新：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateView</span><span class="params">()</span></span></span><br><span class="line">    self:updateArea1()</span><br><span class="line">    self:updateArea2()</span><br><span class="line">    self:updateArea3()</span><br><span class="line">    self:updateArea4()</span><br><span class="line">    self:updateArea5()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    self:updateArea3()</span><br><span class="line">    self:updateArea5()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line">self:addListener(eventName, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self:updateView() <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><h2 id="频繁调用的方法需要格外注意"><a href="#频繁调用的方法需要格外注意" class="headerlink" title="频繁调用的方法需要格外注意"></a>频繁调用的方法需要格外注意</h2><p>在定时器这类每帧都调用的回调方法中，避免做遍历逻辑，尤其是无效的遍历，如果实在无法规避遍历的坑，建议将数组遍历改为Map索引：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> target = map[targetId]</span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> target</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #array <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> array[i]._id == targetId <span class="keyword">then</span></span><br><span class="line">            target = array[i]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>避免在频繁调用的方法里做复杂的计算，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 之前做的一款2D游戏，客人消费后往地上扔银币</span></span><br><span class="line"><span class="comment">-- 客人可能会一次性扔3~10个银币</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在每帧都会调用的Update方法，在里面做模拟银币抛物线扔到地上的位置计算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:Update</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> progress = ...</span><br><span class="line">    <span class="keyword">local</span> pos = Vector3.zero</span><br><span class="line">    pos.x = startPos + spdX * progress</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> progress &lt; <span class="number">0.3</span> <span class="keyword">then</span></span><br><span class="line">        pos.y = startY + progress * <span class="number">0.3</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.3</span> <span class="keyword">and</span> progress &lt; <span class="number">0.5</span> <span class="keyword">then</span></span><br><span class="line">        pos.y = startY + (progress - <span class="number">0.3</span>) * <span class="number">0.2</span> * factor1</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.5</span> <span class="keyword">and</span> progress &lt; <span class="number">0.7</span> <span class="keyword">then</span></span><br><span class="line">       pos.y = startY + (<span class="number">0.7</span> - progress) * <span class="number">0.2</span> * factor2</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elseif</span> progress &gt;= <span class="number">0.7</span> <span class="keyword">then</span></span><br><span class="line">       pos.y = startY + (<span class="number">1</span> - progress) * factor3</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    object.transform.localPosition = pos</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后，改成用Spine代替实时位置计算</span></span><br></pre></td></tr></table></figure><p>引入缓存机制，避免做重复且结果不变的计算：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:onSchedule</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> isSupport = Buff.getVal(buffId) &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> isSupport <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- do something</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Buff.getVal</span><span class="params">(buffId)</span></span></span><br><span class="line">    <span class="keyword">if</span> cache[buffId] <span class="keyword">then</span> <span class="keyword">return</span> cache[buffId] <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    ...</span><br><span class="line">    cache[buffId] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例：没有缓存机制</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Buff.getVal</span><span class="params">(buffId)</span></span></span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">0</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="关于local变量和全局变量"><a href="#关于local变量和全局变量" class="headerlink" title="关于local变量和全局变量"></a>关于local变量和全局变量</h2><p>在Lua里，访问局部变量比访问全局变量的速度快，而Lua里全局变量使用较多的则是self变量以及全局类名。在平时的调用中，在一段代码块里，若出现使用self获取相同的变量超过2次（包含2次），建议将self变量先赋值给local变量，再调用，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> btnAct = self._btnAct</span><br><span class="line">    btnAct:setLabel(...)</span><br><span class="line">    btnAct:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:updateTopArea</span><span class="params">()</span></span></span><br><span class="line">    self._btnAct:setLabel(...)</span><br><span class="line">    self._btnAct:setPosition(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如果存在全局的类，调用多次，也建议先赋值给local变量，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WorldGrid是一个类，记录在全局变量里</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> WorldGrid = WorldGrid</span><br><span class="line"><span class="keyword">local</span> grids = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    grids[#grids + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">local</span> grids = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    grids[#grids + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(...)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>尤其不要在循环中使用多重索引，比如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正例</span></span><br><span class="line"><span class="keyword">local</span> WorldGrid = WorldGrid</span><br><span class="line"><span class="keyword">local</span> group = self._grids._group</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> gridData = WorldGrid.<span class="built_in">create</span>(rawData[i])</span><br><span class="line">    gridData._index = i</span><br><span class="line">    group[#group + <span class="number">1</span>] = gridData</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反例</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">200</span> <span class="keyword">do</span></span><br><span class="line">  self._grids._group[#self._grids._group + <span class="number">1</span>] = WorldGrid.<span class="built_in">create</span>(self._rawData[i])</span><br><span class="line">  self._grids._group[#self._grids._group]._index = i</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>本文内容至此，若有不正确之处，欢迎评论区留言指正！</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/LuaCodeRule/#disqus_thread</comments>
    </item>
    
    <item>
      <title>《Unity Shader入门精要》笔记（一）</title>
      <link>http://wjnovember.github.io/UnityShadersBook01/</link>
      <guid>http://wjnovember.github.io/UnityShadersBook01/</guid>
      <pubDate>Sun, 07 Nov 2021 08:29:58 GMT</pubDate>
      <description>
      
        
        
          &lt;h1 id=&quot;渲染流水线&quot;&gt;&lt;a href=&quot;#渲染流水线&quot; class=&quot;headerlink&quot; title=&quot;渲染流水线&quot;&gt;&lt;/a&gt;渲染流水线&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;渲染流水线&lt;/strong&gt;的工作任务是：将三维场景里的物体投到屏幕上，生成一张二维图像。&lt;br&gt;可
        
      
      </description>
      
      <content:encoded><![CDATA[<h1 id="渲染流水线"><a href="#渲染流水线" class="headerlink" title="渲染流水线"></a>渲染流水线</h1><p><strong>渲染流水线</strong>的工作任务是：将三维场景里的物体投到屏幕上，生成一张二维图像。<br>可分为三个阶段：<strong>应用阶段</strong>、<strong>几何阶段</strong>、<strong>光栅化阶段</strong>。</p><p><img src="/UnityShadersBook01/img_01.png" alt></p><ul><li><p><strong>应用阶段</strong><br>CPU负责的阶段，应用主导，开发者有绝对的控制权，主要有三个任务：</p><ul><li>准备好场景数据</li><li>不可见物体剔除，提高渲染性能</li><li>设置好每个模型的渲染状态，如：材质、纹理、Shader等</li></ul><p>该阶段最重要的输出是<strong>渲染图元</strong>，如：点、线、三角面等，会被传递到下一个有GPU负责的阶段——几何阶段。</p></li><li><p><strong>几何阶段</strong><br>GPU负责的阶段，与每个渲染图元打交道，将三维空间的顶点数据转换到屏幕空间中，再将转换后的数据交给下一个阶段——光栅化阶段处理。关键词：<strong>逐顶点</strong>。</p></li><li><p><strong>光栅化阶段</strong><br>GPU负责的阶段，从上一阶段接过图元在屏幕空间的数据，差值计算后，决定图元里哪些像素会被绘制到屏幕中、被绘制成什么颜色。关键词：<strong>逐像素</strong>。</p></li></ul><h1 id="CPU和GPU之间的通信"><a href="#CPU和GPU之间的通信" class="headerlink" title="CPU和GPU之间的通信"></a>CPU和GPU之间的通信</h1><p>应用阶段的三个阶段：</p><ul><li><strong>把数据加载到显存</strong><br>数据加载到显存后，RAM的数据就可以移除了。但从硬盘加载到RAM过程十分耗时，CPU依然要访问数据，所以有些RAM中的数据不会马上移除。</li></ul><p><img src="/UnityShadersBook01/img_02.png" alt></p><ul><li><strong>设置渲染状态</strong><br>这些状态定义了场景中的网格是怎么被渲染的。</li></ul><p><img src="/UnityShadersBook01/img_03.png" alt></p><ul><li><strong>调用Draw Call</strong><br>Draw Call就是CPU发起命令，告诉GPU去执行一个渲染过程。一次DC（Draw Call）会指向本次调用需要渲染的图源列表。</li></ul><h1 id="GPU流水线"><a href="#GPU流水线" class="headerlink" title="GPU流水线"></a>GPU流水线</h1><p>GPU从CPU那里拿到顶点数据后，经过<strong>几何阶段</strong>和<strong>光栅化阶段</strong>将场景里的物体绘制到屏幕中。</p><p><img src="/UnityShadersBook01/img_04.png" alt></p><ul><li><strong>几何阶段</strong><ul><li>顶点着色器<br>完全可编程，实现顶点的空间变换、顶点着色等功能。</li><li>曲面细分着色器<br>可选的着色器，用于细分图元。</li><li>几何着色器<br>可选的着色器，执行逐图元的着色操作，或者生产更多的图元。</li><li>裁剪<br>将不存在摄像机视野内的顶点裁掉，并剔除某些三角图元的面片；也可以通过指令控制裁剪三角图元的正面或背面。</li><li>屏幕映射<br>不可配置、不可编程，负责把每个图元的坐标转换到屏幕坐标系中。</li></ul></li><li><strong>光栅化阶段</strong><ul><li>三角形设置<br>固定函数的阶段。</li><li>三角形遍历<br>固定函数的阶段。</li><li>片元着色器<br>完全可编程，实现逐片元的着色操作。</li><li>逐片元操作<br>不可编程，但可配置性很高，负责执行很多重要操作，如：修改颜色、深度缓冲、进行混合等。</li></ul></li></ul><p>我们需要重点关注的是<strong>顶点着色器（Vertex Shader）</strong>和<strong>片元着色器（Fragment Shader）</strong>。</p><h2 id="顶点着色器"><a href="#顶点着色器" class="headerlink" title="顶点着色器"></a>顶点着色器</h2><p>顶点着色器需要完成工作主要有：<strong>坐标转换</strong>和<strong>逐顶点光照</strong>。</p><p><img src="/UnityShadersBook01/img_05.png" alt></p><p>坐标转换，将模型的顶点坐标从模型空间转换到其次裁剪空间。</p><p><img src="/UnityShadersBook01/img_06.png" alt></p><p>需要注意：<br>OpenGL中NDC的z分量范围是[-1, 1]<br>DirectX中NDC的z分量范围是[0, 1]</p><p>NDC，全称Normalized Device Coordinates，归一化的设备坐标。（后续会详细了解）</p><h2 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h2><p>一个图元和摄像机视野的关系有3种：</p><ul><li>完全在视野范围内<br>不裁剪，直接进入下一流水线阶段。</li><li>部分在视野范围内<br>进行裁剪后，进入下一流水线阶段。</li><li>完全在视野范围外<br>被剔除，不会进入下一流水线阶段。</li></ul><p><img src="/UnityShadersBook01/img_07.png" alt></p><h2 id="屏幕映射"><a href="#屏幕映射" class="headerlink" title="屏幕映射"></a>屏幕映射</h2><p>屏幕映射前，顶点的坐标仍然在三维坐标系下，屏幕映射的任务是将每个图元的x、y坐标转换到屏幕坐标系下。<br>屏幕坐标系和z坐标一起构成了<strong>窗口坐标系</strong>。</p><p>屏幕坐标系在OpenGL和DirectX之间的差异：</p><p><img src="/UnityShadersBook01/img_08.png" alt></p><h2 id="三角形设置"><a href="#三角形设置" class="headerlink" title="三角形设置"></a>三角形设置</h2><p>光栅化的第一个流水线阶段。<br>光栅化两个最重要的目标：</p><ul><li>计算每个图元（一般是三角形面片）覆盖了哪些像素</li><li>为这些像素计算颜色</li></ul><p>三角形设置是一个计算三角形网格表示数据的过程，提供三角形边界的表示方式，为下阶段三角形遍历做准备。</p><h2 id="三角形遍历"><a href="#三角形遍历" class="headerlink" title="三角形遍历"></a>三角形遍历</h2><p>遍历判断每个像素是否被一个三角网格覆盖，若覆盖，则生成一个<strong>片元（fragment）</strong>，这个过程也叫扫描变换。片元的信息数据通过三个顶点差值得到。</p><h2 id="片元着色器"><a href="#片元着色器" class="headerlink" title="片元着色器"></a>片元着色器</h2><p>DirectX中也被称为<strong>像素着色器（Pixel Shader）</strong>。<br>片元着色器的输入是顶点着色器的输出差值得到的结果，片元着色器的输出是一个或多个颜色值。</p><p><img src="/UnityShadersBook01/img_09.png" alt></p><h2 id="逐片元操作"><a href="#逐片元操作" class="headerlink" title="逐片元操作"></a>逐片元操作</h2><p>OpenGL里称为<strong>逐片元操作</strong>，DirectX中称为<strong>输出合并阶段</strong>。这个阶段有几个主要任务：</p><ul><li>决定每个片元可见性，涉及：深度测试、模板测试等。</li><li>通过测试后的片元与颜色缓冲区的颜色进行合并/混合。</li></ul><p><img src="/UnityShadersBook01/img_10.png" alt></p><p>深度测试、模板测试的简化流程图：</p><p><img src="/UnityShadersBook01/img_11.png" alt></p><ul><li><p><strong>模板测试</strong><br>高度可配置。<br>模板缓冲，和颜色缓冲、深度缓冲几乎是一类东西。即当前像素读取的参考值和模板缓冲中读取的参考值进行比较，满足条件则通过模板测试，条件规则由开发者指定。<br>不管模板测试有没有通过，我们都可以根据模板测试和深度测试的结果来修改模板缓冲区，操作修改可由开发者指定。</p></li><li><p><strong>深度测试</strong><br>高度可配置。<br>与模板测试类似，将当前片元的深度值和深度缓冲区的深度值进行比较，比较函数可由开发者设置，通常这个比较函数是小于等于的关系，也就是显示距离相机更近的物体。<br>如果深度测试没有通过，它没有权利更改深度缓冲区中的值；如果通过了，开发者可以指定是否用这个片元的深度值盖掉缓冲区中的深度值——通过开启/关闭深度写入来控制。</p></li></ul><p><img src="/UnityShadersBook01/img_12.png" alt></p><ul><li><strong>混合</strong><br>高度可配置。<br>开发者可选择开启/关闭混合模式，来控制是直接覆盖，还是将源颜色（当前片元的颜色）和目标颜色（颜色缓冲区的颜色）进行混合后写入颜色缓冲区。</li></ul><p>有些GPU为了提高性能，将深度测试放到片元着色器之前处理，这种技术称为<strong>Early-Z技术</strong>。</p><p>经过上述流程，颜色缓冲区中的颜色值被显示到屏幕上，但是为了防止正在进行光栅化的图元被显示在屏幕上，GPU采取了 <strong>双重缓冲（Double Buffering）</strong> 的策略，所以对场景的渲染是发生在幕后的，即： <strong>后置缓冲（Back Buffer）</strong> 中。</p><h1 id="什么是Shader"><a href="#什么是Shader" class="headerlink" title="什么是Shader"></a>什么是Shader</h1><p>Shader本质就是运行在GPU流水线上的可高度编程的代码，主要有：<strong>顶点着色器（Vertex Shader）</strong>、<strong>片元着色器（Fragment Shader）</strong>，今后的开发学习中也主要是和这两个着色器打交道。</p>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/UnityShadersBook01/#disqus_thread</comments>
    </item>
    
    <item>
      <title>一文入门游戏中的引导设计</title>
      <link>http://wjnovember.github.io/guideSummary/</link>
      <guid>http://wjnovember.github.io/guideSummary/</guid>
      <pubDate>Mon, 01 Nov 2021 13:34:59 GMT</pubDate>
      <description>
      
        
        
          &lt;blockquote&gt;
&lt;p&gt;一年多以前写了两篇从零开始设计游戏引导框架，第二篇写完后，发现写不下去了。游戏引擎形形色色，语言多种多样，如果继续写下去发现并不具有通用性，所以中断了。现在，引导的代码经过多个项目的打磨，有了一定的改进，想着简单分享一下引导的实现思路吧！&lt;br&gt;本
        
      
      </description>
      
      <content:encoded><![CDATA[<blockquote><p>一年多以前写了两篇从零开始设计游戏引导框架，第二篇写完后，发现写不下去了。游戏引擎形形色色，语言多种多样，如果继续写下去发现并不具有通用性，所以中断了。现在，引导的代码经过多个项目的打磨，有了一定的改进，想着简单分享一下引导的实现思路吧！<br>本文以Lua代码作为样例，重在思路分享，其他语言亦可实现。</p></blockquote><h1 id="1-引导认知"><a href="#1-引导认知" class="headerlink" title="1. 引导认知"></a>1. 引导认知</h1><h2 id="1-1-引导分类"><a href="#1-1-引导分类" class="headerlink" title="1.1 引导分类"></a>1.1 引导分类</h2><p>引导的分类可分为<strong>新手引导</strong>、<strong>触发式引导</strong>、<strong>任务前往引导</strong>。</p><h3 id="1）新手引导"><a href="#1）新手引导" class="headerlink" title="1）新手引导"></a>1）新手引导</h3><p>新注册的账号进入游戏后，出现立绘对话、交代游戏背景、告知玩家基础操作的引导，称为<strong>新手引导</strong>。一般新手引导持续至玩家可以自由操作时结束。</p><h3 id="2）触发式引导"><a href="#2）触发式引导" class="headerlink" title="2）触发式引导"></a>2）触发式引导</h3><p>玩家自由操作过程中，因达到某种条件而触发的引导，称为<strong>触发式引导</strong>。大多数情况下，触发式引导会随着新系统的开启。</p><h3 id="3）任务前往引导"><a href="#3）任务前往引导" class="headerlink" title="3）任务前往引导"></a>3）任务前往引导</h3><p>点击任务前往按钮后，出现手指引导玩家按照任务实现流程去操作的过程，称为<strong>任务前往引导</strong>。</p><h2 id="1-2-组别和步骤"><a href="#1-2-组别和步骤" class="headerlink" title="1.2 组别和步骤"></a>1.2 组别和步骤</h2><h3 id="1）组别"><a href="#1）组别" class="headerlink" title="1）组别"></a>1）组别</h3><p>为方便后续内容达成统一认知，在此将一个个不同功能作用的引导以组别进行区分。比如：一进入游戏即出现的新手引导、英雄升星引导、文字版的抽卡引导等，每一个引导特定功能的引导都是一个组别。</p><h3 id="2）步骤"><a href="#2）步骤" class="headerlink" title="2）步骤"></a>2）步骤</h3><p>在一个引导组别里，每一步引导的操作都成为<strong>步骤</strong>，比如：引导点击一个按钮、出现一个立绘对话、出现一个高亮框等，都是引导的步骤。</p><h2 id="1-3-触发条件与触发点"><a href="#1-3-触发条件与触发点" class="headerlink" title="1.3 触发条件与触发点"></a>1.3 触发条件与触发点</h2><p><strong>触发条件</strong>和<strong>触发点</strong>，是引导<strong>组别</strong>的概念。<br>举个例子，文字版里有一个抽卡引导，条件是玩家通关1-4。那么对于抽卡这个组别的引导，通关1-4就是它的触发条件，而触发点就是每一个关卡通关那一刻。通俗来讲就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">触发点：</span><br><span class="line">什么时候判断</span><br><span class="line"></span><br><span class="line">触发条件：</span><br><span class="line">判断是否满足条件</span><br></pre></td></tr></table></figure><h2 id="1-4-操作"><a href="#1-4-操作" class="headerlink" title="1.4 操作"></a>1.4 操作</h2><p><strong>操作</strong>是引导<strong>步骤</strong>的概念。<br>举个例子，文字版抽卡引导的步骤流程是：</p><ul><li>出现立绘对话，告知玩家“招仙台”系统已开启</li><li>点击主界面“道场”页签</li><li>点击“招仙台”按钮</li><li>提示免费单抽</li><li>点击“单抽”按钮</li></ul><p>上面的每一个步骤都是<strong>操作</strong>。</p><p>操作根据表现形式可分为如下几类：</p><ul><li>点击</li><li>拖动</li><li>立绘对话</li><li>提示文本</li><li>效果（高亮框等）</li></ul><h2 id="1-5-保存点"><a href="#1-5-保存点" class="headerlink" title="1.5 保存点"></a>1.5 保存点</h2><p><strong>保存点</strong>的作用：为保证引导在玩家中途退出重进时依然能从中断点恢复。保存点需要上传记录到服务端。</p><p>结合以上几点，我们建立起对引导的认知：<br>在某个 <strong><em>触发点</em></strong> ，判断某个 <strong><em>组别</em></strong> 的引导满足 <strong><em>触发条件</em></strong> ，于是一个 <strong><em>步骤</em></strong> 一个步骤地引导玩家去完成最基础的系统流程的 <strong><em>操作</em></strong> ，并且支持退出游戏重进时能从中途的 <strong><em>保存点</em></strong> 恢复并继续引导。</p><h1 id="2-引导的配表"><a href="#2-引导的配表" class="headerlink" title="2. 引导的配表"></a>2. 引导的配表</h1><p>引导的配表可分为：<strong>guide_group</strong>表、<strong>guide_step</strong>表、<strong>guide_text</strong>表。</p><h2 id="2-1-guide-group配表"><a href="#2-1-guide-group配表" class="headerlink" title="2.1 guide_group配表"></a>2.1 guide_group配表</h2><p>guide_group表，主要控制某个组别的引导要不要触发，具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">起始步骤</th><th align="left">触发条件</th><th align="center">优先级</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left">_stepId</td><td align="center">_triggerCond</td><td align="left">_priority</td><td align="center"></td></tr><tr><td align="center">I</td><td align="left"></td><td align="center">I</td><td align="left">[S</td><td align="center">I</td></tr><tr><td align="center">1</td><td align="left">初始的新手引导</td><td align="center"></td><td align="left">101</td><td align="center">0</td></tr><tr><td align="center">2</td><td align="left">抽卡引导</td><td align="center">201</td><td align="left">{“scene”:”MainScene”,”form”:””,”missionId”:100004}</td><td align="center">1</td></tr></tbody></table><h2 id="2-2-guide-step配表"><a href="#2-2-guide-step配表" class="headerlink" title="2.2 guide_step配表"></a>2.2 guide_step配表</h2><p>guide_step表，主要控制在某个组别的引导触发时，每一步操作具体是什么。相同组别引导的步骤ID连续，且ID不为100的倍数。具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">操作</th><th align="center">数值</th><th align="left">其他参数</th><th align="center">保存步骤</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_action</td><td align="center">_val</td><td align="left">_param</td><td align="center">_saveId</td></tr><tr><td align="center">H</td><td align="left"></td><td align="center">I</td><td align="center">I</td><td align="left">S</td><td align="center">I</td></tr><tr><td align="center">201</td><td align="left">立绘对话</td><td align="center">30001</td><td align="center">1002</td><td align="left"></td><td align="center">202</td></tr><tr><td align="center">202</td><td align="left">点击“道场”页签</td><td align="center">10001</td><td align="center">1</td><td align="left"></td><td align="center">0</td></tr><tr><td align="center">203</td><td align="left">点击“招仙台”按钮</td><td align="center">10002</td><td align="center">1</td><td align="left"></td><td align="center">0</td></tr><tr><td align="center">204</td><td align="left">提示免费单抽</td><td align="center">40001</td><td align="center">1002</td><td align="left">{“form_show”:105,”form”:105,”node”:”_btnLotteryOne”,”dir”:”top”}</td><td align="center">0</td></tr><tr><td align="center">205</td><td align="left">点击“单抽”按钮后关闭提示</td><td align="center">10003</td><td align="center">0</td><td align="left">{“form”:105,”node”:”_btnLotteryOne”}</td><td align="center">100</td></tr></tbody></table><p><strong>_action说明</strong>：</p><blockquote><p><strong>10000+</strong>：点击<br><strong>10001</strong> 点击主界面的页签 ，val 表示第几个页签<br><strong>10002</strong> 点击某个系统入口，val 表示哪个系统<br><strong>10003</strong> 按照代码变量名找到按钮进行点击</p><p><strong>20000+</strong>：拖拽<br>…</p><p><strong>30000+</strong>：立绘对话<br><strong>30001</strong> 普通立绘对话</p><p><strong>40000+</strong>：文本提示<br><strong>40001</strong> 普通文本提示</p></blockquote><p><strong>_val说明</strong>：</p><blockquote><p>不同_action，对应_val表意不同</p><p><strong>10001</strong> 主界面第几个页签<br><strong>10002</strong> 表示系统ID枚举</p><p><strong>30000+</strong> 表示立绘对话的文本ID，从guide_text表里读取<br><strong>40000+</strong> 表示文本提示的文本ID，从guide_text表里读取</p></blockquote><p><strong>_param说明</strong>：</p><blockquote><p>一些无法通过_val单个值表意的参数，用_param表意。使用Json字符串配置，扩展性较好，自由度大，可根据需求任意定义。</p><p><strong>form_show</strong> 某个界面打开的时候执行操作，数值为：界面ID枚举<br><strong>form</strong> 执行当前操作需要在哪个界面，数值为：界面ID枚举<br><strong>node</strong> 关联某个node，通常与form配合使用，旨在找到目标节点，与不同_action关联，表意不同，与点击            关联，表示点击哪个按钮；与提示文本关联，表示文本框依附于哪个UI控件<br><strong>dir</strong> 表示文本框依附在UI控件的哪个方位，数值可以是：”top”、”bottom”、”left”、”right”<br>…</p></blockquote><p><strong>_saveId说明</strong>：</p><blockquote><p>在当前操作结束时，将_saveId保存到服务器，下次断线重连时，从保存点继续引导</p><p><strong>0</strong> 不设置保存点，不做任何操作<br><strong>100</strong> 将当前引导保存点去掉，标记当前组别引导已完成<br><strong>其他</strong> 保存该步骤ID到服务器</p></blockquote><h2 id="2-3-guide-text表"><a href="#2-3-guide-text表" class="headerlink" title="2.3 guide_text表"></a>2.3 guide_text表</h2><p>guide_text表，主要配置立绘对话、文本提示等操作的一些文本内容。具体配置如下：</p><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="left">文本内容</th><th align="left">参数</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="left">_textSid</td><td align="left">_param</td></tr><tr><td align="center">I</td><td align="left"></td><td align="left">D</td><td align="left">S</td></tr><tr><td align="center">1001</td><td align="left">立绘对话</td><td align="left">招仙台已开启，请道友移步入内，招募仙士。</td><td align="left">{“role_index”:1,”role_id”:1}</td></tr><tr><td align="center">1002</td><td align="left">文本提示</td><td align="left">每隔一段时间都会获得一次免费召唤机会</td><td align="left"></td></tr></tbody></table><p><strong>_param说明</strong>：</p><blockquote><p><strong>role_index</strong> 立绘的位置，1：左，2：中，3：右<br><strong>role_id</strong> 立绘角色ID</p></blockquote><h2 id="2-4-程序与策划的配合"><a href="#2-4-程序与策划的配合" class="headerlink" title="2.4 程序与策划的配合"></a>2.4 程序与策划的配合</h2><h3 id="1）添加新的引导时"><a href="#1）添加新的引导时" class="headerlink" title="1）添加新的引导时"></a>1）添加新的引导时</h3><p>策划出一份引导流程文档，程序根据负责添加引导的逻辑配表：guide_group、guide_step，策划配置负责配置引导的文案：guide_text。</p><h3 id="2）修改引导时"><a href="#2）修改引导时" class="headerlink" title="2）修改引导时"></a>2）修改引导时</h3><p>如果仅涉及引导文案修改时，策划只需要维护guide_text表即可，如果仅涉及文案增删，策划也可在了解引导配表逻辑的基础上，维护guide_step表；<br>如果涉及逻辑改动，需要程序配合策划进行改表，程序负责guide_group、guide_step，策划负责guide_text。</p><p>可有效规避策划和程序改一份表，影响引导逻辑。</p><h1 id="3-引导代码的实现"><a href="#3-引导代码的实现" class="headerlink" title="3. 引导代码的实现"></a>3. 引导代码的实现</h1><p>根据：</p><blockquote><p>在某个 <strong><em>触发点</em></strong> ，判断某个 <strong><em>组别</em></strong> 的引导满足 <strong><em>触发条件</em></strong> ，于是一个 <strong><em>步骤</em></strong> 一个步骤地引导玩家去完成最基础的系统流程的 <strong><em>操作</em></strong> ，并且支持退出游戏重进时能从中途的 <strong><em>保存点</em></strong> 恢复并继续引导。</p></blockquote><p>代码需要实现的逻辑包括：</p><ul><li>引导的触发</li><li>引导的操作</li><li>引导的保存点（结合在操作中）</li><li>引导步骤的连接（如何从当前步骤跳到下一步）</li></ul><p>我们把引导的框架逻辑写在<code>GuideMgr.lua</code>里。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.tryStart</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.start</span><span class="params">(groupConfig)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.finish</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideStep</span><span class="params">(stepId)</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-1-引导的触发"><a href="#3-1-引导的触发" class="headerlink" title="3.1 引导的触发"></a>3.1 引导的触发</h2><p>引导的触发，可分为：触发总入口、触发条件判定和正式触发。</p><h3 id="1）触发总入口"><a href="#1）触发总入口" class="headerlink" title="1）触发总入口"></a>1）触发总入口</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 引导触发判定总入口</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.tryStart</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 引导禁用</span></span><br><span class="line">    <span class="keyword">if</span> M.isForbidGuide() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 正在引导，不触发判定</span></span><br><span class="line">    <span class="keyword">if</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 获取没有触发过的引导组别，判定是否满足触发条件</span></span><br><span class="line">    <span class="keyword">local</span> groupConfigs = M.getGroupConfigs()</span><br><span class="line">  <span class="keyword">for</span> i = <span class="number">1</span>, #groupConfigs <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">config</span> = groupConfigs[i]</span><br><span class="line">        <span class="comment">-- 如果满足触发条件</span></span><br><span class="line">    <span class="keyword">if</span> CondMgr.isConditionArrayMet(<span class="built_in">config</span>._triggerCond) <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- 触发引导</span></span><br><span class="line">            M.start(<span class="built_in">config</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取没有触发过的引导组别</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.getGroupConfigs</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> configs = M._groupConfigs</span><br><span class="line">    <span class="keyword">if</span> configs == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        configs = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(D._guideGroupConfig) <span class="keyword">do</span></span><br><span class="line">      <span class="comment">-- 取没有触发过的引导组别</span></span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> M.isFinished(k) <span class="keyword">then</span></span><br><span class="line">                configs[#configs + <span class="number">1</span>] = v</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(configs, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a._priority &lt; b._priority <span class="keyword">end</span>)</span><br><span class="line">    M._groupConfigs = configs</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> configs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）条件判定"><a href="#2）条件判定" class="headerlink" title="2）条件判定"></a>2）条件判定</h3><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">起始步骤</th><th align="left">触发条件</th><th align="center">优先级</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_stepId</td><td align="left">_triggerCond</td><td align="center">_priority</td></tr><tr><td align="center">I</td><td align="left"></td><td align="center">I</td><td align="left">[S</td><td align="center">I</td></tr><tr><td align="center">2</td><td align="left">抽卡引导</td><td align="center">201</td><td align="left">{“scene”:”MainScene”,”form”:””,”missionId”:100004}</td><td align="center">1</td></tr></tbody></table><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"CondMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[--</span></span><br><span class="line"><span class="comment">配表类型：[S</span></span><br><span class="line"><span class="comment">配表写法：&#123;"form": 101, "hero_level": 20&#125; | &#123;"form":101, "vip_level":3&#125;</span></span><br><span class="line"><span class="comment">在101界面，英雄等级达到20级或vip等级达到3级，触发引导</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">cond参数结构：</span></span><br><span class="line"><span class="comment">table数组</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    &#123;form = 101, hero_level = 20&#125;,</span></span><br><span class="line"><span class="comment">    &#123;form = 101, vip_level = 3&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">只要数组中其中一个条件满足即可</span></span><br><span class="line"><span class="comment">--]]</span><span class="comment">--</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isConditionArrayMet</span><span class="params">(conds)</span></span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #conds <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> M.isConditionMet(conds[i]) <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isConditionMet</span><span class="params">(cond)</span></span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(cond) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> M.CondCheck[k](v) <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.CondCheck = &#123;</span><br><span class="line">    [<span class="string">"form"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">        <span class="keyword">return</span> form <span class="keyword">and</span> form._id == val</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [<span class="string">"hero_level"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">local</span> lv = P._playerHero:getOwnedHeroMaxLevel()</span><br><span class="line">        <span class="keyword">return</span> lv &gt;= val</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [<span class="string">"vip_level"</span>] = <span class="function"><span class="keyword">function</span><span class="params">(val)</span></span></span><br><span class="line">        <span class="keyword">return</span> P:vipLevel() &gt;= val</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="3）触发引导"><a href="#3）触发引导" class="headerlink" title="3）触发引导"></a>3）触发引导</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.start</span><span class="params">(groupConfig)</span></span></span><br><span class="line">    <span class="comment">-- 如果有引导正在进行，结束所有引导，开始触发传入组别的引导</span></span><br><span class="line">    M.finish()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 保存当前正在触发的引导组别ID</span></span><br><span class="line">    <span class="keyword">local</span> groupId = groupConfig._id</span><br><span class="line">    M.saveGuideGroup(groupId)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> stepId = groupConfig._stepId</span><br><span class="line">    M.saveGuideStep(stepId)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 引导视图层准备工作</span></span><br><span class="line">    M.prepareLayer()</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 开始当前引导组的第一步操作</span></span><br><span class="line">    M._groupId = groupId</span><br><span class="line">    M._stepId = stepId</span><br><span class="line">    M.step(stepId)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建引导图层，后续的所有操作添加的元素都放在这里</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.prepareLayer</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    <span class="keyword">if</span> layer == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        layer = class(<span class="literal">nil</span>, V).new(lc.CocosClass.ui_widget)</span><br><span class="line">        layer:setContentSize(lc.ScrSize)</span><br><span class="line">        lc.addChildToCenter(Scene._current, layer, V.ZOrder.guide)</span><br><span class="line">        M._layer = layer</span><br><span class="line"></span><br><span class="line">        layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideGroup</span><span class="params">(groupId)</span></span></span><br><span class="line">    <span class="comment">-- TODO：保存到服务端</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.saveGuideStep</span><span class="params">(stepId)</span></span></span><br><span class="line">    <span class="comment">-- TODO：保存到服务端</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-2-引导的操作"><a href="#3-2-引导的操作" class="headerlink" title="3.2 引导的操作"></a>3.2 引导的操作</h2><p>引导的操作涉及：保存点逻辑、参数逻辑、具体操作（点击、对话等）。</p><h3 id="1）引导步骤"><a href="#1）引导步骤" class="headerlink" title="1）引导步骤"></a>1）引导步骤</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span></span><br><span class="line">    <span class="comment">-- 保证step在引导中执行（由M.start发起）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--[[--</span></span><br><span class="line"><span class="comment">    stepId不为空，表示开始当前步骤操作；</span></span><br><span class="line"><span class="comment">    stepId为空，表示在M._stepId基础上，进入下一步操作；</span></span><br><span class="line"><span class="comment">    --]]</span><span class="comment">--</span></span><br><span class="line">    <span class="keyword">if</span> stepId == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        stepId = M._stepId</span><br><span class="line"> </span><br><span class="line">        <span class="comment">-- 在当前步骤结束，准备进入下一步时，记录当前步骤的保存点</span></span><br><span class="line">        <span class="keyword">local</span> stepConfig = D._guideStepConfig[stepId]</span><br><span class="line">        <span class="keyword">local</span> saveId = stepConfig._saveId</span><br><span class="line">        <span class="keyword">if</span> saveId <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> saveId == <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">                M.setGroupFinished(M._groupId)</span><br><span class="line">                M.saveGuideStep()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elseif</span> saveId &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                M.saveGuideStep(saveId)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        stepId = stepId + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 传入的步骤ID不存在，结束引导</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[stepId]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span> == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        M.finish()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    M._stepId = stepId</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 清除所有引导元素</span></span><br><span class="line">    M.clearLayer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 根据步骤参数做相应处理</span></span><br><span class="line">    <span class="comment">-- （后面继续）</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.isGuiding</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> M._stepId <span class="keyword">and</span> D._guideStepConfig[M._stepId]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清理所有layer上的引导元素，包括手指、高亮、立绘对话等</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.clearLayer</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    <span class="keyword">if</span> layer == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    layer:setSwallowTouches(<span class="literal">true</span>)</span><br><span class="line">    layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">    M.removeFinger()</span><br><span class="line">    M.removeDilog()</span><br><span class="line">    M.removeTipText()</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）参数处理"><a href="#2）参数处理" class="headerlink" title="2）参数处理"></a>2）参数处理</h3><table><thead><tr><th align="center">ID</th><th align="left">说明</th><th align="center">操作</th><th align="center">数值</th><th align="left">其他参数</th><th align="center">保存步骤</th></tr></thead><tbody><tr><td align="center">_id</td><td align="left"></td><td align="center">_action</td><td align="center">_val</td><td align="left">_param</td><td align="center">_saveId</td></tr><tr><td align="center">H</td><td align="left"></td><td align="center">I</td><td align="center">I</td><td align="left">S</td><td align="center">I</td></tr><tr><td align="center">204</td><td align="left"></td><td align="center">40001</td><td align="center">1002</td><td align="left">{“form_show”:105,”form”:105,”node”:”_btnLotteryOne”,”dir”:”top”}</td><td align="center">0</td></tr><tr><td align="center">205</td><td align="left"></td><td align="center">10003</td><td align="center">0</td><td align="left">{“form”:105,”node”:”_btnLotteryOne”}</td><td align="center">100</td></tr></tbody></table><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.step</span><span class="params">(stepId)</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- （接上面的代码）</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[stepId]</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 根据步骤参数做相应处理</span></span><br><span class="line">    <span class="keyword">local</span> param = M.getStepParam(<span class="built_in">config</span>)</span><br><span class="line">    <span class="keyword">if</span> param <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 允许玩家自由点击</span></span><br><span class="line">        <span class="keyword">if</span> param.free_op <span class="keyword">then</span></span><br><span class="line">            M._layer:setSwallowTouches(<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        M._waitParam = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> param.delay <span class="keyword">then</span></span><br><span class="line">            M._waitParam = V.scheduleCall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> M.doAction() <span class="keyword">end</span>, param.delay)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> param.event <span class="keyword">then</span></span><br><span class="line">            _, M._waitParam = lc.event.once(param.event, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> M.doAction() <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> param.free_op <span class="keyword">then</span></span><br><span class="line">                M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">                    <span class="comment">-- 提示当前无法点击</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">elseif</span> param.form_show <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">            <span class="keyword">if</span> form == <span class="literal">nil</span> <span class="keyword">or</span> form._id ~= param.form_show <span class="keyword">or</span> <span class="keyword">not</span> form._isShown <span class="keyword">then</span></span><br><span class="line">                _, M._waitParam = lc.event.on(<span class="string">"form.show"</span>, <span class="function"><span class="keyword">function</span><span class="params">(form)</span></span></span><br><span class="line">                    <span class="keyword">if</span> form._id == param.form_show <span class="keyword">then</span> M.doAction() <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">elseif</span> param.form_close <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> form = Form.getTop()</span><br><span class="line">            <span class="keyword">if</span> form <span class="keyword">and</span> form._id == param.form_close <span class="keyword">then</span></span><br><span class="line">                _, M._waitParam = lc.event.on(<span class="string">"form.close"</span>, <span class="function"><span class="keyword">function</span><span class="params">(formId)</span></span></span><br><span class="line">                    <span class="keyword">if</span> param.form_close == formId <span class="keyword">then</span> M.doAction() <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> M._waitParam == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            M.doAction()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.getStepParam</span><span class="params">(stepConfig)</span></span></span><br><span class="line">    stepConfig = stepConfig <span class="keyword">or</span> D._guideStepConfig[M._stepId]</span><br><span class="line">    <span class="keyword">return</span> json.decode(stepConfig._param <span class="keyword">or</span> <span class="string">""</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="3）执行操作"><a href="#3）执行操作" class="headerlink" title="3）执行操作"></a>3）执行操作</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.doAction</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> M.isGuiding() <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = D._guideStepConfig[M._stepId]</span><br><span class="line">    M._waitParam = <span class="literal">nil</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> layer = M._layer</span><br><span class="line">    layer:setSwallowTouches(<span class="literal">true</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">local</span> action = <span class="built_in">config</span>._action</span><br><span class="line">    <span class="keyword">if</span> action == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 执行下一步操作</span></span><br><span class="line">        M.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> func = M.ActionFuncs[action]</span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> func(<span class="built_in">config</span>) <span class="keyword">then</span></span><br><span class="line">                M.finish()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">-- 交给外部处理</span></span><br><span class="line">            V.scheduleCall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span> lc.event.emit(<span class="string">"guide.step"</span>, <span class="built_in">config</span>) <span class="keyword">end</span>, lc.FrameInterval)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.Action = &#123;</span><br><span class="line">    click_main_tab = <span class="number">10001</span>,</span><br><span class="line">    click_sys_entrance = <span class="number">10002</span>,</span><br><span class="line">    click_by_name = <span class="number">10003</span>,</span><br><span class="line">    ...</span><br><span class="line">    dialog = <span class="number">30001</span>,</span><br><span class="line">    ...</span><br><span class="line">    tip_text = <span class="number">40001</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">M.ActionFuncs = &#123;</span><br><span class="line">    [M.Action.click_main_tab] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> index = <span class="built_in">config</span>._val</span><br><span class="line">        <span class="keyword">local</span> tab = <span class="built_in">table</span>.walk(Scene._curent, <span class="string">"_tabs"</span>, index)</span><br><span class="line">        <span class="keyword">if</span> tab <span class="keyword">and</span> tab:isVisible() <span class="keyword">then</span></span><br><span class="line">            M.addTouchFinger(tab)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    [M.Action.click_sys_entrance] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span> ... <span class="keyword">end</span>,</span><br><span class="line">    [M.Action.click_by_name] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span> ... <span class="keyword">end</span>,</span><br><span class="line">  </span><br><span class="line">    [M.Action.role_dialog] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> textConfig = D._guideTextConfig[<span class="built_in">config</span>._val]</span><br><span class="line">        M.addDialog(textConfig)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  </span><br><span class="line">    [M.Action.tip_text] = <span class="function"><span class="keyword">function</span><span class="params">(config)</span></span></span><br><span class="line">        <span class="keyword">local</span> textConfig = D._guideTextConfig[<span class="built_in">config</span>._val]</span><br><span class="line">        M.addTipText(textConfid._textSid, <span class="built_in">config</span>._param)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><p><strong>回顾</strong>：</p><blockquote><p><strong>10000+</strong>：点击<br><strong>10001</strong> 点击主界面的页签 ，val 表示第几个页签<br><strong>10002</strong> 点击某个系统入口，val 表示哪个系统<br><strong>10003</strong> 按照代码变量名找到按钮进行点击</p><p><strong>20000+</strong>：拖拽<br>…</p><p><strong>30000+</strong>：立绘对话<br><strong>30001</strong> 普通立绘对话</p><p><strong>40000+</strong>：文本提示<br><strong>40001</strong> 普通文本提示</p></blockquote><h2 id="3-3-引导的结束"><a href="#3-3-引导的结束" class="headerlink" title="3.3 引导的结束"></a>3.3 引导的结束</h2><p>引导的结束包括：引导数据处理、视图层移除、尝试继续触发下一组引导。所有逻辑囊括在GuideMgr.finish()方法里。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.finish</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 数据层</span></span><br><span class="line">    M.saveGuideGroup()</span><br><span class="line">    M.saveGuideStep()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> M._groupId <span class="keyword">then</span></span><br><span class="line">        M.setGroupFinished(M._groupId)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    M._groupId = <span class="number">0</span></span><br><span class="line">    M._stepId = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 视图层</span></span><br><span class="line">    M.clearLayer()</span><br><span class="line">    M.removeLayer()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> param = M._waitParam</span><br><span class="line">    <span class="keyword">if</span> param <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 移除事件监听</span></span><br><span class="line">        <span class="keyword">if</span> param._event <span class="keyword">then</span></span><br><span class="line">            lc.event.<span class="built_in">remove</span>(param)</span><br><span class="line">      </span><br><span class="line">        <span class="comment">-- 移除延迟操作的定时器</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">            param:unschedule()</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">        M._waitParam = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 延迟一帧判断是否有新的引导可以触发</span></span><br><span class="line">    V.scheduleCall(M.tryStart, lc.FrameInterval)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h2 id="3-4-步骤间的连接"><a href="#3-4-步骤间的连接" class="headerlink" title="3.4 步骤间的连接"></a>3.4 步骤间的连接</h2><p>步骤间的连接，也就是当前步骤如何跳到下一步骤，需要根据操作情景做特殊处理，这里以点击、立绘对话为例，做一下讲解。</p><h3 id="1）点击"><a href="#1）点击" class="headerlink" title="1）点击"></a>1）点击</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addTouchFinger</span><span class="params">(node, ...)</span></span></span><br><span class="line">    ...</span><br><span class="line">    node._lastListener = node._listener</span><br><span class="line">    node._listener = M.fingerTouchListener</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.fingerTouchListener</span><span class="params">(...)</span></span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> node._lastListener <span class="keyword">then</span></span><br><span class="line">        node._lastListener(...)</span><br><span class="line">        node._listener = node._lastListener</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- 按钮点击后，执行下一步</span></span><br><span class="line">    M.step()</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure><h3 id="2）立绘对话、文本"><a href="#2）立绘对话、文本" class="headerlink" title="2）立绘对话、文本"></a>2）立绘对话、文本</h3><p>点击屏幕任意位置，执行下一步引导操作。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">"GuideMgr"</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addDialog</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">-- 设置layer点击事件</span></span><br><span class="line">       M.step()</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.addTipText</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    M._layer:setTouchListener(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">-- 设置layer点击事件</span></span><br><span class="line">      M.step()</span><br><span class="line">      ...</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      <comments>http://wjnovember.github.io/guideSummary/#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
